---
phase: 13-alert-import-management
plan: 03
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx
  - src/components/alerts/threshold-card.tsx
  - src/components/alerts/threshold-card-skeleton.tsx
  - src/components/alerts/threshold-filters.tsx
  - src/components/alerts/threshold-create-modal.tsx
autonomous: true
requirements: [ALERT-01, ALERT-02, ALERT-03]

must_haves:
  truths:
    - "User sees a flat list of alert thresholds as cards with infinite scroll"
    - "Each card shows metric icon, platform badge, threshold value, enabled toggle, and last triggered time"
    - "User can filter thresholds by account group, platform, metric type, and text search"
    - "Admin can create a new threshold via modal with validation"
    - "Admin can delete a threshold with type-to-confirm dialog"
    - "Cards animate on creation (fade in + slide) and deletion (fade out + collapse)"
  artifacts:
    - path: "src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx"
      provides: "Alerts page with threshold list, filters, create button, empty state"
      contains: "useAlertThresholds"
    - path: "src/components/alerts/threshold-card.tsx"
      provides: "Individual threshold card with toggle, delete, animations"
      exports: ["ThresholdCard"]
    - path: "src/components/alerts/threshold-filters.tsx"
      provides: "Filter bar with dropdowns and text search"
      exports: ["ThresholdFilters"]
    - path: "src/components/alerts/threshold-create-modal.tsx"
      provides: "Create threshold modal with radio buttons, dropdown, validation"
      exports: ["ThresholdCreateModal"]
  key_links:
    - from: "src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx"
      to: "src/hooks/use-alerts.ts"
      via: "useAlertThresholds infinite query"
      pattern: "useAlertThresholds"
    - from: "src/components/alerts/threshold-card.tsx"
      to: "src/hooks/use-alerts.ts"
      via: "useToggleThreshold and useDeleteThreshold mutations"
      pattern: "useToggleThreshold|useDeleteThreshold"
---

<objective>
Build the alerts page core UI: threshold card list with infinite scroll, filter bar with search, create threshold modal, and single-item delete with type-to-confirm.

Purpose: Deliver the primary alert management experience — viewing, filtering, creating, and deleting thresholds.

Output: Alerts page at `/guilds/[guildId]/manage/alerts` with full CRUD (minus bulk ops and email config, which come in Plan 04).
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-alert-import-management/13-RESEARCH.md
@.planning/phases/13-alert-import-management/13-01-SUMMARY.md
@.planning/phases/13-alert-import-management/13-02-SUMMARY.md

Key reference files:
@src/hooks/use-alerts.ts (from Plan 02)
@src/types/alert.ts (from Plan 01)
@src/components/ui/type-to-confirm-modal.tsx (existing)
@src/components/empty-state.tsx (existing)
@src/components/ui/skeleton.tsx (existing)
@src/components/filters/search-input.tsx (existing search pattern)
@src/components/filters/filter-bar.tsx (existing filter bar)
@src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx (infinite scroll reference)
@src/components/tracking/account-card.tsx (card pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create threshold card, skeleton, and filter components</name>
  <files>
    src/components/alerts/threshold-card.tsx
    src/components/alerts/threshold-card-skeleton.tsx
    src/components/alerts/threshold-filters.tsx
  </files>
  <action>
  **Create `src/components/alerts/threshold-card.tsx`:**

  A `'use client'` component that renders a single alert threshold as a card.

  Props: `threshold: AlertThreshold`, `guildId: string`, `onDelete: (threshold: AlertThreshold) => void`, `isSelected?: boolean`, `onSelect?: (id: string) => void`

  Card layout (all fields per locked decision):
  - **Left side:** Checkbox (for bulk selection, only shown if `onSelect` provided), metric type icon (use lucide-react: `Eye` for views, `Heart` for likes, `MessageCircle` for comments, `Share2` for shares, `Users` for followers)
  - **Center:** Metric type label + threshold value (e.g., "Views > 10,000"), account group name as subtitle, platform badge (colored pill: "Instagram" in pink, "TikTok" in dark, "YouTube" in red, "X" in gray, "All" in purple — or null = "All platforms")
  - **Right side:** Enabled toggle switch + delete button (trash icon)
  - **Bottom:** Last triggered timestamp — relative time ("2 hours ago") using `formatDistanceToNow` from date-fns, absolute time on hover via `title` attribute. Show "Never triggered" if null.

  Toggle behavior (locked decision: non-optimistic):
  - Show loading spinner on the toggle while mutation is in progress (`isToggling` state)
  - Call `useToggleThreshold(guildId)` mutation
  - Toggle does NOT flip until API confirms
  - On error: stays in original state, error toast shown by hook

  Delete button:
  - Calls `onDelete(threshold)` to open the page-level TypeToConfirmModal

  Animations (locked decision):
  - New card: use `isNew` prop with `animate-fadeSlideIn` class (define with Tailwind `@keyframes fadeSlideIn { from { opacity: 0; transform: translateY(-8px) } to { opacity: 1; transform: translateY(0) } }` in globals.css or use inline transition)
  - Deleting card: use `isRemoving` state — when true, apply `opacity-0 max-h-0 mb-0 transition-all duration-300 ease-in-out overflow-hidden` (same pattern as sessions page)

  Card container: `bg-surface border border-border rounded-lg p-4` with hover state `hover:border-border/80`. When selected: `border-accent-purple bg-accent-purple/5`.

  Accessibility: toggle has `aria-label="Toggle threshold"`, `role="switch"`, `aria-checked`. Delete button has `aria-label="Delete threshold"`.

  **Create `src/components/alerts/threshold-card-skeleton.tsx`:**

  Skeleton loading card matching the threshold card shape:
  - Props: `count?: number` (default 3)
  - Render `count` skeleton cards with animated shimmer
  - Each skeleton: same padding/border as real card, with `Skeleton` component from `@/components/ui/skeleton` for metric icon circle, text lines, toggle rect, and platform badge

  **Create `src/components/alerts/threshold-filters.tsx`:**

  A `'use client'` component for the filter bar above the threshold list.

  Props: `filters: ThresholdFilters`, `onFiltersChange: (filters: ThresholdFilters) => void`, `groups: { id: string, label: string }[]`

  Components:
  1. **Text search input** — Uses `useDebounce` hook with 300ms delay. Input with search icon, placeholder "Search groups or values...". Fires `onFiltersChange` with `search` param on debounced value change.
  2. **Account group dropdown** — Headless UI Listbox with "All groups" default option + list of groups. On change: updates `groupId` filter.
  3. **Platform dropdown** — Headless UI Listbox with "All platforms" + 5 platform options (Instagram, TikTok, YouTube, X, Facebook).
  4. **Metric type dropdown** — Headless UI Listbox with "All metrics" + 5 metric options (Views, Likes, Comments, Shares, Followers).

  Layout: Use `FilterBar` component from `@/components/filters` as container. Responsive: dropdowns wrap on mobile. Use the existing `SearchInput` component if it fits, otherwise build inline.

  Style consistent with existing filter patterns (sticky positioning, backdrop blur, consistent spacing).
  </action>
  <verify>
  `npx tsc --noEmit` passes.
  Files exist: `threshold-card.tsx`, `threshold-card-skeleton.tsx`, `threshold-filters.tsx`.
  Grep for `useToggleThreshold` in threshold-card.tsx confirms non-optimistic toggle.
  Grep for `formatDistanceToNow` confirms relative time display.
  Grep for `useDebounce` in threshold-filters.tsx confirms debounced search.
  </verify>
  <done>
  Threshold card shows all required fields (metric icon, platform badge, value, toggle, last triggered). Toggle waits for API. Skeleton matches card shape. Filters support 4 criteria with debounced search.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create threshold create modal with validation</name>
  <files>
    src/components/alerts/threshold-create-modal.tsx
  </files>
  <action>
  **Create `src/components/alerts/threshold-create-modal.tsx`:**

  A `'use client'` modal dialog for creating a new alert threshold.

  Props: `open: boolean`, `onClose: () => void`, `guildId: string`, `groups: { id: string, label: string }[]`, `existingThresholds: AlertThreshold[]`

  Use Headless UI `Dialog` component (same pattern as `add-account-modal.tsx`).

  Form fields (per locked decisions):
  1. **Account group selector** — Headless UI Listbox. Only shows groups where user has admin permissions (pass filtered groups as prop). Required field.
  2. **Metric type** — Radio button group with icons. 5 options: Views (Eye icon), Likes (Heart), Comments (MessageCircle), Shares (Share2), Followers (Users). Use radio-card styling: `border-accent-purple bg-accent-purple/10` when selected (same pattern as export format radio cards). Required field.
  3. **Platform** — Headless UI Listbox defaulting to "All platforms" (null value). Options: All platforms, Instagram, TikTok, YouTube, X, Facebook.
  4. **Threshold value** — Number input with `min="1"`. Show context hint below if available: "Current average: X" (optional, can be placeholder text if no data available). Required field.

  Validation:
  - All required fields must be filled
  - Threshold value must be positive integer
  - **Duplicate detection** (locked decision): Check `existingThresholds` for same `metricType` + `platform` + `accountGroupId`. If duplicate found, show warning below the form: "A threshold for {metric} on {platform} already exists for this group" with yellow background. Do NOT block submission — just warn.
  - Inline field errors: highlight invalid fields with red border and error message below

  Submission:
  - Call `useCreateThreshold(guildId)` mutation with form data
  - Show loading state on submit button
  - On success: close modal, success toast (handled by hook), form resets
  - On error: show server error via toast (handled by hook), keep modal open

  Modal styling: consistent with existing modals (max-w-md, bg-surface, rounded-lg, p-6). Purple submit button (`bg-accent-purple`). Cancel button with `text-gray-400`.

  Accessibility: All form controls have labels, radio buttons use `role="radiogroup"`, focus trapped inside modal.
  </action>
  <verify>
  `npx tsc --noEmit` passes.
  File exists: `threshold-create-modal.tsx`.
  Grep for `useCreateThreshold` confirms mutation usage.
  Grep for `duplicate` or `already exists` confirms duplicate detection.
  Grep for `Dialog` confirms Headless UI Dialog usage.
  </verify>
  <done>
  Create modal has: account group selector, metric type radio buttons with icons, platform dropdown defaulting to "All", threshold value number input, duplicate warning, inline validation, purple submit button.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build alerts page with infinite scroll, delete flow, and empty state</name>
  <files>
    src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx
  </files>
  <action>
  **Create `src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx`:**

  A `'use client'` page component that assembles the full alerts view.

  Page structure:
  1. **Header section:** "Alert Thresholds" title + "Create threshold" button (opens create modal). Show Discord notification channel as read-only info text below the title (from the first threshold's `accountGroup.discordChannelId` or fetched separately).

  2. **ThresholdFilters** component — Pass filters state and group list (extracted from threshold data: unique groups across all loaded pages).

  3. **Threshold card grid** — Map over `data.pages.flatMap(p => p.thresholds)` from `useAlertThresholds`. Render each as `<ThresholdCard>`. Use CSS grid: `grid-cols-1 lg:grid-cols-2 gap-4`.

  4. **Infinite scroll sentinel** — Use `useInView` from `react-intersection-observer` with `{ threshold: 0, rootMargin: '100px' }`. Call `fetchNextPage()` when in view and `hasNextPage && !isFetchingNextPage`.

  5. **Loading state:** When `isLoading` and no data yet, show `<ThresholdCardSkeleton count={6} />`.

  6. **Empty state** (locked decision): When data loaded but 0 thresholds, show `EmptyState` component with friendly illustration and prominent "Create threshold" CTA button. Use existing `EmptyState` from `@/components/empty-state`.

  7. **Delete flow:**
     - Track `deletingThreshold` state (the threshold being deleted)
     - On card delete click: set `deletingThreshold`
     - Render `TypeToConfirmModal` from `@/components/ui/type-to-confirm-modal` with `confirmText="delete"`, `variant="danger"`
     - On confirm: trigger `useDeleteThreshold` mutation, wait for animation (set `removingId`, wait 300ms), then invalidate cache
     - Cards with `id === removingId` get the fade-out + collapse CSS transition

  8. **Create flow:**
     - Track `showCreateModal` state
     - Render `ThresholdCreateModal` with `open={showCreateModal}`
     - Pass `existingThresholds` from flattened pages for duplicate detection
     - On modal close: reset state

  9. **Loaded count:** Show "Showing X of Y thresholds" below the filter bar (same pattern as existing pages).

  State management:
  - `filters` state: `ThresholdFilters` object managed at page level
  - `showCreateModal`: boolean
  - `deletingThreshold`: `AlertThreshold | null`
  - `removingId`: `string | null` (for delete animation)
  - `newThresholdId`: `string | null` (for creation animation — set on mutation success, cleared after animation)

  Filters should use `usePersistentState` from `@/hooks/use-persistent-state` with key `${guildId}-alerts-filters` for session persistence.
  </action>
  <verify>
  `npx tsc --noEmit` passes.
  File exists: `manage/alerts/page.tsx`.
  Grep for `useAlertThresholds` confirms data fetching.
  Grep for `useInView` confirms infinite scroll sentinel.
  Grep for `TypeToConfirmModal` confirms delete flow.
  Grep for `ThresholdCreateModal` confirms create flow.
  Grep for `EmptyState` confirms empty state.
  </verify>
  <done>
  Alerts page shows: threshold cards in grid with infinite scroll, filter bar with 4 criteria + debounced search, create modal with validation and duplicate warning, delete with type-to-confirm and fade-out animation, skeleton loading state, empty state with CTA, Discord channel info.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Alerts page renders threshold cards with all required fields
- Infinite scroll loads more thresholds on scroll
- Filter changes update the query and refetch
- Create modal validates and warns on duplicates
- Delete shows type-to-confirm dialog and animates card removal
- Empty state shows when no thresholds exist
- Loading state shows skeleton cards
</verification>

<success_criteria>
1. User sees card-based threshold list with metric icon, platform badge, value, toggle, last triggered
2. Cards use infinite scroll (not pagination)
3. Filter bar has 4 dropdowns + debounced text search
4. Create modal has radio buttons, dropdown, number input, duplicate warning
5. Delete uses type-to-confirm pattern
6. Cards animate on creation and deletion
7. Empty state shows friendly CTA
</success_criteria>

<output>
After completion, create `.planning/phases/13-alert-import-management/13-03-SUMMARY.md`
</output>
