---
phase: 07-data-management
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/hooks/use-exports.ts
  - src/hooks/use-bulk-operations.ts
  - src/hooks/use-trash.ts
autonomous: true

must_haves:
  truths:
    - "Frontend can create exports and track their progress"
    - "Frontend can perform bulk delete, reassign, and export-selected operations"
    - "Frontend can list, restore, and permanently delete trashed items"
    - "All mutations invalidate relevant query caches"
  artifacts:
    - path: "src/hooks/use-exports.ts"
      provides: "useCreateExport, useExportHistory, useExportProgress hooks"
      contains: "useCreateExport"
    - path: "src/hooks/use-bulk-operations.ts"
      provides: "useBulkDelete, useBulkReassign, useBulkExport hooks"
      contains: "useBulkDelete"
    - path: "src/hooks/use-trash.ts"
      provides: "useTrashItems, useRestoreItem, usePermanentDelete hooks"
      contains: "useTrashItems"
  key_links:
    - from: "src/hooks/use-exports.ts"
      to: "/api/guilds/[guildId]/exports"
      via: "fetch + React Query mutations"
      pattern: "fetch.*exports"
    - from: "src/hooks/use-bulk-operations.ts"
      to: "/api/guilds/[guildId]/bulk"
      via: "fetch + React Query mutations"
      pattern: "fetch.*bulk"
    - from: "src/hooks/use-trash.ts"
      to: "/api/guilds/[guildId]/trash"
      via: "fetch + React Query"
      pattern: "fetch.*trash"
---

<objective>
Create React Query hooks for exports, bulk operations, and trash management.

Purpose: These hooks connect the frontend UI to the API proxy routes created in 07-02. They provide type-safe data fetching, mutations with cache invalidation, and SSE-based progress tracking for exports.
Output: Three hook files covering all data management operations.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-management/07-CONTEXT.md
@.planning/phases/07-data-management/07-RESEARCH.md
@.planning/phases/07-data-management/07-01-SUMMARY.md
@.planning/phases/07-data-management/07-02-SUMMARY.md
@src/hooks/use-tracking.ts
@src/hooks/use-sse.ts
@src/types/export.ts
@src/types/bulk.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export hooks (create, history, progress)</name>
  <files>src/hooks/use-exports.ts</files>
  <action>
Create `src/hooks/use-exports.ts` with 'use client' directive.

Import types from `@/types/export` (ExportRequest, ExportRecord, ExportHistoryResponse, ExportProgressEvent, ExportStatus).

**`useCreateExport(guildId: string)`:**
- React Query `useMutation` that POSTs to `/api/guilds/${guildId}/exports`
- Body: ExportRequest
- On success: invalidate `['guild', guildId, 'exports']` query key
- Returns the created ExportRecord

**`useExportHistory(guildId: string, page: number = 1, limit: number = 20)`:**
- React Query `useQuery` with key `['guild', guildId, 'exports', page, limit]`
- GETs `/api/guilds/${guildId}/exports?page=${page}&limit=${limit}`
- Returns ExportHistoryResponse
- staleTime: 30 * 1000 (30 seconds — exports change frequently during active use)
- enabled: !!guildId

**`useExportStatus(guildId: string, exportId: string | null)`:**
- React Query `useQuery` with key `['guild', guildId, 'exports', exportId]`
- GETs `/api/guilds/${guildId}/exports/${exportId}`
- Returns ExportRecord
- refetchInterval: dynamically set — 2000ms while status is 'pending' or 'processing', false when 'completed' or 'failed'
- enabled: !!guildId && !!exportId

**`useExportProgress(guildId: string, exportId: string | null)`:**
- Custom hook using native EventSource (per DEV-027: use native over @microsoft/fetch-event-source)
- Connects to `/api/guilds/${guildId}/exports/${exportId}/progress`
- useState for progress (number), status (ExportStatus), recordCount (number), message (string)
- Opens EventSource when exportId is truthy, closes on cleanup or when status is completed/failed
- Returns `{ progress, status, recordCount, message }`
- Only connect if exportId is provided (null = no connection)
  </action>
  <verify>Run `npx tsc --noEmit` from dashboard root. No type errors.</verify>
  <done>All four export hooks compile and are exported: useCreateExport (mutation), useExportHistory (query), useExportStatus (polling query), useExportProgress (SSE hook).</done>
</task>

<task type="auto">
  <name>Task 2: Bulk operation and trash hooks</name>
  <files>src/hooks/use-bulk-operations.ts, src/hooks/use-trash.ts</files>
  <action>
**Create `src/hooks/use-bulk-operations.ts`** with 'use client' directive.

Import types from `@/types/bulk` (BulkOperationResult, BulkDeleteRequest, BulkReassignRequest, BulkExportRequest).

**`useBulkDelete(guildId: string)`:**
- React Query `useMutation` POSTing to `/api/guilds/${guildId}/bulk/delete`
- Body: `{ ids: string[], dataType: 'accounts' | 'posts' }`
- On success: invalidate `['guild', guildId, 'accounts']` AND `['guild', guildId, 'posts']` AND `['guild', guildId]` (per DEV-030: invalidate both specific list and parent guild)
- Returns BulkOperationResult

**`useBulkReassign(guildId: string)`:**
- React Query `useMutation` POSTing to `/api/guilds/${guildId}/bulk/reassign`
- Body: `{ ids: string[], dataType: 'accounts', targetBrandId: string, targetGroupId?: string }`
- On success: invalidate `['guild', guildId, 'accounts']`, `['guild', guildId, 'brands']`, `['guild', guildId]`
- Returns BulkOperationResult

**`useBulkExport(guildId: string)`:**
- React Query `useMutation` POSTing to `/api/guilds/${guildId}/exports` (reuses export endpoint)
- Body: ExportRequest with mode set to 'current_view' and a selectedIds field (or uses the export create endpoint with an ids array)
- Actually, per the architecture: bulk export of selected items should POST to `/api/guilds/${guildId}/exports` with body `{ format, mode: 'selected', dataType, ids: string[] }`. Add 'selected' to ExportMode if needed, OR just POST the ids as filter params. Simpler approach: POST to exports endpoint with `{ format, dataType, ids }` — the backend treats an ids array as a specific-items export.
- On success: invalidate `['guild', guildId, 'exports']`
- Returns ExportRecord

**Create `src/hooks/use-trash.ts`** with 'use client' directive.

**`useTrashItems(guildId: string, type: 'accounts' | 'posts' = 'accounts', page: number = 1, limit: number = 50)`:**
- React Query `useQuery` with key `['guild', guildId, 'trash', type, page, limit]`
- GETs `/api/guilds/${guildId}/trash?type=${type}&page=${page}&limit=${limit}`
- Returns `{ items: TrashItem[], pagination: Pagination }` where TrashItem extends Account or Post with `deletedAt: string, deletedBy: string, daysUntilPurge: number`
- Define `TrashItem` interface in this file: `{ id: string, name: string, type: 'account' | 'post', platform: string, deletedAt: string, deletedBy: string | null, daysUntilPurge: number, originalData: Record<string, unknown> }`
- staleTime: 60 * 1000 (1 minute)
- enabled: !!guildId

**`useRestoreItem(guildId: string)`:**
- React Query `useMutation` POSTing to `/api/guilds/${guildId}/trash/${itemId}/restore`
- On success: invalidate `['guild', guildId, 'trash']`, `['guild', guildId, 'accounts']`, `['guild', guildId, 'posts']`, `['guild', guildId]`
- mutationFn receives `{ itemId: string, dataType: 'accounts' | 'posts' }`

**`usePermanentDelete(guildId: string)`:**
- React Query `useMutation` DELETEing `/api/guilds/${guildId}/trash/${itemId}?dataType=${dataType}`
- On success: invalidate `['guild', guildId, 'trash']`
- mutationFn receives `{ itemId: string, dataType: 'accounts' | 'posts' }`
  </action>
  <verify>Run `npx tsc --noEmit` from dashboard root. No type errors.</verify>
  <done>All bulk operation hooks (useBulkDelete, useBulkReassign, useBulkExport) and trash hooks (useTrashItems, useRestoreItem, usePermanentDelete) compile with proper cache invalidation.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- All three hook files exist and export their hooks
- Hooks use proper query keys for cache management
- Mutations invalidate correct caches per DEV-030 pattern
- Export progress uses native EventSource per DEV-027
</verification>

<success_criteria>
- useCreateExport creates exports and invalidates history cache
- useExportHistory fetches paginated export list
- useExportProgress streams real-time progress via SSE
- useBulkDelete/useBulkReassign return BulkOperationResult with partial failure support
- useTrashItems returns soft-deleted items with daysUntilPurge
- useRestoreItem and usePermanentDelete handle trash item lifecycle
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-management/07-03-SUMMARY.md`
</output>
