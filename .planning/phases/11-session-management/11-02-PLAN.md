---
phase: 11-session-management
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/sessions/session-card.tsx
  - src/components/sessions/revoke-session-dialog.tsx
  - src/app/(dashboard)/settings/sessions/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of active sessions showing device type, masked IP, and last activity timestamp"
    - "User can revoke an individual session and see it removed from list immediately"
    - "User can click logout all devices and all sessions are terminated requiring re-login"
    - "Current session is visually distinguished from other sessions"
    - "Confirmation dialog appears before revoking a session showing device details"
    - "Revoked session card animates out with smooth transition"
    - "Logout all devices button is placed at bottom of session list"
  artifacts:
    - path: "src/components/sessions/session-card.tsx"
      provides: "Session card component with device icon, details, and revoke button"
      contains: "SessionCard"
    - path: "src/components/sessions/revoke-session-dialog.tsx"
      provides: "Confirmation dialog for session revocation and logout-all"
      contains: "RevokeSessionDialog"
    - path: "src/app/(dashboard)/settings/sessions/page.tsx"
      provides: "Sessions management page with list, revocation, and logout-all"
      contains: "export default function SessionsPage"
  key_links:
    - from: "src/app/(dashboard)/settings/sessions/page.tsx"
      to: "src/hooks/use-sessions.ts"
      via: "useSessions, useRevokeSession, useLogoutAll hooks"
      pattern: "use(Sessions|RevokeSession|LogoutAll)"
    - from: "src/components/sessions/session-card.tsx"
      to: "lucide-react"
      via: "Monitor, Smartphone, Tablet icon imports"
      pattern: "from 'lucide-react'"
    - from: "src/components/sessions/revoke-session-dialog.tsx"
      to: "@headlessui/react"
      via: "Dialog, DialogPanel, DialogTitle imports"
      pattern: "from '@headlessui/react'"
---

<objective>
Build the session management UI: session card component with device icons and details, confirmation dialog for revocation, and the sessions page that ties everything together with session list, individual revocation, logout-all functionality, and smooth animations.

Purpose: Deliver the user-facing session management experience per locked decisions (card-based layout, confirmation dialogs, animated removal, logout-all at bottom).
Output: 3 component files creating a complete session management page at /settings/sessions.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-session-management/11-RESEARCH.md
@.planning/phases/11-session-management/11-01-SUMMARY.md

# Key reference files for UI patterns:
@src/components/ui/confirmation-modal.tsx
@src/components/tracking/account-card.tsx
@src/types/session.ts
@src/hooks/use-sessions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session card and revoke session dialog components</name>
  <files>
    src/components/sessions/session-card.tsx
    src/components/sessions/revoke-session-dialog.tsx
  </files>
  <action>
    **Component 1: SessionCard at `src/components/sessions/session-card.tsx`**

    Per locked decisions: card-based layout, full detail per card, device icons alongside text labels, header with session count.

    - `'use client'` directive
    - Import `Monitor`, `Smartphone`, `Tablet` from `lucide-react` (per decision: device icons for Desktop, Mobile, Tablet)
    - Import `formatDistanceToNow` from `date-fns`
    - Import `ParsedSession` from `@/types/session`
    - Import `cn` from `@/lib/utils`

    Props interface `SessionCardProps`:
    ```
    {
      session: ParsedSession;
      onRevoke: (sessionId: string) => void;
    }
    ```

    Device icon mapping:
    ```
    const DEVICE_ICONS = {
      desktop: Monitor,
      mobile: Smartphone,
      tablet: Tablet,
      unknown: Monitor,
    } as const;
    ```

    Render a card (follow existing `bg-surface border border-border rounded-sm p-6` pattern):
    - Top row: device icon (w-6 h-6 text-gray-400) + device name + "Current Session" badge if `session.isCurrent` (use `bg-accent-purple/20 text-accent-purple px-2 py-0.5 rounded text-xs font-medium`) + Revoke button on right
    - Second line below device name: `{browser.name} {browser.version} on {os.name} {os.version}` in text-sm text-gray-400
    - Bottom section: 2-column grid showing:
      - IP Address (label in text-gray-400, value in text-white font-mono text-sm)
      - Last Active (label in text-gray-400, value using `formatDistanceToNow(new Date(session.createdAt), { addSuffix: true })`)
    - Revoke button: `text-sm text-red-400 hover:text-red-300 transition-colors`, but hidden if `session.isCurrent` (use `{!session.isCurrent && <button>}` — current session shouldn't be revoked individually from here)
    - Actually, per the research's pattern for current session: show the revoke button even for current session, but the revoke dialog will warn that user will be logged out. So always show the button.

    Add CSS transition support: wrap the card in a div with `transition-all duration-300 ease-in-out` class. The parent page will manage animation state.

    **Component 2: RevokeSessionDialog at `src/components/sessions/revoke-session-dialog.tsx`**

    Per locked decisions: confirmation dialog (modal) before revoking showing device details. Same dialog style for both single revoke and logout-all.

    - `'use client'` directive
    - Import `Dialog`, `DialogPanel`, `DialogTitle`, `Description` from `@headlessui/react`
    - Import `cn` from `@/lib/utils`

    Props interface `RevokeSessionDialogProps`:
    ```
    {
      open: boolean;
      onClose: () => void;
      onConfirm: () => void;
      mode: 'single' | 'all';
      deviceName?: string;        // For single revoke: device name (e.g., "Desktop")
      browserInfo?: string;       // For single revoke: "Chrome 110 on Windows"
      isCurrent?: boolean;        // For single revoke: whether this is the current session
      sessionCount?: number;      // For logout-all: number of sessions
      isLoading?: boolean;
    }
    ```

    Dialog structure (follow existing `confirmation-modal.tsx` pattern exactly):
    - Backdrop: `fixed inset-0 bg-black/60`
    - Container: `fixed inset-0 flex items-center justify-center p-4`
    - Panel: `max-w-md w-full bg-surface border border-border rounded-lg p-6 space-y-4`
    - Title:
      - Single mode: "Revoke Session"
      - All mode: "Logout All Devices"
    - Description:
      - Single + isCurrent: "You are about to revoke your **current session** on **{deviceName}**. You will be logged out and redirected to the login page."
      - Single + not current: "Are you sure you want to revoke the session on **{deviceName}** ({browserInfo})? This device will no longer have access."
      - All mode: "This will revoke all **{sessionCount}** active sessions, including your current one. You will be logged out and need to sign in again."
    - Buttons: Cancel (text-gray-300 hover:text-white) + Confirm (bg-red-600 hover:bg-red-700 text-white rounded-md)
      - Confirm label: single mode → "Revoke Session" / "Revoking..." when loading, all mode → "Logout All" / "Logging out..." when loading
    - Both buttons disabled when `isLoading`
  </action>
  <verify>
    Run `npx tsc --noEmit` from the dashboard project root. No TypeScript errors.
    Verify both files exist: `ls src/components/sessions/session-card.tsx src/components/sessions/revoke-session-dialog.tsx`
  </verify>
  <done>
    SessionCard renders device icon, browser/OS info, masked IP, last active timestamp, current session badge, and revoke button. RevokeSessionDialog supports both single revocation and logout-all modes with appropriate messaging. Both follow existing component patterns (Headless UI Dialog, bg-surface styling, cn utility).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sessions page with list, revocation, animations, and logout-all</name>
  <files>
    src/app/(dashboard)/settings/sessions/page.tsx
  </files>
  <action>
    Create `src/app/(dashboard)/settings/sessions/page.tsx` as a client component that brings together all session management functionality.

    Per locked decisions:
    - Card-based layout with session count header ("Active Sessions (X)")
    - Confirmation dialog before revoke showing device details
    - Revoked session card animates out with smooth transition
    - "Logout all devices" revokes ALL sessions including current, redirects to login
    - "Logout all devices" uses same dialog style as single revoke
    - "Logout all devices" button at bottom of session list (less prominent)

    **Imports:**
    - `useState` from `react`
    - `useSessions`, `useRevokeSession`, `useLogoutAll` from `@/hooks/use-sessions`
    - `SessionCard` from `@/components/sessions/session-card`
    - `RevokeSessionDialog` from `@/components/sessions/revoke-session-dialog`
    - `ParsedSession` from `@/types/session`

    **State:**
    - `dialogOpen: boolean` (false)
    - `dialogMode: 'single' | 'all'` ('single')
    - `sessionToRevoke: ParsedSession | null` (null)
    - `removingIds: Set<string>` (empty set — tracks sessions being animated out)

    **Handlers:**

    `handleRevokeClick(session: ParsedSession)`:
    - Set `sessionToRevoke` to the session, `dialogMode` to 'single', `dialogOpen` to true

    `handleLogoutAllClick()`:
    - Set `dialogMode` to 'all', `dialogOpen` to true

    `handleConfirmRevoke()`:
    - If mode is 'single' and sessionToRevoke exists:
      - If `sessionToRevoke.isCurrent`: call `revokeSession.mutate(sessionToRevoke.id)`, on success close dialog and redirect to `/login` via `window.location.href = '/login'`
      - Otherwise: Add sessionId to `removingIds` set (triggers CSS animation), call `revokeSession.mutate(sessionToRevoke.id)`, on success close dialog and reset state. The animation is handled by CSS transition on the card.
    - If mode is 'all': call `logoutAll.mutate()` (the hook handles redirect)

    `handleDialogClose()`:
    - Only close if not loading: `if (!revokeSession.isPending && !logoutAll.isPending) { setDialogOpen(false); setSessionToRevoke(null); }`

    **Render:**

    Page layout (`space-y-6`):

    1. **Header section:**
       - `<h1 className="text-2xl font-bold text-white">Active Sessions ({sessions?.length || 0})</h1>`
       - `<p className="text-gray-400 mt-1">Manage your active sessions across different devices. Sessions that you don't recognize can be revoked.</p>`

    2. **Loading state:** Show 3 skeleton cards using a simple div with `animate-pulse bg-surface border border-border rounded-sm p-6 h-32` repeated 3 times.

    3. **Session list:** Map over `sessions`, render each in a wrapper div:
       ```
       <div
         key={session.id}
         className={cn(
           'transition-all duration-300 ease-in-out',
           removingIds.has(session.id)
             ? 'opacity-0 scale-95 max-h-0 overflow-hidden'
             : 'opacity-100 scale-100 max-h-96'
         )}
       >
         <SessionCard session={session} onRevoke={() => handleRevokeClick(session)} />
       </div>
       ```

    4. **Empty state** (if sessions is empty array and not loading):
       ```
       <div className="bg-surface border border-border rounded-sm p-6">
         <p className="text-gray-400">No active sessions found.</p>
       </div>
       ```

    5. **Logout all devices section** (per decision: at bottom, less prominent):
       - Show only if `sessions && sessions.length > 0`
       - Wrapped in `<div className="pt-6 border-t border-border">`
       - Button: `<button className="px-4 py-2 text-sm font-medium text-red-400 hover:text-red-300 border border-red-400/30 hover:border-red-400/50 rounded-md transition-colors" onClick={handleLogoutAllClick}>Logout All Devices</button>`
       - Description below button: `<p className="text-sm text-gray-500 mt-2">This will log you out of all devices including this one.</p>`

    6. **RevokeSessionDialog:**
       ```
       <RevokeSessionDialog
         open={dialogOpen}
         onClose={handleDialogClose}
         onConfirm={handleConfirmRevoke}
         mode={dialogMode}
         deviceName={sessionToRevoke?.device.name}
         browserInfo={sessionToRevoke ? `${sessionToRevoke.browser.name} ${sessionToRevoke.browser.version} on ${sessionToRevoke.os.name}` : undefined}
         isCurrent={sessionToRevoke?.isCurrent}
         sessionCount={sessions?.length}
         isLoading={revokeSession.isPending || logoutAll.isPending}
       />
       ```

    **Sort order** (Claude's discretion): Current session pinned first (already handled in API route which marks isCurrent). Sort: current first, then by createdAt descending. Apply sorting in the page component: `const sortedSessions = sessions ? [...sessions].sort((a, b) => { if (a.isCurrent !== b.isCurrent) return a.isCurrent ? -1 : 1; return 0; }) : []` — backend already sorts by createdAt desc, so just pin current.

    **Single session edge case** (Claude's discretion): Always show "Logout All Devices" button even with one session, since user may want to force-logout to invalidate tokens.
  </action>
  <verify>
    Run `npx tsc --noEmit` from the dashboard project root. No TypeScript errors.
    Run `npm run build` to verify the page compiles as a valid Next.js route.
    Verify: `ls src/app/\(dashboard\)/settings/sessions/page.tsx` exists.
  </verify>
  <done>
    Sessions page at /settings/sessions renders:
    - Header showing "Active Sessions (X)" with description
    - Card-based session list with current session pinned first and badged
    - Each card shows device icon + type, browser/OS, masked IP, last active time
    - Revoke button on each card opens confirmation dialog with device details
    - Revoked sessions animate out with fade + scale transition
    - "Logout All Devices" button at bottom with confirmation dialog
    - Logout-all triggers full session revocation and redirects to /login
    - Loading skeletons and empty state handled
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds (validates page as Next.js route)
3. Sessions page is accessible at /settings/sessions
4. Session cards display device icon, browser/OS info, masked IP, and relative timestamps
5. Current session is visually distinguished with purple badge
6. Revoking a session shows confirmation dialog, then animates the card out
7. "Logout All Devices" shows confirmation dialog, revokes all, redirects to /login
</verification>

<success_criteria>
- Session card renders device icon (Monitor/Smartphone/Tablet from lucide-react), device name, browser + OS, masked IP (font-mono), and last active time
- Current session badge visible with accent-purple styling
- Confirmation dialog shows before revocation with appropriate messaging for single vs all modes
- Revoked session card fades and scales out with 300ms CSS transition
- "Logout All Devices" button at bottom of list revokes all sessions and redirects to /login
- Loading state shows skeleton cards, empty state shows informational message
- Page follows existing dashboard styling (bg-surface, border-border, text-white/gray-400)
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-management/11-02-SUMMARY.md`
</output>
