---
phase: 07-data-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/guilds/[guildId]/exports/route.ts
  - src/app/api/guilds/[guildId]/exports/[exportId]/route.ts
  - src/app/api/guilds/[guildId]/exports/[exportId]/progress/route.ts
  - src/app/api/guilds/[guildId]/bulk/delete/route.ts
  - src/app/api/guilds/[guildId]/bulk/reassign/route.ts
  - src/app/api/guilds/[guildId]/trash/route.ts
  - src/app/api/guilds/[guildId]/trash/[itemId]/route.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard API can proxy export creation requests to backend"
    - "Dashboard API can proxy bulk delete/reassign requests to backend"
    - "Dashboard API can proxy trash list/restore/permanent-delete requests to backend"
    - "Export progress SSE endpoint is proxied correctly"
  artifacts:
    - path: "src/app/api/guilds/[guildId]/exports/route.ts"
      provides: "POST create export, GET export history"
      exports: ["POST", "GET"]
    - path: "src/app/api/guilds/[guildId]/exports/[exportId]/route.ts"
      provides: "GET export status/download URL"
      exports: ["GET"]
    - path: "src/app/api/guilds/[guildId]/exports/[exportId]/progress/route.ts"
      provides: "GET SSE stream for export progress"
      exports: ["GET"]
    - path: "src/app/api/guilds/[guildId]/bulk/delete/route.ts"
      provides: "POST bulk soft-delete for accounts/posts"
      exports: ["POST"]
    - path: "src/app/api/guilds/[guildId]/bulk/reassign/route.ts"
      provides: "POST bulk reassign accounts to different brand/group"
      exports: ["POST"]
    - path: "src/app/api/guilds/[guildId]/trash/route.ts"
      provides: "GET list trashed items"
      exports: ["GET"]
    - path: "src/app/api/guilds/[guildId]/trash/[itemId]/route.ts"
      provides: "POST restore, DELETE permanent delete"
      exports: ["POST", "DELETE"]
  key_links:
    - from: "src/app/api/guilds/[guildId]/exports/route.ts"
      to: "backend API"
      via: "fetch proxy to NEXT_PUBLIC_API_URL"
      pattern: "fetch.*API_URL"
    - from: "src/app/api/guilds/[guildId]/bulk/delete/route.ts"
      to: "backend API"
      via: "fetch proxy"
      pattern: "fetch.*API_URL"
---

<objective>
Create all Next.js API proxy routes for exports, bulk operations, and trash management.

Purpose: The dashboard follows the API gateway pattern where Next.js routes proxy to the Express backend. These routes must exist before any frontend hooks or UI can call them. The backend endpoints for bulk/export/trash will need to be created, but these proxy routes establish the contract.
Output: 7 API route files covering exports (CRUD + progress SSE), bulk operations (delete + reassign), and trash (list + restore + permanent delete).
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-management/07-CONTEXT.md
@.planning/phases/07-data-management/07-RESEARCH.md
@src/app/api/guilds/[guildId]/accounts/route.ts
@src/app/api/guilds/[guildId]/status/stream/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export API proxy routes</name>
  <files>src/app/api/guilds/[guildId]/exports/route.ts, src/app/api/guilds/[guildId]/exports/[exportId]/route.ts, src/app/api/guilds/[guildId]/exports/[exportId]/progress/route.ts</files>
  <action>
Follow the exact proxy pattern from `src/app/api/guilds/[guildId]/accounts/route.ts` for auth token extraction and error handling.

**`src/app/api/guilds/[guildId]/exports/route.ts`:**
- `POST` handler: Proxy to `${API_URL}/api/v1/guilds/${guildId}/exports` with JSON body. Body contains: `{ format, mode, dataType, filters?, filename? }`. Returns export record with id, status, downloadUrl.
- `GET` handler: Proxy to `${API_URL}/api/v1/guilds/${guildId}/exports` with query params (page, limit). Returns export history list.

**`src/app/api/guilds/[guildId]/exports/[exportId]/route.ts`:**
- `GET` handler: Proxy to `${API_URL}/api/v1/guilds/${guildId}/exports/${exportId}`. Returns single export record with status and downloadUrl.

**`src/app/api/guilds/[guildId]/exports/[exportId]/progress/route.ts`:**
- `GET` handler: SSE proxy. Follow the pattern from `src/app/api/guilds/[guildId]/status/stream/route.ts` for SSE proxying. Proxy to `${API_URL}/api/v1/guilds/${guildId}/exports/${exportId}/progress`. Stream events from backend to client using ReadableStream with TextEncoder.

All routes must:
- Extract auth_token from cookies
- Return 401 if no token
- Forward Authorization Bearer header + X-API-Key if configured
- Use `type RouteParams = { params: Promise<{ guildId: string }> }` pattern (or with exportId for nested routes)
- Return backend response status code and body
  </action>
  <verify>Run `npx tsc --noEmit` from dashboard root. All three route files compile.</verify>
  <done>Export proxy routes handle POST create, GET history, GET single status, and GET SSE progress stream.</done>
</task>

<task type="auto">
  <name>Task 2: Bulk operation and trash API proxy routes</name>
  <files>src/app/api/guilds/[guildId]/bulk/delete/route.ts, src/app/api/guilds/[guildId]/bulk/reassign/route.ts, src/app/api/guilds/[guildId]/trash/route.ts, src/app/api/guilds/[guildId]/trash/[itemId]/route.ts</files>
  <action>
Same proxy pattern as Task 1.

**`src/app/api/guilds/[guildId]/bulk/delete/route.ts`:**
- `POST` handler: Proxy to `${API_URL}/api/v1/guilds/${guildId}/bulk/delete` with JSON body `{ ids: string[], dataType: 'accounts' | 'posts' }`. Backend will soft-delete items (set deletedAt). Returns BulkOperationResult shape. Forward the exact status code from backend (200 for all success, 207 for partial failure).

**`src/app/api/guilds/[guildId]/bulk/reassign/route.ts`:**
- `POST` handler: Proxy to `${API_URL}/api/v1/guilds/${guildId}/bulk/reassign` with JSON body `{ ids: string[], dataType: 'accounts', targetBrandId: string, targetGroupId?: string }`. Returns BulkOperationResult.

**`src/app/api/guilds/[guildId]/trash/route.ts`:**
- `GET` handler: Proxy to `${API_URL}/api/v1/guilds/${guildId}/trash` with query params (type: 'accounts' | 'posts', page, limit). Returns list of soft-deleted items with deletedAt, deletedBy, and daysUntilPurge.

**`src/app/api/guilds/[guildId]/trash/[itemId]/route.ts`:**
- `POST` handler (restore): Proxy to `${API_URL}/api/v1/guilds/${guildId}/trash/${itemId}/restore` with JSON body `{ dataType: 'accounts' | 'posts' }`. Clears deletedAt, restores item.
- `DELETE` handler (permanent delete): Proxy to `${API_URL}/api/v1/guilds/${guildId}/trash/${itemId}` with query param `dataType`. Hard deletes the item permanently.

Use `type RouteParams = { params: Promise<{ guildId: string }> }` for bulk routes and `{ params: Promise<{ guildId: string, itemId: string }> }` for trash item routes.
  </action>
  <verify>Run `npx tsc --noEmit` from dashboard root. All four route files compile.</verify>
  <done>Bulk delete, bulk reassign, trash list, trash restore, and trash permanent delete proxy routes all compile and follow established proxy patterns.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- 7 new API route files exist under src/app/api/guilds/[guildId]/
- Each route extracts auth token, forwards to backend, returns response
- SSE progress route uses ReadableStream pattern for streaming
</verification>

<success_criteria>
- All 7 API proxy routes compile and follow the established auth+proxy pattern
- Export routes: POST create, GET history, GET single, GET SSE progress
- Bulk routes: POST delete (soft), POST reassign
- Trash routes: GET list, POST restore, DELETE permanent
- Status codes forwarded correctly (including 207 for partial failures)
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-management/07-02-SUMMARY.md`
</output>
