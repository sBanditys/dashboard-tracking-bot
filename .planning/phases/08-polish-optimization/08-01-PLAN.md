---
phase: 08-polish-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/fetch-with-retry.ts
  - src/app/providers.tsx
  - next.config.mjs
autonomous: true

must_haves:
  truths:
    - "429 responses from API trigger automatic retry with exponential backoff instead of failing"
    - "Route transitions show branded accent-purple progress bar at top of viewport"
    - "Toast notifications stack up to 3, oldest dismissed first, dark themed"
    - "React Query gcTime is set to 10 minutes to prevent memory growth"
  artifacts:
    - path: "src/lib/fetch-with-retry.ts"
      provides: "fetchWithRetry wrapper with 429 handling, exponential backoff, jitter"
      exports: ["fetchWithRetry"]
    - path: "src/app/providers.tsx"
      provides: "Sonner Toaster, BProgress NavigationProgress, gcTime config"
      contains: "Toaster"
    - path: "next.config.mjs"
      provides: "Bundle analyzer integration"
      contains: "bundleAnalyzer"
  key_links:
    - from: "src/lib/fetch-with-retry.ts"
      to: "global fetch"
      via: "wrapper function"
      pattern: "fetchWithRetry"
    - from: "src/app/providers.tsx"
      to: "sonner"
      via: "Toaster component"
      pattern: "Toaster"
---

<objective>
Install core dependencies (BProgress, Sonner, @next/bundle-analyzer), create fetchWithRetry utility with 429 exponential backoff, configure React Query gcTime, set up branded progress bar and toast provider.

Purpose: Foundation layer that all other Phase 8 plans build upon — retry logic, notifications, and progress indicators.
Output: Working fetchWithRetry utility, themed progress bar on route transitions, toast notification system, bundle analyzer config.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-optimization/08-RESEARCH.md

@src/app/providers.tsx
@src/lib/api-client.ts
@next.config.mjs
@package.json
@tailwind.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create fetchWithRetry utility</name>
  <files>
    package.json
    src/lib/fetch-with-retry.ts
  </files>
  <action>
    1. Install dependencies:
       ```
       npm install bprogress sonner
       npm install --save-dev @next/bundle-analyzer
       ```

    2. Create `src/lib/fetch-with-retry.ts` with:
       - `fetchWithRetry(url: string, options?: RequestInit, maxRetries?: number): Promise<Response>` function
       - Handle 429 responses: check Retry-After header, fall back to exponential backoff (1s, 2s, 4s...) capped at 30s
       - Add jitter: randomize 0-50% of delay to prevent thundering herd
       - Max 3 retries by default
       - Also retry on network errors (catch block) with same backoff
       - Export the function for use in hooks

    Note: This creates the utility. Plan 04 will integrate it into all hooks.
  </action>
  <verify>
    - `npm ls bprogress sonner @next/bundle-analyzer` shows all installed
    - `npx tsc --noEmit` passes with no errors
    - `src/lib/fetch-with-retry.ts` exists and exports fetchWithRetry
  </verify>
  <done>
    Dependencies installed, fetchWithRetry utility handles 429 with exponential backoff + jitter, max 3 retries, 30s cap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure providers with progress bar, toast, and gcTime</name>
  <files>
    src/app/providers.tsx
    next.config.mjs
  </files>
  <action>
    1. Update `src/app/providers.tsx`:
       - Add `gcTime: 10 * 60 * 1000` (10 minutes) to QueryClient defaultOptions.queries
       - Import and add Sonner `Toaster` component with:
         - position="top-right"
         - visibleToasts={3}
         - theme="dark"
         - toastOptions with style: background #2d2d2d, border 1px solid #404040, color #ffffff
       - Import BProgress and create a `NavigationProgress` component:
         - Use `usePathname()` and `useSearchParams()` from next/navigation
         - On path/search change, call BProgress start/done
         - Configure BProgress with color '#8B5CF6' (accent-purple), height '2px'
         - Wrap NavigationProgress in Suspense boundary (useSearchParams requires it in Next.js 14)
       - Render order inside providers: NavigationProgress, Toaster, then children

    2. Update `next.config.mjs`:
       - Import @next/bundle-analyzer
       - Wrap config with withBundleAnalyzer({ enabled: process.env.ANALYZE === 'true' })
       - Keep existing images.remotePatterns config

    BProgress API note: Check BProgress docs — it may use `BProgress.configure()` and `BProgress.start()/done()` or may use a React component. Use whichever pattern the library provides. The key requirement is accent-purple color (#8B5CF6), 2px height, and 100ms delay before showing (so instant navigations don't flash the bar).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (no build errors with new providers)
    - Progress bar, toast, and gcTime all configured in providers.tsx
  </verify>
  <done>
    Providers configured with branded progress bar (accent-purple, 2px), Sonner toast system (3 max, dark themed), React Query gcTime (10 min), and bundle analyzer ready via ANALYZE=true flag.
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- `npx tsc --noEmit` passes
- BProgress, Sonner, @next/bundle-analyzer in package.json
- providers.tsx has Toaster, NavigationProgress, gcTime
- fetchWithRetry handles 429 with backoff
- next.config.mjs has bundle analyzer wrapper
</verification>

<success_criteria>
- All three deps installed and importable
- fetchWithRetry utility created with 429/network retry logic
- Progress bar shows accent-purple (#8B5CF6) on route transitions
- Toast system configured with max 3, dark theme matching dashboard
- gcTime set to 10 minutes globally
- Bundle analyzer runnable with ANALYZE=true npm run build
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-optimization/08-01-SUMMARY.md`
</output>
