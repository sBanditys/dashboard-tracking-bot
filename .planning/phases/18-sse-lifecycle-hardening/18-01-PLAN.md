---
phase: 18-sse-lifecycle-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-sse.ts
  - src/components/bot-status.tsx
  - src/app/(dashboard)/guilds/[guildId]/page.tsx
autonomous: true
requirements: [SSE-01, SSE-02, SSE-03]

must_haves:
  truths:
    - "A connection that receives no data events for 45+ seconds is automatically closed and a reconnect attempt begins"
    - "Rapidly hiding and showing the browser tab does not produce two simultaneous EventSource connections"
    - "Returning to a tab where retries were exhausted while hidden reconnects the SSE stream instead of staying permanently disconnected"
    - "A brief 'Reconnecting...' indicator is visible during stall-triggered reconnects"
    - "The connection status indicator is always visible on the guild detail page, not hidden until status data loads"
  artifacts:
    - path: "src/hooks/use-sse.ts"
      provides: "Hardened SSE hook with heartbeat, generation counter, grace period, retry reset"
      contains: "connectGenerationRef|lastEventTimeRef|hideGraceTimerRef|heartbeatCheckRef|reconnecting"
    - path: "src/components/bot-status.tsx"
      provides: "Connection indicator with reconnecting state and always-visible rendering"
      contains: "reconnecting"
    - path: "src/app/(dashboard)/guilds/[guildId]/page.tsx"
      provides: "Always-visible BotStatus rendering regardless of status data"
      contains: "BotStatus"
  key_links:
    - from: "src/hooks/use-sse.ts"
      to: "src/components/bot-status.tsx"
      via: "ConnectionState type export includes 'reconnecting'"
      pattern: "reconnecting"
    - from: "src/hooks/use-sse.ts"
      to: "src/hooks/use-guilds.ts"
      via: "connectionState value consumed by useGuildStatusRealtime"
      pattern: "connectionState"
---

<objective>
Harden the `useSSE` hook with heartbeat timeout, generation counter, 15-second tab-hide grace period, and retry reset on tab return. Add a `'reconnecting'` connection state variant and make the BotStatus indicator always visible.

Purpose: SSE connections currently have no stall detection, no race condition prevention during rapid tab switches, and retries exhausted while the tab is hidden permanently kill the connection. This plan fixes all three reliability gaps and adds visual feedback for reconnection attempts.

Output: Hardened `useSSE` hook, updated `BotStatus` component with reconnecting state, always-visible indicator on guild detail page.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-sse-lifecycle-hardening/18-RESEARCH.md
@src/hooks/use-sse.ts
@src/components/bot-status.tsx
@src/app/(dashboard)/guilds/[guildId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heartbeat timeout, generation counter, grace period, and retry reset to useSSE</name>
  <files>src/hooks/use-sse.ts</files>
  <action>
Rewrite the `useSSE` hook with the following changes. Keep the existing API surface (`url`, `options`, returns `{ connectionState, reconnect }`).

**1. Add `'reconnecting'` to ConnectionState type:**
```typescript
export type ConnectionState = 'connecting' | 'reconnecting' | 'connected' | 'disconnected' | 'error'
```

**2. Add new refs** (alongside existing ones):
- `connectGenerationRef = useRef<number>(0)` — generation counter for race prevention (SSE-02)
- `lastEventTimeRef = useRef<number>(Date.now())` — last data event timestamp for heartbeat (SSE-01)
- `heartbeatCheckRef = useRef<ReturnType<typeof setInterval> | null>(null)` — heartbeat polling interval (SSE-01)
- `hideGraceTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null)` — 15s tab-hide grace timer

**3. Add constants:**
- `HEARTBEAT_TIMEOUT = 45_000` (45 seconds — per requirement, Claude's discretion: keep 45s since data events arrive every 5s on active streams; a 45s silence means genuine stall)
- `HEARTBEAT_CHECK_INTERVAL = 5_000` (check every 5s)
- `HIDE_GRACE_MS = 15_000` (15-second grace period — locked decision from CONTEXT.md)

**4. Add `clearHeartbeat` helper** that clears `heartbeatCheckRef` interval if it exists and sets it to null.

**5. Add `startHeartbeat` helper** that clears any existing heartbeat, resets `lastEventTimeRef.current = Date.now()`, then starts a `setInterval` on `heartbeatCheckRef`:
- Every `HEARTBEAT_CHECK_INTERVAL` ms, check `Date.now() - lastEventTimeRef.current > HEARTBEAT_TIMEOUT`
- If stalled AND `connectGenerationRef.current === capturedGeneration` (capture generation when starting): close `eventSourceRef.current`, call `clearHeartbeat()`, set state to `'reconnecting'`, call `connect()`
- If stalled but generation is stale, just clear the interval (a newer connection owns the heartbeat)

**6. Modify `connect()` function:**
- At the top: increment `connectGenerationRef.current` and capture `const generation = ++connectGenerationRef.current`
- Clear any existing heartbeat at the start
- In `es.onopen`: check `connectGenerationRef.current !== generation` — if stale, `es.close()` and return. Otherwise: set state to `'connected'`, reset `retryCountRef.current = 0`, reset `lastEventTimeRef.current = Date.now()`, call `startHeartbeat(generation)`.
- In `es.onmessage`: check generation staleness — if stale, `es.close()` and return. Otherwise: reset `lastEventTimeRef.current = Date.now()`, then parse and dispatch as currently.
- In `es.onerror`: check generation staleness — if stale, `es.close()` and return. Otherwise: close, set state to `'disconnected'`, clear heartbeat, run existing retry logic.

**7. Rewrite tab visibility handler** (the `visibilitychange` useEffect):
- On `document.hidden`:
  - Clear any pending retry timeout (`retryTimeoutRef`)
  - Start grace period: `hideGraceTimerRef.current = setTimeout(() => { ... }, HIDE_GRACE_MS)`
  - Inside the grace timeout callback: close `eventSourceRef.current`, call `clearHeartbeat()`, set state to `'disconnected'`
- On tab visible (`!document.hidden`):
  - If `hideGraceTimerRef.current` is not null (within grace period): `clearTimeout(hideGraceTimerRef.current)`, set to null. Connection is still open — do nothing.
  - If `hideGraceTimerRef.current` is null (grace period already fired or was never started, meaning tab was hidden > 15s): reset `retryCountRef.current = 0` (SSE-03), call `connect()` to reconnect.
- In the cleanup return: remove event listener AND `clearTimeout(hideGraceTimerRef.current)`

**8. Update main `useEffect` cleanup** to also call `clearHeartbeat()` and `clearTimeout(hideGraceTimerRef.current)`.

**9. Update `reconnect()` function** to also call `clearHeartbeat()` before calling `connect()`.

**Key behavioral notes:**
- The `'reconnecting'` state is ONLY set when a heartbeat timeout triggers a reconnect (user was connected, connection stalled). Initial connection uses `'connecting'` as before.
- Generation counter ensures only the most recent `connect()` call's EventSource has authority. Stale closures from previous connections exit immediately.
- Grace period prevents disconnect/reconnect churn for brief tab switches (locked user decision).
- `retryCountRef` reset on tab return (SSE-03) only happens when the grace period has expired (tab was hidden >15s), preventing infinite retry loops on repeatedly-failing servers per research pitfall #3.
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root — no type errors. Verify `ConnectionState` type includes `'reconnecting'`. Verify `connectGenerationRef`, `lastEventTimeRef`, `heartbeatCheckRef`, `hideGraceTimerRef` are all present. Verify `HIDE_GRACE_MS = 15_000` constant exists.
  </verify>
  <done>
useSSE hook has heartbeat timeout (45s), generation counter preventing dual connections, 15-second tab-hide grace period, retry reset on tab return after grace expiry, and emits 'reconnecting' state during stall-triggered reconnects. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add reconnecting state to BotStatus and make indicator always visible</name>
  <files>src/components/bot-status.tsx, src/app/(dashboard)/guilds/[guildId]/page.tsx</files>
  <action>
**1. Update `BotStatus` component (`src/components/bot-status.tsx`):**

Add a `'reconnecting'` case to `getStatusDisplay()`, placed BEFORE the `'error'` case (after `'connecting'`):
```typescript
if (connectionState === 'reconnecting') {
    return {
        dotClass: 'bg-yellow-500 animate-pulse',
        textClass: 'text-yellow-400',
        text: 'Reconnecting...',
        subtext: null,
    }
}
```

Also add a `'disconnected'` display case (currently falls through to bot healthy/offline logic which is wrong when SSE is disconnected but bot status data hasn't loaded yet). Place AFTER reconnecting, BEFORE error:
```typescript
if (connectionState === 'disconnected') {
    return {
        dotClass: 'bg-gray-400',
        textClass: 'text-gray-400',
        text: 'Disconnected',
        subtext: null,
    }
}
```

Make the component clickable for `'reconnecting'` state too (force reconnect) — update `isClickable`:
```typescript
const isClickable = (connectionState === 'error' || connectionState === 'reconnecting') && onReconnect
```

Update the `BotStatusProps` interface: make `healthy` optional (`healthy?: boolean`) since we'll render BotStatus even before status data loads.

Update the healthy/offline section to handle `healthy === undefined` — if `healthy` is undefined and we're in `'connected'` state, show "Live" (green dot + text "Live") since connection is working but status data hasn't arrived yet. Actually, simplify: if `healthy` is undefined, show the connected state as "Connected" with a green dot (the data will arrive shortly via SSE):
```typescript
if (healthy === undefined) {
    return {
        dotClass: 'bg-green-500 animate-pulse',
        textClass: 'text-green-400',
        text: 'Connected',
        subtext: null,
    }
}
```
Place this right after the `'error'` and `'disconnected'` checks, before the `if (healthy)` check.

**2. Update guild detail page (`src/app/(dashboard)/guilds/[guildId]/page.tsx`):**

Change the BotStatus rendering from conditionally shown (`{status && <BotStatus ... />}`) to always shown. Pass `healthy` as optional:
```tsx
<BotStatus
    healthy={status?.bot_healthy}
    lastHeartbeat={status?.bot?.last_heartbeat}
    version={status?.bot?.version}
    connectionState={connectionState}
    onReconnect={reconnect}
/>
```

Remove the `{status && ...}` wrapper so BotStatus always renders. This satisfies the locked user decision: "always-visible connection status indicator — shows state at all times, not just on errors."
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify BotStatus handles all 5 connection states: connecting, reconnecting, connected, disconnected, error. Verify guild detail page renders BotStatus without `{status && ...}` guard.
  </verify>
  <done>
BotStatus shows "Reconnecting..." with yellow pulsing dot during stall recovery. Indicator is always visible on guild page regardless of whether status data has loaded. Component handles all 5 ConnectionState variants with appropriate visual styling. Clicking during reconnecting or error state triggers manual reconnect.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `ConnectionState` type in use-sse.ts includes all 5 states: connecting, reconnecting, connected, disconnected, error
3. `useSSE` contains: connectGenerationRef, lastEventTimeRef, heartbeatCheckRef, hideGraceTimerRef
4. HEARTBEAT_TIMEOUT is 45000, HIDE_GRACE_MS is 15000
5. Tab visibility handler uses grace period (setTimeout 15s) not immediate close
6. Generation check exists in es.onopen, es.onmessage, and es.onerror
7. retryCountRef reset happens only when grace period has expired
8. BotStatus renders without {status && ...} guard on guild detail page
9. BotStatus has visual handling for 'reconnecting' state (yellow dot + "Reconnecting..." text)
</verification>

<success_criteria>
- Heartbeat silence timer closes and reconnects stalled connections after 45s of no data events
- Generation counter prevents dual EventSource instances during rapid tab visibility changes
- 15-second grace period prevents disconnect/reconnect churn for brief tab switches
- Retry count resets on tab return after grace period expiry, recovering exhausted retries
- BotStatus always visible with colored dot + label for all connection states
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/18-sse-lifecycle-hardening/18-01-SUMMARY.md`
</output>
