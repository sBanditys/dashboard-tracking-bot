---
phase: 13-alert-import-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  # Backend fixes
  - ~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds/guildAlerts.ts
  - ~/Desktop/Tracking Data Bot/api/src/routes/dashboard/exports.ts
  # Dashboard types
  - src/types/alert.ts
  - src/types/import.ts
  - src/types/export.ts
  # Dashboard proxy routes - alerts
  - src/app/api/guilds/[guildId]/alert-thresholds/route.ts
  - src/app/api/guilds/[guildId]/groups/[groupId]/alert-thresholds/route.ts
  - src/app/api/guilds/[guildId]/groups/[groupId]/alert-thresholds/[thresholdId]/route.ts
  - src/app/api/guilds/[guildId]/groups/[groupId]/alert-settings/route.ts
  # Dashboard proxy routes - email alerts
  - src/app/api/guilds/[guildId]/email-config/route.ts
  - src/app/api/guilds/[guildId]/email-recipients/route.ts
  - src/app/api/guilds/[guildId]/email-recipients/[recipientId]/route.ts
  - src/app/api/guilds/[guildId]/email-recipients/[recipientId]/resend-verification/route.ts
  # Dashboard proxy routes - import/export
  - src/app/api/guilds/[guildId]/accounts/template/route.ts
  - src/app/api/guilds/[guildId]/accounts/import/route.ts
  - src/app/api/guilds/[guildId]/accounts/import/confirm/route.ts
autonomous: true
requirements: [ALERT-01, ALERT-02, ALERT-03, ALERT-04, IMPEX-01, IMPEX-02, IMPEX-03, IMPEX-04]

must_haves:
  truths:
    - "Backend cross-guild alert threshold endpoint returns paginated, filterable thresholds"
    - "Backend PATCH endpoint toggles individual threshold enabled state"
    - "Backend export dataType enum accepts all export types"
    - "All alert proxy routes forward requests to backend correctly"
    - "Import template/preview/confirm proxy routes forward requests correctly"
    - "TypeScript types exist for alert thresholds, email config, and import"
  artifacts:
    - path: "~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds/guildAlerts.ts"
      provides: "Cross-guild GET and per-threshold PATCH endpoints"
      contains: "alert-thresholds"
    - path: "src/types/alert.ts"
      provides: "AlertThreshold, AlertSettings, EmailConfig, EmailRecipient types"
      exports: ["AlertThreshold", "AlertSettings"]
    - path: "src/types/import.ts"
      provides: "ImportPreview, ImportProgress, ImportHistoryEntry types"
      exports: ["ImportPreview", "ImportProgress"]
    - path: "src/app/api/guilds/[guildId]/alert-thresholds/route.ts"
      provides: "Cross-guild alert threshold proxy GET"
      exports: ["GET"]
    - path: "src/app/api/guilds/[guildId]/accounts/import/confirm/route.ts"
      provides: "POST-SSE streaming proxy for import confirm"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/guilds/[guildId]/alert-thresholds/route.ts"
      to: "backend /api/v1/guilds/:guildId/alert-thresholds"
      via: "backendFetch proxy"
      pattern: "backendFetch.*alert-thresholds"
    - from: "src/app/api/guilds/[guildId]/accounts/import/confirm/route.ts"
      to: "backend /api/v1/guilds/:guildId/accounts/import/confirm"
      via: "POST-SSE streaming proxy"
      pattern: "response\\.body"
---

<objective>
Fix three backend gaps, create all TypeScript types, and build all proxy API routes for alert management, email configuration, and CSV import/export.

Purpose: Establish the data layer foundation that all subsequent UI plans depend on. Without these proxy routes and types, no hooks or UI components can function.

Output: Backend endpoints fixed, type definitions created, ~14 proxy route files created.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-alert-import-management/13-RESEARCH.md

Key backend files:
@~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds/guildAlerts.ts
@~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds/guildEmailAlerts.ts
@~/Desktop/Tracking Data Bot/api/src/routes/dashboard/accounts/import.ts
@~/Desktop/Tracking Data Bot/api/src/routes/dashboard/exports.ts

Key dashboard files:
@src/types/export.ts
@src/lib/server/backend-fetch.ts
@src/lib/server/error-sanitizer.ts
@src/app/api/guilds/[guildId]/exports/route.ts (existing proxy pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix backend gaps (cross-guild endpoint, threshold toggle, export enum)</name>
  <files>
    ~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds/guildAlerts.ts
    ~/Desktop/Tracking Data Bot/api/src/routes/dashboard/exports.ts
  </files>
  <action>
  **In `guildAlerts.ts`**, add two new endpoints:

  1. **GET `/:guildId/alert-thresholds`** — Cross-guild paginated threshold list:
     - Apply `...requireDashboardGuildAuth` middleware (same pattern as existing routes)
     - Accept query params: `page` (default 1), `limit` (default 20, max 100), `groupId`, `platform`, `metricType`, `search` (for text search on group label or threshold value)
     - Build `where` clause: `{ guildId, ...(groupId && { accountGroupId: groupId }), ...(platform && { platform }), ...(metricType && { metricType }) }`
     - If `search` param exists, add case-insensitive search on `accountGroup.label` using `contains` mode
     - Use `prisma.alertThreshold.findMany` with `include: { accountGroup: { select: { id: true, label: true, discordChannelId: true, alertSettings: true } } }`, `orderBy: { createdAt: 'desc' }`, `skip`, `take: limit`
     - Also count total with `prisma.alertThreshold.count({ where })`
     - Also count active thresholds for nav badge: `prisma.alertThreshold.count({ where: { guildId, enabled: true } })`
     - Return `{ thresholds, pagination: { page, limit, total, total_pages }, active_count }`

  2. **PATCH `/:guildId/groups/:groupId/alert-thresholds/:thresholdId`** — Toggle enabled:
     - Apply `...requireDashboardGuildAuth, requireGuildAdmin, dashboardIdempotency` middleware
     - Validate body with `z.object({ enabled: z.boolean() })`
     - `findFirst` the threshold by `{ id: thresholdId, accountGroupId: groupId, guildId }` — 404 if not found
     - `update` with `{ enabled: parsed.data.enabled }`
     - Return `{ threshold: updated }`
     - Write to `DashboardAuditLog` with action `alertThreshold.toggle` and changes `{ enabled: { old, new } }`

  **In `exports.ts`**, find the `createExportSchema` Zod schema and extend `dataType` from `z.enum(['accounts', 'posts'])` to `z.enum(['accounts', 'posts', 'metrics', 'analytics', 'audit', 'gdpr'])`. This matches the full `ExportType` union in `shared/src/lib/exports/exportTypes.ts`.

  Run TypeScript check: `npx tsc --noEmit -p "/Users/gabrielleal/Desktop/Tracking Data Bot/api/tsconfig.json"` to verify no type errors.
  </action>
  <verify>
  Run `npx tsc --noEmit -p "/Users/gabrielleal/Desktop/Tracking Data Bot/api/tsconfig.json"` — passes with no errors.
  Grep for `alert-thresholds` in guildAlerts.ts confirms both new routes exist.
  Grep for `'metrics', 'analytics', 'audit', 'gdpr'` in exports.ts confirms enum extended.
  </verify>
  <done>
  Backend has: (1) GET cross-guild alert-thresholds with pagination/filters, (2) PATCH individual threshold toggle with audit logging, (3) export dataType enum includes all 6 types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript type definitions for alerts and imports</name>
  <files>
    src/types/alert.ts
    src/types/import.ts
    src/types/export.ts
  </files>
  <action>
  **Create `src/types/alert.ts`:**
  ```typescript
  // Alert threshold types
  export type MetricType = 'views' | 'likes' | 'comments' | 'shares' | 'followers'
  export type Platform = 'instagram' | 'tiktok' | 'youtube' | 'x' | 'facebook'

  export interface AlertThreshold {
    id: string
    guildId: string
    accountGroupId: string
    metricType: MetricType
    platform: Platform | null  // null = all platforms
    thresholdValue: number
    enabled: boolean
    lastTriggered: string | null
    createdAt: string
    updatedAt: string
    accountGroup: {
      id: string
      label: string
      discordChannelId: string | null
      alertSettings: AlertSettings | null
    }
  }

  export interface AlertSettings {
    id: string
    accountGroupId: string
    streakAlerts: boolean
    thresholdAlerts: boolean
    statusAlerts: boolean
    updatedAt: string
  }

  export interface ThresholdFilters {
    groupId?: string
    platform?: string
    metricType?: string
    search?: string
  }

  export interface ThresholdPage {
    thresholds: AlertThreshold[]
    pagination: {
      page: number
      limit: number
      total: number
      total_pages: number
    }
    active_count: number
  }

  export interface CreateThresholdRequest {
    metricType: MetricType
    platform: Platform | null
    thresholdValue: number
    accountGroupId: string
  }

  // Email alert types
  export interface EmailConfig {
    id: string
    guildId: string
    deliveryMode: 'immediate' | 'digest'
    digestHour: number | null  // UTC hour 0-23
    rateLimit: number  // emails per hour per recipient
    updatedAt: string
  }

  export interface EmailRecipient {
    id: string
    email: string  // masked: "abc***@domain.com"
    verified: boolean
    verificationExpired: boolean
    createdAt: string
  }

  export interface EmailConfigResponse {
    config: EmailConfig
    recipients: EmailRecipient[]
    maxRecipients: number
  }
  ```

  **Create `src/types/import.ts`:**
  ```typescript
  export interface ImportValidationError {
    row: number
    column: string
    message: string
    value: string
  }

  export interface ImportPreview {
    totalRows: number
    validRows: number
    invalidRows: number
    errors: ImportValidationError[]
    preview: ImportPreviewRow[]
    importId: string
  }

  export interface ImportPreviewRow {
    row: number
    username: string
    platform: string
    brand: string
    group: string
    valid: boolean
    errors: string[]
  }

  export type ImportProgressEventType = 'progress' | 'complete' | 'error'

  export interface ImportProgressEvent {
    type: ImportProgressEventType
    processed: number
    total: number
    percentage: number
    message?: string
    result?: ImportResult
  }

  export interface ImportResult {
    imported: number
    skipped: number
    failed: number
    errors: string[]
  }

  export interface ImportHistoryEntry {
    id: string
    filename: string
    rowCount: number
    importedCount: number
    status: 'completed' | 'failed' | 'partial'
    createdAt: string
    createdBy: string
  }
  ```

  **Update `src/types/export.ts`:**
  - Extend `ExportRequest.dataType` from `'accounts' | 'posts'` to `'accounts' | 'posts' | 'metrics' | 'analytics' | 'audit' | 'gdpr'`
  - Extend `ExportRecord.dataType` to the same union type
  - Add `export type ExportDataType = 'accounts' | 'posts' | 'metrics' | 'analytics' | 'audit' | 'gdpr'` as a named type used in both

  Run `npx tsc --noEmit` from the dashboard root to verify no type errors.
  </action>
  <verify>
  `npx tsc --noEmit` from dashboard root passes.
  Files exist: `src/types/alert.ts`, `src/types/import.ts`.
  `src/types/export.ts` includes all 6 data types.
  </verify>
  <done>
  TypeScript types for AlertThreshold, AlertSettings, EmailConfig, EmailRecipient, ImportPreview, ImportProgressEvent, ImportResult exist. ExportRequest.dataType includes all 6 export types.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create all proxy API routes for alerts, email config, and imports</name>
  <files>
    src/app/api/guilds/[guildId]/alert-thresholds/route.ts
    src/app/api/guilds/[guildId]/groups/[groupId]/alert-thresholds/route.ts
    src/app/api/guilds/[guildId]/groups/[groupId]/alert-thresholds/[thresholdId]/route.ts
    src/app/api/guilds/[guildId]/groups/[groupId]/alert-settings/route.ts
    src/app/api/guilds/[guildId]/email-config/route.ts
    src/app/api/guilds/[guildId]/email-recipients/route.ts
    src/app/api/guilds/[guildId]/email-recipients/[recipientId]/route.ts
    src/app/api/guilds/[guildId]/email-recipients/[recipientId]/resend-verification/route.ts
    src/app/api/guilds/[guildId]/accounts/template/route.ts
    src/app/api/guilds/[guildId]/accounts/import/route.ts
    src/app/api/guilds/[guildId]/accounts/import/confirm/route.ts
  </files>
  <action>
  Create all proxy routes following the established `backendFetch` + `sanitizeError` + `internalError` pattern from existing routes (e.g., `src/app/api/guilds/[guildId]/exports/route.ts`).

  **Alert proxy routes:**

  1. `alert-thresholds/route.ts` — GET handler: Forward to `GET /api/v1/guilds/${guildId}/alert-thresholds${url.search}`. Pass through all query params (page, limit, groupId, platform, metricType, search).

  2. `groups/[groupId]/alert-thresholds/route.ts` — GET + POST handlers:
     - GET: Forward to `GET /api/v1/guilds/${guildId}/groups/${groupId}/alert-thresholds${url.search}`
     - POST: Forward JSON body to `POST /api/v1/guilds/${guildId}/groups/${groupId}/alert-thresholds`

  3. `groups/[groupId]/alert-thresholds/[thresholdId]/route.ts` — DELETE + PATCH handlers:
     - DELETE: Forward to `DELETE /api/v1/guilds/${guildId}/groups/${groupId}/alert-thresholds/${thresholdId}`
     - PATCH: Forward JSON body to `PATCH /api/v1/guilds/${guildId}/groups/${groupId}/alert-thresholds/${thresholdId}`

  4. `groups/[groupId]/alert-settings/route.ts` — PATCH handler:
     - Forward JSON body to `PATCH /api/v1/guilds/${guildId}/groups/${groupId}/alert-settings`

  **Email config proxy routes:**

  5. `email-config/route.ts` — GET + PUT handlers:
     - GET: Forward to `GET /api/v1/guilds/${guildId}/email-alerts/config`
     - PUT: Forward JSON body to `PUT /api/v1/guilds/${guildId}/email-alerts/config`

  6. `email-recipients/route.ts` — POST handler:
     - Forward JSON body to `POST /api/v1/guilds/${guildId}/email-alerts/recipients`

  7. `email-recipients/[recipientId]/route.ts` — DELETE handler:
     - Forward to `DELETE /api/v1/guilds/${guildId}/email-alerts/recipients/${recipientId}`

  8. `email-recipients/[recipientId]/resend-verification/route.ts` — POST handler:
     - Forward to `POST /api/v1/guilds/${guildId}/email-alerts/recipients/${recipientId}/resend-verification`

  **Import proxy routes:**

  9. `accounts/template/route.ts` — GET handler:
     - Forward to `GET /api/v1/guilds/${guildId}/accounts/template`
     - **Important:** This returns a CSV file stream. Pipe the response body directly to client with `Content-Type: text/csv` and preserve `Content-Disposition` header from backend response.

  10. `accounts/import/route.ts` — POST handler:
      - Forward multipart form data to `POST /api/v1/guilds/${guildId}/accounts/import`
      - Use `request.arrayBuffer()` to get the raw body, then pass it to backend with the original Content-Type header (including boundary)
      - Return the JSON validation preview response

  11. `accounts/import/confirm/route.ts` — POST handler:
      - **POST-SSE streaming proxy:** Forward JSON body to `POST /api/v1/guilds/${guildId}/accounts/import/confirm`
      - If backend response is NOT ok, parse JSON and return sanitized error
      - If ok, return `new NextResponse(response.body, { headers: { 'Content-Type': 'text/event-stream', 'Cache-Control': 'no-cache', 'Connection': 'keep-alive' } })`
      - This pipes the SSE stream directly from backend to client

  All routes must:
  - Extract `auth_token` from cookies, return 401 if missing
  - Use `backendFetch()` for backend communication
  - Use `sanitizeError()` and `internalError()` for error handling
  - Use `await params` pattern for dynamic route params (Next.js 15+ convention used in this codebase)

  Run `npx tsc --noEmit` to verify no type errors.
  </action>
  <verify>
  `npx tsc --noEmit` from dashboard root passes.
  All 11 route files exist in their correct directories.
  Each route file imports `backendFetch`, `sanitizeError`, `internalError`.
  </verify>
  <done>
  All proxy API routes created: 1 cross-guild alerts GET, 2 per-group alert CRUD routes, 1 alert settings PATCH, 4 email config routes, 1 template GET with CSV streaming, 1 import POST with multipart forwarding, 1 import confirm POST-SSE streaming proxy.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit -p "/Users/gabrielleal/Desktop/Tracking Data Bot/api/tsconfig.json"` passes (backend)
- `npx tsc --noEmit` passes (dashboard)
- All type files have correct exports
- All proxy routes follow existing pattern (backendFetch + sanitizeError + internalError)
- POST-SSE import confirm route streams response body correctly
- Template route preserves Content-Disposition header
</verification>

<success_criteria>
1. Backend has cross-guild GET alert-thresholds endpoint with pagination and filters
2. Backend has PATCH threshold toggle endpoint with audit logging
3. Backend export schema accepts all 6 data types
4. Dashboard has TypeScript types for alerts, email config, imports, and expanded exports
5. All 11 proxy routes created and TypeScript-clean
6. Import confirm proxy correctly streams SSE from POST response
</success_criteria>

<output>
After completion, create `.planning/phases/13-alert-import-management/13-01-SUMMARY.md`
</output>
