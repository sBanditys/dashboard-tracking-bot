---
phase: 08-polish-optimization
plan: 06
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx
  - src/components/bulk/selection-bar.tsx
  - src/components/tracking/account-card.tsx
  - src/components/tracking/post-card.tsx
autonomous: true

must_haves:
  truths:
    - "Analytics page lazy-loads Recharts components (not in initial bundle)"
    - "Discord avatars use Next.js Image with lazy loading and proper sizing"
    - "Bulk operations are capped at 100 items per operation"
    - "Loaded count shown as 'X accounts' style without total server count"
  artifacts:
    - path: "src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx"
      provides: "Analytics page with dynamic imports for chart components"
      contains: "dynamic"
    - path: "src/components/bulk/selection-bar.tsx"
      provides: "SelectionBar with 100-item cap enforcement"
      contains: "100"
  key_links:
    - from: "src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx"
      to: "src/components/analytics/analytics-chart.tsx"
      via: "dynamic import"
      pattern: "dynamic"
---

<objective>
Add code splitting for analytics (Recharts), optimize avatar loading, enforce bulk operation cap at 100 items, and ensure proper loaded count display.

Purpose: Reduce initial bundle size, improve perceived performance for image-heavy pages, and enforce sensible limits on bulk operations.
Output: Lazy-loaded analytics, optimized avatars, enforced bulk limits.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-optimization/08-RESEARCH.md
@.planning/phases/08-polish-optimization/08-01-SUMMARY.md

@src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx
@src/components/bulk/selection-bar.tsx
@src/components/tracking/account-card.tsx
@src/components/tracking/post-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Code splitting for analytics and avatar optimization</name>
  <files>
    src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx
    src/components/tracking/account-card.tsx
    src/components/tracking/post-card.tsx
  </files>
  <action>
    1. **Code splitting for Analytics page**:
       - Import `dynamic` from 'next/dynamic'
       - Replace static imports of heavy Recharts-using components with dynamic imports:
         - `const AnalyticsChart = dynamic(() => import('@/components/analytics/analytics-chart'), { loading: () => <AnalyticsChartSkeleton />, ssr: false })`
         - `const WeeklySubmissions = dynamic(() => import('@/components/analytics/weekly-submissions'), { loading: () => <AnalyticsChartSkeleton />, ssr: false })`
       - Keep non-Recharts components (CounterCard, TimeRangeSelector, Leaderboard, ActivityTimeline) as static imports
       - The `ssr: false` prevents Recharts from rendering during SSR (it uses browser APIs)
       - Ensure the dynamic components have default exports (check current files - if they use named exports, either switch to default or use `dynamic(() => import('...').then(mod => mod.ComponentName))`)

    2. **Avatar optimization in AccountCard**:
       - If AccountCard currently uses `<img>` for Discord avatars, replace with Next.js `<Image>` component
       - Set: width={48}, height={48}, loading="lazy", className for rounded-full
       - Add placeholder="blur" with a blurDataURL (a small base64 purple/gray circle placeholder)
       - Generate blurDataURL as a static string constant: a 1x1 or tiny base64 PNG in the accent-purple color
       - If avatar URL is null/undefined, show fallback initials or default avatar
       - Do the same for any avatar in PostCard if applicable

    3. **Avatar optimization in PostCard** (if it shows avatars):
       - Same pattern as AccountCard: Next.js Image, lazy loading, blur placeholder
       - If PostCard doesn't show avatars, skip this file

    Note: Next.js Image requires the domain to be configured in next.config.mjs — cdn.discordapp.com is already configured.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Analytics page uses dynamic() for chart components
    - AccountCard uses Next.js Image for avatars (if it had img tags before)
    - `npm run build` shows analytics chunk is separate
  </verify>
  <done>
    Analytics page lazy-loads Recharts components (separate bundle chunk). Discord avatars use Next.js Image with lazy loading and blur-up placeholders.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce bulk operation cap and loaded count display</name>
  <files>
    src/components/bulk/selection-bar.tsx
  </files>
  <action>
    1. **Bulk operation cap at 100 items**:
       - In SelectionBar, when the selected count exceeds 100, disable action buttons (delete, reassign, export)
       - Show a warning message: "Select up to 100 items for bulk operations"
       - Or better: allow selection of any number but when an action is triggered, show toast.error("Select up to 100 items") if count > 100
       - Import `{ toast }` from 'sonner' for the warning
       - The cap should be enforced at the UI layer (prevent sending > 100 IDs to the API)

    2. **Loaded count in SelectionBar**:
       - If SelectionBar already shows selected count (e.g., "3 selected"), keep that
       - The loaded count display ("50 accounts") should be near the filter bar area, not in the selection bar
       - This was handled in Plan 05 — verify it's working and consistent

    3. Add a `MAX_BULK_ITEMS = 100` constant at the top of the file for clarity
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - SelectionBar enforces 100-item cap with clear messaging
    - Attempting to trigger bulk action with > 100 selected shows warning
  </verify>
  <done>
    Bulk operations capped at 100 items with clear user feedback. Selection bar shows appropriate warning when limit exceeded.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Analytics page uses dynamic imports for Recharts components
- Avatar images use Next.js Image component with lazy loading
- Bulk operations enforce 100-item cap
</verification>

<success_criteria>
- Recharts components load on demand (not in initial bundle)
- Discord avatars lazy load with blur-up placeholder
- Bulk operations refuse to execute with > 100 items selected
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-optimization/08-06-SUMMARY.md`
</output>
