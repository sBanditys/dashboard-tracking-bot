---
phase: 06-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/analytics.ts
  - src/hooks/use-analytics.ts
  - src/app/api/guilds/[guildId]/analytics/route.ts
  - src/app/api/guilds/[guildId]/analytics/leaderboard/route.ts
  - src/app/api/guilds/[guildId]/analytics/activity/route.ts
autonomous: true

must_haves:
  truths:
    - "Analytics data hooks return counter, time-series, leaderboard, and activity data"
    - "Three API proxy routes forward requests to backend with auth"
    - "Analytics types are defined and exported for use by components"
  artifacts:
    - path: "src/types/analytics.ts"
      provides: "Analytics type definitions"
      contains: "AnalyticsData"
    - path: "src/hooks/use-analytics.ts"
      provides: "useAnalytics, useAnalyticsLeaderboard, useAnalyticsActivity hooks"
      exports: ["useAnalytics", "useAnalyticsLeaderboard", "useAnalyticsActivity"]
    - path: "src/app/api/guilds/[guildId]/analytics/route.ts"
      provides: "Main analytics proxy route"
      exports: ["GET"]
  key_links:
    - from: "src/hooks/use-analytics.ts"
      to: "/api/guilds/[guildId]/analytics"
      via: "fetch in useQuery"
      pattern: "fetch.*api/guilds.*analytics"
    - from: "src/app/api/guilds/[guildId]/analytics/route.ts"
      to: "backend API"
      via: "fetch with Bearer token"
      pattern: "Authorization.*Bearer"
---

<objective>
Install Recharts, define analytics types, create API proxy routes, and build data-fetching hooks for the analytics system.

Purpose: Establish the data layer foundation that all analytics UI components will consume. Backend endpoints are assumed to exist (or will be added separately) — this plan wires the dashboard proxy and hooks.
Output: Types, hooks, and API proxy routes ready for Wave 2 component development.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference existing patterns:
@src/app/api/guilds/[guildId]/usage/route.ts (API proxy pattern)
@src/app/api/guilds/[guildId]/audit-log/route.ts (API proxy with query forwarding)
@src/hooks/use-guilds.ts (useQuery/useInfiniteQuery patterns)
@src/hooks/use-audit-log.ts (paginated query pattern)
@src/types/guild.ts (type definition patterns)
@src/types/tracking.ts (Pagination type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and create analytics types</name>
  <files>package.json, src/types/analytics.ts</files>
  <action>
    1. Install recharts: `npm install recharts`

    2. Create `src/types/analytics.ts` with these types:

    ```typescript
    // Time range type used across all analytics
    export type TimeRange = 7 | 30 | 90

    // Main analytics response (counters + time-series)
    export interface AnalyticsData {
      counters: {
        total_accounts: number
        total_posts: number
        total_brands: number
        by_platform: Record<string, number>
      }
      previous_period: {
        total_accounts: number
        total_posts: number
        total_brands: number
      }
      time_series: Array<{ period: string; count: number }>
      granularity: 'day' | 'week'
    }

    // Leaderboard entry
    export interface LeaderboardEntry {
      account_id: string
      username: string
      platform: string
      total_views: number
      total_likes: number
      post_count: number
    }

    export interface LeaderboardResponse {
      leaderboard: LeaderboardEntry[]
    }

    // Activity timeline event
    export interface ActivityEvent {
      id: string
      type: 'post_captured' | 'settings_changed' | 'account_added' | 'account_removed' | 'brand_added' | 'brand_removed'
      created_at: string
      actor: string
      description: string
      link: string | null
    }

    export interface ActivityResponse {
      events: ActivityEvent[]
      next_page: number | null
    }

    // Chart data point (formatted for Recharts)
    export interface ChartDataPoint {
      date: string
      count: number
      rawDate: string  // ISO date for click navigation
    }
    ```

    Keep the types aligned with the backend endpoint contracts documented in 06-RESEARCH.md.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors from analytics.ts.</verify>
  <done>Recharts installed. Analytics types exported and type-check clean.</done>
</task>

<task type="auto">
  <name>Task 2: Create API proxy routes and data hooks</name>
  <files>
    src/app/api/guilds/[guildId]/analytics/route.ts,
    src/app/api/guilds/[guildId]/analytics/leaderboard/route.ts,
    src/app/api/guilds/[guildId]/analytics/activity/route.ts,
    src/hooks/use-analytics.ts
  </files>
  <action>
    1. Create `src/app/api/guilds/[guildId]/analytics/route.ts` — GET proxy:
       - Follow exact pattern from `src/app/api/guilds/[guildId]/usage/route.ts`
       - Forward `range` query param (default '30')
       - Proxy to `${API_URL}/api/v1/guilds/${guildId}/analytics?range=${range}`
       - Include Bearer token and optional X-API-Key header

    2. Create `src/app/api/guilds/[guildId]/analytics/leaderboard/route.ts` — GET proxy:
       - Forward `range` and `limit` query params
       - Proxy to `${API_URL}/api/v1/guilds/${guildId}/analytics/leaderboard?range=${range}&limit=${limit}`

    3. Create `src/app/api/guilds/[guildId]/analytics/activity/route.ts` — GET proxy:
       - Forward `page` and `limit` query params
       - Proxy to `${API_URL}/api/v1/guilds/${guildId}/analytics/activity?page=${page}&limit=${limit}`

    4. Create `src/hooks/use-analytics.ts` with three hooks:

    **useAnalytics(guildId, range):**
    - queryKey: `['guild', guildId, 'analytics', range]`
    - Fetch from `/api/guilds/${guildId}/analytics?range=${range}`
    - staleTime: 5 * 60 * 1000 (5 minutes — analytics don't change rapidly)
    - Returns `AnalyticsData`
    - enabled: `!!guildId`

    **useAnalyticsLeaderboard(guildId, range, limit):**
    - queryKey: `['guild', guildId, 'analytics', 'leaderboard', range, limit]`
    - Fetch from `/api/guilds/${guildId}/analytics/leaderboard?range=${range}&limit=${limit}`
    - staleTime: 5 * 60 * 1000
    - Returns `LeaderboardResponse`
    - enabled: `!!guildId`

    **useAnalyticsActivity(guildId):**
    - Use `useInfiniteQuery` (consistent with tracking pages pattern)
    - queryKey: `['guild', guildId, 'analytics', 'activity']`
    - Fetch from `/api/guilds/${guildId}/analytics/activity?page=${pageParam}&limit=50`
    - initialPageParam: 1
    - getNextPageParam: `(lastPage) => lastPage.next_page`
    - staleTime: 60 * 1000 (1 minute — activity changes more often)
    - maxPages: 10 (prevent memory bloat per research pitfall 3)
    - enabled: `!!guildId`

    Import from `@tanstack/react-query` and `@/types/analytics`. Add `'use client'` at top.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify hooks export with `grep -n "export function" src/hooks/use-analytics.ts`.</verify>
  <done>Three API proxy routes forward requests to backend. Three hooks (useAnalytics, useAnalyticsLeaderboard, useAnalyticsActivity) fetch and cache analytics data.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `src/types/analytics.ts` exports AnalyticsData, LeaderboardResponse, ActivityResponse, TimeRange types
- `src/hooks/use-analytics.ts` exports useAnalytics, useAnalyticsLeaderboard, useAnalyticsActivity
- Three API proxy route files exist under `src/app/api/guilds/[guildId]/analytics/`
- recharts appears in package.json dependencies
</verification>

<success_criteria>
Analytics foundation layer complete: types defined, hooks wired, proxy routes ready. Components can import and use these in Wave 2.
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics/06-01-SUMMARY.md`
</output>
