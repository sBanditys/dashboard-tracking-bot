---
phase: 05-configuration-mutations
plan: 05
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/forms/add-account-modal.tsx
  - src/components/forms/add-brand-modal.tsx
  - src/hooks/use-tracking.ts
  - src/app/api/guilds/[guildId]/accounts/route.ts
  - src/app/api/guilds/[guildId]/brands/route.ts
autonomous: true

must_haves:
  truths:
    - "User can add new tracked account and see it in the list"
    - "User can add new brand and see it in the list"
    - "Add forms validate input before submission"
  artifacts:
    - path: "src/components/forms/add-account-modal.tsx"
      provides: "Modal form to add tracked account"
      min_lines: 80
    - path: "src/components/forms/add-brand-modal.tsx"
      provides: "Modal form to add brand"
      min_lines: 60
    - path: "src/hooks/use-tracking.ts"
      provides: "useAddAccount, useAddBrand mutations"
      exports: ["useAddAccount", "useAddBrand"]
    - path: "src/app/api/guilds/[guildId]/accounts/route.ts"
      provides: "POST endpoint for accounts"
      exports: ["POST"]
    - path: "src/app/api/guilds/[guildId]/brands/route.ts"
      provides: "POST endpoint for brands"
      exports: ["POST"]
  key_links:
    - from: "src/components/forms/add-account-modal.tsx"
      to: "Headless UI Dialog"
      via: "modal component"
      pattern: "Dialog.*from.*@headlessui/react"
    - from: "src/hooks/use-tracking.ts"
      to: "queryClient.invalidateQueries"
      via: "cache invalidation on add"
      pattern: "invalidateQueries"
---

<objective>
Create modal forms for adding new tracked accounts and brands with validation.

Purpose: Implement CONF-02 (add tracked accounts/brands). Users can add new items through modal forms that validate input, submit to the API, and refresh the lists on success.

Output: AddAccountModal and AddBrandModal components using Headless UI Dialog, with useAddAccount/useAddBrand mutations in use-tracking.ts.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-mutations/05-CONTEXT.md
@.planning/phases/05-configuration-mutations/05-RESEARCH.md

# Dependencies and patterns
@src/components/ui/confirmation-modal.tsx
@src/hooks/use-tracking.ts
@src/app/api/guilds/[guildId]/accounts/route.ts
@src/types/tracking.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add POST Routes for Accounts and Brands</name>
  <files>
src/app/api/guilds/[guildId]/accounts/route.ts
src/app/api/guilds/[guildId]/brands/route.ts
  </files>
  <action>
**Update accounts/route.ts - add POST handler:**
```typescript
export async function POST(request: NextRequest, { params }: RouteParams) {
  const { guildId } = await params
  const cookieStore = await cookies()
  const token = cookieStore.get('auth_token')?.value

  if (!token) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const body = await request.json()

    const response = await fetch(
      `${API_URL}/api/v1/guilds/${guildId}/accounts`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(body),
      }
    )

    const data = await response.json()
    return NextResponse.json(data, { status: response.status })
  } catch {
    return NextResponse.json({ error: 'Failed to add account' }, { status: 500 })
  }
}
```

**Update brands/route.ts - add POST handler:**
Same pattern as accounts, forward to `${API_URL}/api/v1/guilds/${guildId}/brands`.
Error message: "Failed to add brand"
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`. Both routes export GET and POST.
  </verify>
  <done>
POST endpoints added to accounts and brands routes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Create Mutation Hooks</name>
  <files>src/hooks/use-tracking.ts</files>
  <action>
Add useAddAccount and useAddBrand mutation hooks.

**Add imports:**
```typescript
import { useQuery, useInfiniteQuery, useMutation, useQueryClient } from '@tanstack/react-query'
```

**Add request types:**
```typescript
interface AddAccountRequest {
  platform: 'instagram' | 'tiktok' | 'youtube' | 'x'
  username: string
  brand_id: string
  group_id?: string
}

interface AddBrandRequest {
  label: string
  slug?: string  // Auto-generated from label if not provided
}
```

**Add useAddAccount:**
```typescript
export function useAddAccount(guildId: string) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (account: AddAccountRequest) => {
      const response = await fetch(`/api/guilds/${guildId}/accounts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(account),
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.message || 'Failed to add account')
      }

      return response.json()
    },
    onSuccess: () => {
      // Invalidate accounts lists
      queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'accounts'] })
      // Invalidate guild details (account counts)
      queryClient.invalidateQueries({ queryKey: ['guild', guildId] })
      // Invalidate brands (account count per brand)
      queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'brands'] })
    },
  })
}
```

**Add useAddBrand:**
```typescript
export function useAddBrand(guildId: string) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (brand: AddBrandRequest) => {
      const response = await fetch(`/api/guilds/${guildId}/brands`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(brand),
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.message || 'Failed to add brand')
      }

      return response.json()
    },
    onSuccess: () => {
      // Invalidate brands list
      queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'brands'] })
      // Invalidate guild details (brand count)
      queryClient.invalidateQueries({ queryKey: ['guild', guildId] })
    },
  })
}
```
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`. Hooks are exported from use-tracking.ts.
  </verify>
  <done>
useAddAccount and useAddBrand mutation hooks added with cache invalidation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Add Account and Add Brand Modals</name>
  <files>
src/components/forms/add-account-modal.tsx
src/components/forms/add-brand-modal.tsx
  </files>
  <action>
**Create add-account-modal.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { Dialog, DialogPanel, DialogTitle } from '@headlessui/react'
import { useAddAccount } from '@/hooks/use-tracking'
import { useBrands } from '@/hooks/use-tracking'
import { cn } from '@/lib/utils'

interface AddAccountModalProps {
  open: boolean
  onClose: () => void
  guildId: string
}

const platforms = [
  { value: 'instagram', label: 'Instagram' },
  { value: 'tiktok', label: 'TikTok' },
  { value: 'youtube', label: 'YouTube' },
  { value: 'x', label: 'X (Twitter)' },
] as const

export function AddAccountModal({ open, onClose, guildId }: AddAccountModalProps) {
  const [platform, setPlatform] = useState<typeof platforms[number]['value']>('instagram')
  const [username, setUsername] = useState('')
  const [brandId, setBrandId] = useState('')
  const [error, setError] = useState('')

  const { data: brandsData } = useBrands(guildId)
  const mutation = useAddAccount(guildId)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')

    // Validation
    if (!username.trim()) {
      setError('Username is required')
      return
    }
    if (!brandId) {
      setError('Please select a brand')
      return
    }

    try {
      await mutation.mutateAsync({
        platform,
        username: username.trim().replace('@', ''), // Remove @ if present
        brand_id: brandId,
      })
      // Reset form and close on success
      setUsername('')
      setBrandId('')
      setPlatform('instagram')
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to add account')
    }
  }

  return (
    <Dialog open={open} onClose={onClose} className="relative z-50">
      <div className="fixed inset-0 bg-black/60" aria-hidden="true" />
      <div className="fixed inset-0 flex items-center justify-center p-4">
        <DialogPanel className="max-w-md w-full bg-surface border border-border rounded-lg p-6">
          <DialogTitle className="text-lg font-semibold text-white mb-4">
            Add Tracked Account
          </DialogTitle>

          <form onSubmit={handleSubmit} className="space-y-4">
            {/* Platform Select */}
            <div>
              <label className="block text-sm font-medium text-gray-400 mb-2">Platform</label>
              <select
                value={platform}
                onChange={(e) => setPlatform(e.target.value as typeof platform)}
                className="w-full py-3 px-3 bg-surface border border-border rounded-lg text-sm text-gray-300"
              >
                {platforms.map((p) => (
                  <option key={p.value} value={p.value}>{p.label}</option>
                ))}
              </select>
            </div>

            {/* Username Input */}
            <div>
              <label className="block text-sm font-medium text-gray-400 mb-2">Username</label>
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                placeholder="@username"
                className="w-full py-3 px-3 bg-surface border border-border rounded-lg text-sm text-gray-300 placeholder:text-gray-500"
              />
            </div>

            {/* Brand Select */}
            <div>
              <label className="block text-sm font-medium text-gray-400 mb-2">Brand</label>
              <select
                value={brandId}
                onChange={(e) => setBrandId(e.target.value)}
                className="w-full py-3 px-3 bg-surface border border-border rounded-lg text-sm text-gray-300"
              >
                <option value="">Select a brand...</option>
                {brandsData?.brands.map((brand) => (
                  <option key={brand.id} value={brand.id}>{brand.label}</option>
                ))}
              </select>
            </div>

            {/* Error Display */}
            {error && (
              <p className="text-sm text-red-400">{error}</p>
            )}

            {/* Actions */}
            <div className="flex gap-3 justify-end pt-2">
              <button
                type="button"
                onClick={onClose}
                className="px-4 py-2 text-sm text-gray-300 hover:text-white transition-colors"
              >
                Cancel
              </button>
              <button
                type="submit"
                disabled={mutation.isPending}
                className="px-4 py-2 text-sm bg-accent-purple hover:bg-accent-purple/80 text-white rounded-lg transition-colors disabled:opacity-50"
              >
                {mutation.isPending ? 'Adding...' : 'Add Account'}
              </button>
            </div>
          </form>
        </DialogPanel>
      </div>
    </Dialog>
  )
}
```

**Create add-brand-modal.tsx:**
Similar structure but simpler form:
- Fields: label (required), slug (optional, auto-generated)
- Use useAddBrand mutation
- Validate label is not empty
- On success, reset form and close
  </action>
  <verify>
Files exist. TypeScript compilation passes: `npx tsc --noEmit`. Directory src/components/forms/ exists.
  </verify>
  <done>
AddAccountModal and AddBrandModal components created with form validation and mutations.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. POST routes exist in accounts/route.ts and brands/route.ts
3. useAddAccount and useAddBrand hooks are importable
4. Modal components render forms with validation
5. Successful submission closes modal and invalidates caches
</verification>

<success_criteria>
- POST endpoints added to accounts and brands routes
- useAddAccount and useAddBrand mutation hooks with cache invalidation
- AddAccountModal with platform select, username input, brand select, validation
- AddBrandModal with label input, slug (optional), validation
- Forms reset and close on successful submission
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-mutations/05-05-SUMMARY.md`
</output>
