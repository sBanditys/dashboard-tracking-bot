---
phase: 18-sse-lifecycle-hardening
plan: 02
type: execute
wave: 2
depends_on: [18-01]
files_modified:
  - src/hooks/use-guilds.ts
autonomous: true
requirements: [SSE-04]

must_haves:
  truths:
    - "Polling only activates when connectionState is 'error' (retries exhausted), not during transient reconnects or disconnected states"
    - "While SSE is in 'connecting', 'reconnecting', or 'connected' state, no refetchInterval polling occurs"
  artifacts:
    - path: "src/hooks/use-guilds.ts"
      provides: "Tightened refetchInterval gate using connectionState === 'error'"
      contains: "connectionState === 'error'"
  key_links:
    - from: "src/hooks/use-guilds.ts"
      to: "src/hooks/use-sse.ts"
      via: "connectionState value from useSSE via useGuildStatusRealtime"
      pattern: "connectionState"
---

<objective>
Tighten the `refetchInterval` gate in `useGuildStatusRealtime` to only fire polling when `connectionState === 'error'` (retries exhausted), preventing polling/SSE race conditions during transient reconnects.

Purpose: Currently `refetchInterval` uses `isSSEConnected ? false : 60000` which enables polling during `'connecting'`, `'reconnecting'`, and `'disconnected'` states. This causes redundant API calls during transient reconnects and race conditions between polling and SSE. The fix gates polling to the terminal `'error'` state only.

Output: Updated `useGuildStatusRealtime` hook with precise polling gate.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-sse-lifecycle-hardening/18-RESEARCH.md
@.planning/phases/18-sse-lifecycle-hardening/18-01-SUMMARY.md
@src/hooks/use-guilds.ts
@src/hooks/use-sse.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate refetchInterval on connectionState === 'error' and clean up isSSEConnected</name>
  <files>src/hooks/use-guilds.ts</files>
  <action>
In `useGuildStatusRealtime()` function in `src/hooks/use-guilds.ts`:

**1. Remove the `isSSEConnected` boolean:**
Delete the line:
```typescript
const isSSEConnected = connectionState === 'connected'
```
This boolean loses precision — `!isSSEConnected` is true for all non-connected states including transient reconnects.

**2. Replace the refetchInterval value:**
Change from:
```typescript
refetchInterval: isSSEConnected ? false : 60 * 1000,
```
To:
```typescript
refetchInterval: connectionState === 'error' ? 60_000 : false,
```

This ensures:
- `'connecting'` → no polling (initial connection in progress)
- `'reconnecting'` → no polling (stall recovery in progress, Plan 18-01 introduced this state)
- `'connected'` → no polling (SSE is delivering data)
- `'disconnected'` → no polling (grace period active or about to reconnect on tab return)
- `'error'` → poll every 60s (retries exhausted, SSE is dead, polling is the only fallback)

The simple inline expression works correctly in TanStack Query v5 because the `useQuery` call re-evaluates on every render when `connectionState` changes (verified in research). No callback form needed.

**3. Verify no other consumers of `isSSEConnected`:**
Search the file for any other usage of `isSSEConnected`. If found elsewhere in the return value or destructuring, remove or replace as appropriate. The return object already exposes `connectionState` directly — consumers that need connection info should use the full state.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify `isSSEConnected` variable no longer exists in use-guilds.ts. Verify `refetchInterval` line contains `connectionState === 'error' ? 60_000 : false`. Search entire src/ directory for any remaining references to `isSSEConnected` — should find none.
  </verify>
  <done>
refetchInterval polling only activates when connectionState is 'error' (retries fully exhausted). Transient reconnects ('connecting', 'reconnecting', 'disconnected') do not trigger polling. The imprecise `isSSEConnected` boolean is removed in favor of direct connectionState comparison. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `isSSEConnected` variable does not exist in use-guilds.ts
3. `refetchInterval` uses `connectionState === 'error' ? 60_000 : false`
4. No references to `isSSEConnected` exist anywhere in src/
5. `connectionState` is still exposed in the return value of `useGuildStatusRealtime`
</verification>

<success_criteria>
- Polling fires only when connectionState === 'error' (retries exhausted)
- No polling during 'connecting', 'reconnecting', 'connected', or 'disconnected' states
- TypeScript compiles cleanly
- No stale isSSEConnected boolean remains in the codebase
</success_criteria>

<output>
After completion, create `.planning/phases/18-sse-lifecycle-hardening/18-02-SUMMARY.md`
</output>
