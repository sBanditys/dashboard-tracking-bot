---
milestone: v1.1
audited: 2026-02-22T17:01:35Z
status: gaps_found
scores:
  requirements: 22/24
  phases: 7/7
  integration: 46/47
  flows: 8/11
gaps:
  requirements:
    - id: "AUTH-03"
      status: "unsatisfied"
      phase: "Phase 15"
      claimed_by_plans: ["15-01-PLAN.md", "14-01-PLAN.md", "10-01-PLAN.md"]
      completed_by_plans: ["15-01-SUMMARY.md", "15-02-SUMMARY.md", "14-01-SUMMARY.md"]
      verification_status: "passed (regressed by post-verification commit 2feb03e)"
      evidence: "src/middleware.ts renamed to src/proxy.ts and export function renamed from middleware to proxy. Next.js requires MIDDLEWARE_FILENAME='middleware' (node_modules/next/dist/lib/constants.js:272). Middleware never executes → _csrf_token cookie never set → CSRF validation never runs."
    - id: "AUTH-04"
      status: "unsatisfied"
      phase: "Phase 15"
      claimed_by_plans: ["15-01-PLAN.md", "10-03-PLAN.md"]
      completed_by_plans: ["15-01-SUMMARY.md", "15-02-SUMMARY.md"]
      verification_status: "passed (regressed by post-verification commit 2feb03e)"
      evidence: "Same root cause as AUTH-03. security-headers.ts utility is correct and imported in proxy.ts, but proxy.ts never executes as Next.js middleware → no Content-Security-Policy header on any page response."
  integration:
    - "proxy.ts → middleware.ts regression: commit 2feb03e renamed middleware.ts back to proxy.ts and function export from middleware to proxy, breaking all middleware-dependent features"
  flows:
    - "CSRF double-submit flow: _csrf_token cookie never issued → fetchWithRetry getCsrfToken() returns undefined → X-CSRF-Token header never attached → no CSRF protection active"
    - "CSP header injection flow: nonce generation, buildCspHeader(), getSecurityHeaders() all exist but never execute → no CSP on any page response"
    - "Auth redirect chain: middleware should redirect unauthenticated /guilds/* and /settings requests to /?returnTo=... → never fires → unauthenticated users receive page HTML"
tech_debt:
  - phase: 12-bonus-system
    items:
      - "Empty-state 'Create Round' button is no-op in rounds-tab.tsx (line 108-110) — admin can create via header button"
      - "existingWeekStarts={[]} always empty in page.tsx (line 67) — backend rejects duplicate week_start with 409"
  - phase: 13-alert-import-management
    items:
      - "Stale comment in data/page.tsx line 23 — says 'placeholder' but ExportTab is fully rendered"
      - "import-history.tsx shows placeholder when entries array empty — no import history API endpoint yet (intentional)"
  - phase: 09-authentication-security
    items:
      - "SUMMARY.md frontmatter missing requirements-completed field (documentation gap, not functional)"
  - phase: 10-frontend-security-hardening
    items:
      - "SUMMARY.md frontmatter missing requirements-completed field (documentation gap, not functional)"
  - phase: 11-session-management
    items:
      - "SUMMARY.md frontmatter missing requirements-completed field (documentation gap, not functional)"
---

# v1.1 Milestone Audit: Security Hardening & Backend Alignment

**Audited:** 2026-02-22T17:01:35Z
**Status:** GAPS FOUND
**Score:** 22/24 requirements satisfied

## Milestone Definition of Done

> Harden authentication and security layers, fix session persistence, block unverified accounts, and deliver complete UI for bonus system, alert management, session management, and account import/export.

## Phase Verification Summary

| Phase | Name | VERIFICATION Status | Score | Requirements |
|-------|------|---------------------|-------|-------------|
| 09 | Authentication Security | passed | 4/4 | AUTH-01, AUTH-02, AUTH-06 |
| 10 | Frontend Security Hardening | passed | 11/11 | AUTH-03*, AUTH-04*, AUTH-05 |
| 11 | Session Management | passed | 4/4 | SESS-01, SESS-02, SESS-03 |
| 12 | Bonus System | passed | 7/7 | BONUS-01 through BONUS-07 |
| 13 | Alert & Import Management | passed | 20/20 | ALERT-01-04, IMPEX-01-04 |
| 14 | Fix Import Confirm CSRF Bypass | passed | 4/4 | AUTH-03*, IMPEX-04 |
| 15 | Reactivate Next.js Middleware | passed | 10/10 | AUTH-03*, AUTH-04* |

*\*Regressed by post-verification commit `2feb03e`*

All 7 phases have VERIFICATION.md files. No unverified phases. All phases passed at the code level. Gaps emerge from cross-phase integration checking.

## Requirements Coverage (3-Source Cross-Reference)

### Source 1: Phase VERIFICATION.md

All 24 requirements marked SATISFIED in their respective VERIFICATION.md files (BONUS-03 partially satisfied with minor empty-state UX gap).

### Source 2: SUMMARY.md Frontmatter (`requirements-completed`)

| SUMMARY | REQ-IDs |
|---------|---------|
| 12-04-SUMMARY | BONUS-07 |
| 13-01-SUMMARY | ALERT-01-04, IMPEX-01-04 |
| 13-02-SUMMARY | ALERT-01, ALERT-04, IMPEX-01-04 |
| 13-03-SUMMARY | ALERT-01-03 |
| 13-04-SUMMARY | ALERT-04 |
| 13-06-SUMMARY | IMPEX-01 |
| 14-01-SUMMARY | AUTH-03, IMPEX-04 |
| 15-01-SUMMARY | AUTH-03, AUTH-04 |
| 15-02-SUMMARY | AUTH-03, AUTH-04 |

**Missing from all SUMMARY frontmatter:** AUTH-01, AUTH-02, AUTH-05, AUTH-06, SESS-01-03, BONUS-01-06. Phases 09, 10, 11, and early 12 predate the `requirements-completed` frontmatter convention.

### Source 3: REQUIREMENTS.md Traceability

All 24 requirements marked `[x]` Complete in REQUIREMENTS.md traceability table. All mapped to phases. 0 unmapped.

### Final Status Matrix (3-Source + Integration)

| REQ-ID | VERIFICATION | SUMMARY | REQUIREMENTS | Integration | Final |
|--------|-------------|---------|--------------|-------------|-------|
| AUTH-01 | passed (P09) | missing | [x] | WIRED | **satisfied** |
| AUTH-02 | passed (P09) | missing | [x] | WIRED | **satisfied** |
| AUTH-03 | passed (P15) | listed (P14, P15) | [x] | **UNWIRED** | **UNSATISFIED** |
| AUTH-04 | passed (P15) | listed (P15) | [x] | **UNWIRED** | **UNSATISFIED** |
| AUTH-05 | passed (P10) | missing | [x] | WIRED | **satisfied** |
| AUTH-06 | passed (P09) | missing | [x] | WIRED | **satisfied** |
| SESS-01 | passed (P11) | missing | [x] | WIRED | **satisfied** |
| SESS-02 | passed (P11) | missing | [x] | WIRED | **satisfied** |
| SESS-03 | passed (P11) | missing | [x] | WIRED | **satisfied** |
| BONUS-01 | passed (P12) | missing | [x] | WIRED | **satisfied** |
| BONUS-02 | passed (P12) | missing | [x] | WIRED | **satisfied** |
| BONUS-03 | partial (P12) | missing | [x] | WIRED | **satisfied** (minor UX gap) |
| BONUS-04 | passed (P12) | missing | [x] | WIRED | **satisfied** |
| BONUS-05 | passed (P12) | missing | [x] | WIRED | **satisfied** |
| BONUS-06 | passed (P12) | missing | [x] | WIRED | **satisfied** |
| BONUS-07 | passed (P12) | listed (P12-04) | [x] | WIRED | **satisfied** |
| ALERT-01 | passed (P13) | listed (P13-01, 02, 03) | [x] | WIRED | **satisfied** |
| ALERT-02 | passed (P13) | listed (P13-01, 03) | [x] | WIRED | **satisfied** |
| ALERT-03 | passed (P13) | listed (P13-01, 03) | [x] | WIRED | **satisfied** |
| ALERT-04 | passed (P13) | listed (P13-01, 02, 04) | [x] | WIRED | **satisfied** |
| IMPEX-01 | passed (P13) | listed (P13-01, 02, 06) | [x] | WIRED | **satisfied** |
| IMPEX-02 | passed (P13) | listed (P13-01, 02) | [x] | WIRED | **satisfied** |
| IMPEX-03 | passed (P13) | listed (P13-01, 02) | [x] | WIRED | **satisfied** |
| IMPEX-04 | passed (P14) | listed (P13-01, 02, P14-01) | [x] | WIRED | **satisfied** |

**Satisfied:** 22 | **Unsatisfied:** 2 (AUTH-03, AUTH-04) | **Orphaned:** 0

## Critical Gap: Middleware Inactive (AUTH-03, AUTH-04)

### Root Cause

Commit `2feb03e` ("refactor: rename middleware.ts to proxy.ts per Next.js deprecation") was made AFTER Phase 15 completed and was verified. This commit renamed `src/middleware.ts` → `src/proxy.ts` and `export async function middleware` → `export async function proxy`.

Next.js requires `MIDDLEWARE_FILENAME = 'middleware'` (confirmed in `node_modules/next/dist/lib/constants.js` line 272). The claim in the commit message that Next.js expects `proxy.ts` is incorrect.

### Consequence Chain

1. `_csrf_token` cookie is **never set** — the only setter is in `proxy.ts` which never runs
2. CSRF validation block never executes — all mutations proceed without CSRF tokens
3. `fetchWithRetry` reads empty cookie, `getCsrfToken()` returns undefined, `X-CSRF-Token` header skipped
4. CSP headers are **never applied** to page responses — `buildCspHeader(nonce)` never runs
5. Auth redirect at SSR level does not happen — unauthenticated page requests receive HTML
6. Phase 14's fix (fetchWithRetry in useConfirmImport) is structurally correct but operationally inert

### Fix Required

```
1. Rename src/proxy.ts → src/middleware.ts
2. Change export async function proxy → export async function middleware
3. Verify _csrf_token cookie appears in browser DevTools
4. Verify Content-Security-Policy header appears on page responses
```

This single fix closes both AUTH-03 and AUTH-04 and restores all 3 broken flows.

### What Still Works (partial mitigation)

- Non-CSP security headers (X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy) ARE applied via `next.config.mjs`
- All mutations work functionally (no CSRF enforcement = no 403 errors, but also no protection)
- Backend auth enforcement via `requireDashboardAuth` middleware is still active on all API routes
- Client-side auth redirect works via `useUser()` hook

## Cross-Phase Integration

### Working Flows (8/11)

| Flow | Path | Status |
|------|------|--------|
| Session Refresh (AUTH-01) | fetchWithRetry → 401 → POST /api/auth/refresh → backend → new tokens → retry | WORKING |
| Unverified Email (AUTH-02) | Backend OAuth reject → error=unverified_email → /auth/unverified-email page | WORKING |
| Error Sanitization (AUTH-05) | error-sanitizer.ts imported in all 36+ guild/bonus/alert proxy routes | WORKING |
| SQL Audit (AUTH-06) | Prisma.sql parameterization in guilds.ts + bonus.ts | WORKING |
| Session Management (SESS-01-03) | Hooks → fetchWithRetry → proxy routes → backend → JTI revocation | WORKING |
| Bonus System (BONUS-01-07) | 7 proxy routes + 10 hooks + page + 7 components → sidebar entry | WORKING |
| Alert & Import (ALERT-01-04, IMPEX-01-04) | All routes + sanitizeError; ManageLayout admin guard; sidebar | WORKING |
| Import Confirm (IMPEX-04) | fetchWithRetry POST-SSE → proxy route → backend SSE → progress bar | WORKING |

### Broken Flows (3/11)

| Flow | Broken At | Affected REQs |
|------|-----------|---------------|
| CSRF Double-Submit | Cookie issuance — middleware inactive, `_csrf_token` never set | AUTH-03 |
| CSP Headers on Pages | Header injection — middleware inactive, CSP never applied | AUTH-04 |
| Auth Redirect Chain | SSR-level redirect — middleware never intercepts unauthenticated page requests | AUTH-03, AUTH-04 |

### Integration Wiring

- **47/47** phase exports properly consumed across phases
- **0** orphaned exports
- **28** new API routes all have callers
- **1** broken connection: proxy.ts ↔ Next.js middleware system

## Tech Debt Summary

| Phase | Items | Severity |
|-------|-------|----------|
| 12 | Empty-state "Create Round" button no-op; always-empty existingWeekStarts | Low |
| 13 | Stale "placeholder" comment; import history empty state (intentional) | Low |
| 09, 10, 11 | SUMMARY.md frontmatter missing `requirements-completed` | Housekeeping |

**Total: 4 functional tech debt items + 3 documentation gaps**

## Human Verification Items (31 total, non-blocking)

- **Phase 09:** 5 items (session refresh, expiry grace, return URL, unverified email page, middleware enforcement)
- **Phase 10:** 8 items (CSRF UX, CSP headers, script blocking, avatars, dark mode, NProgress, error messages, static assets)
- **Phase 11:** 3 items (visual appearance, multi-device logout, current session detection)
- **Phase 12:** 6 items (page layout, week picker, payment toggle, bulk modal, creation form, leaderboard)
- **Phase 13:** 7 items (admin guard, toggle behavior, drag-drop, SSE import/export, shift-click, sidebar admin)
- **Phase 14+15:** 4 items (import confirm flow, SSE progress, CSRF cookie at runtime, full auth redirect chain)

---

*Audited: 2026-02-22T17:01:35Z*
*Previous audit: 2026-02-22T12:00 (pre-Phase 14/15, identified CSRF bypass + middleware — Phase 14 closed CSRF bypass, Phase 15 closed middleware but regressed by commit 2feb03e)*
*Auditor: Claude (gsd-audit-milestone orchestrator + gsd-integration-checker)*
