---
phase: 12-bonus-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/bonus.ts
  - src/app/api/guilds/[guildId]/bonus/rounds/route.ts
  - src/app/api/guilds/[guildId]/bonus/rounds/[roundId]/route.ts
  - src/app/api/guilds/[guildId]/bonus/rounds/[roundId]/results/route.ts
  - src/app/api/guilds/[guildId]/bonus/rounds/[roundId]/payments/bulk/route.ts
  - src/app/api/guilds/[guildId]/bonus/rounds/[roundId]/payments/[paymentId]/route.ts
  - src/app/api/guilds/[guildId]/bonus/leaderboard/route.ts
  - src/hooks/use-bonus.ts
autonomous: true
requirements:
  - BONUS-01
  - BONUS-02
  - BONUS-03
  - BONUS-04
  - BONUS-05
  - BONUS-06
  - BONUS-07

must_haves:
  truths:
    - "TypeScript types exist for all bonus domain entities (rounds, targets, payments, results, leaderboard)"
    - "Proxy routes forward requests to all 7 backend bonus endpoints with auth and error sanitization"
    - "React Query hooks provide data fetching and mutations for all bonus operations"
  artifacts:
    - path: "src/types/bonus.ts"
      provides: "All bonus TypeScript interfaces"
      contains: "BonusRound"
    - path: "src/hooks/use-bonus.ts"
      provides: "All bonus React Query hooks"
      contains: "useBonusRounds"
    - path: "src/app/api/guilds/[guildId]/bonus/rounds/route.ts"
      provides: "GET list + POST create proxy"
      exports: ["GET", "POST"]
    - path: "src/app/api/guilds/[guildId]/bonus/leaderboard/route.ts"
      provides: "GET leaderboard proxy"
      exports: ["GET"]
  key_links:
    - from: "src/hooks/use-bonus.ts"
      to: "/api/guilds/[guildId]/bonus/rounds"
      via: "fetchWithRetry in useQuery/useMutation"
      pattern: "fetchWithRetry.*bonus"
    - from: "src/app/api/guilds/[guildId]/bonus/rounds/route.ts"
      to: "BACKEND_API_URL/api/v1/guilds/:guildId/bonus/rounds"
      via: "backendFetch proxy"
      pattern: "backendFetch.*bonus/rounds"
---

<objective>
Create the complete data layer for the bonus system: TypeScript types, API proxy routes, and React Query hooks.

Purpose: All UI plans (02-04) depend on this data layer. Types define the contract, proxy routes connect to the backend, and hooks provide the data fetching/mutation interface for components.

Output: `src/types/bonus.ts`, 6 proxy route files, `src/hooks/use-bonus.ts`
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-bonus-system/12-RESEARCH.md

# Reference patterns from existing data layers
@src/types/export.ts
@src/types/alert.ts
@src/hooks/use-exports.ts
@src/hooks/use-alerts.ts
@src/app/api/guilds/[guildId]/exports/route.ts
@src/lib/server/backend-fetch.ts
@src/lib/server/error-sanitizer.ts
@src/lib/server/api-url.ts
@src/lib/fetch-with-retry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bonus TypeScript types and API proxy routes</name>
  <files>
    src/types/bonus.ts
    src/app/api/guilds/[guildId]/bonus/rounds/route.ts
    src/app/api/guilds/[guildId]/bonus/rounds/[roundId]/route.ts
    src/app/api/guilds/[guildId]/bonus/rounds/[roundId]/results/route.ts
    src/app/api/guilds/[guildId]/bonus/rounds/[roundId]/payments/bulk/route.ts
    src/app/api/guilds/[guildId]/bonus/rounds/[roundId]/payments/[paymentId]/route.ts
    src/app/api/guilds/[guildId]/bonus/leaderboard/route.ts
  </files>
  <action>
**First**, read the backend bonus route source to verify exact response shapes:
- `~/Desktop/Tracking Data Bot/api/src/routes/dashboard/bonus/bonusRoutes.ts` — all 7 endpoints
- `~/Desktop/Tracking Data Bot/api/src/routes/dashboard/bonus/bonusHelpers.ts` — zod schemas, especially `leaderboardQuerySchema` max weeks value
- Also check `~/Desktop/Tracking Data Bot/shared/lib/weekBoundary.ts` for week start day (Monday vs Sunday) — document finding for UI plans

**Create `src/types/bonus.ts`** with all interfaces derived from actual backend response shapes (see 12-RESEARCH.md "TypeScript Types" section for starting point, but verify against backend source):
- `BonusRound` — list item shape from GET /bonus/rounds
- `BonusTarget` — target within a round
- `BonusPayment` — payment within a round detail
- `BonusRoundDetail` — full round with payments from GET /bonus/rounds/:roundId
- `BonusRoundsResponse` — paginated response { rounds, next_cursor, has_more }
- `BonusRoundDetailResponse` — { round: BonusRoundDetail }
- `BonusResultTarget` — individual result from GET /bonus/rounds/:roundId/results
- `BonusResultsResponse` — { round, summary, results }
- `BonusLeaderboardEntry` — single leaderboard row from GET /bonus/leaderboard
- `BonusLeaderboardResponse` — { leaderboard, meta }
- `CreateBonusRoundRequest` — POST body for round creation
- `RoundFilter` type: `'all' | 'evaluated' | 'pending'`

**Create 6 proxy route files** following the exact pattern from `src/app/api/guilds/[guildId]/exports/route.ts`:
- Use `backendFetch` from `@/lib/server/backend-fetch`
- Use `sanitizeError`/`internalError` from `@/lib/server/error-sanitizer`
- Use `BACKEND_API_URL` from `@/lib/server/api-url`
- Auth via `cookies().get('auth_token')?.value`
- All GET responses: `Cache-Control: no-store`
- `RouteParams` type: `{ params: Promise<{ guildId: string }> }` (or include roundId/paymentId as needed)

Routes:
1. `bonus/rounds/route.ts` — GET (list with query passthrough for limit/cursor/evaluated) + POST (create round, forward JSON body)
2. `bonus/rounds/[roundId]/route.ts` — GET (round detail)
3. `bonus/rounds/[roundId]/results/route.ts` — GET (results)
4. `bonus/rounds/[roundId]/payments/bulk/route.ts` — PATCH (bulk update, forward JSON body)
5. `bonus/rounds/[roundId]/payments/[paymentId]/route.ts` — PATCH (individual payment, forward JSON body)
6. `bonus/leaderboard/route.ts` — GET (leaderboard with query passthrough for weeks)

IMPORTANT: Static route `payments/bulk/route.ts` MUST be in a separate directory from dynamic `payments/[paymentId]/route.ts`. Next.js resolves static before dynamic automatically.
  </action>
  <verify>
Run `npx tsc --noEmit` from the dashboard project root — no new type errors in bonus files.
Verify all 6 proxy route files exist: `ls -la src/app/api/guilds/\[guildId\]/bonus/rounds/route.ts src/app/api/guilds/\[guildId\]/bonus/rounds/\[roundId\]/route.ts src/app/api/guilds/\[guildId\]/bonus/rounds/\[roundId\]/results/route.ts src/app/api/guilds/\[guildId\]/bonus/rounds/\[roundId\]/payments/bulk/route.ts src/app/api/guilds/\[guildId\]/bonus/rounds/\[roundId\]/payments/\[paymentId\]/route.ts src/app/api/guilds/\[guildId\]/bonus/leaderboard/route.ts`
  </verify>
  <done>All bonus TypeScript types defined in bonus.ts matching backend response shapes. All 6 proxy route files created with correct auth, error sanitization, and backend URL forwarding. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Create React Query hooks for all bonus operations</name>
  <files>
    src/hooks/use-bonus.ts
  </files>
  <action>
Create `src/hooks/use-bonus.ts` with all bonus React Query hooks. Use `fetchWithRetry` from `@/lib/fetch-with-retry` (project standard). Import types from `@/types/bonus`.

**Define query key factory** at top of file (prevents cache key mismatch — see 12-RESEARCH.md Pitfall 3):
```typescript
export const bonusKeys = {
  rounds: (guildId: string, filter: RoundFilter, cursor: string | null) =>
    ['guild', guildId, 'bonus', 'rounds', filter, cursor] as const,
  roundDetail: (guildId: string, roundId: string) =>
    ['guild', guildId, 'bonus', 'round', roundId] as const,
  results: (guildId: string, roundId: string) =>
    ['guild', guildId, 'bonus', 'results', roundId] as const,
  leaderboard: (guildId: string, weeks: number) =>
    ['guild', guildId, 'bonus', 'leaderboard', weeks] as const,
}
```

**Query hooks:**
1. `useBonusRounds(guildId, filter)` — Load More pagination pattern. NOT useInfiniteQuery. Uses useState for accumulated rounds[], cursor, and hasMore. Returns `{ rounds, hasMore, loadMore, isLoading, isError, reset }`. See 12-RESEARCH.md "React Query Hook: Load More Pattern" for full implementation. Reset rounds/cursor when filter changes via useEffect.
2. `useBonusRoundDetail(guildId, roundId, enabled)` — useQuery for single round detail. `enabled` controls lazy fetch (only when card is expanded). staleTime 30s.
3. `useBonusResults(guildId, roundId, enabled)` — useQuery for round results. `enabled` controls lazy fetch (only when Results tab active AND round is evaluated).
4. `useBonusLeaderboard(guildId, weeks)` — useQuery for leaderboard data. staleTime 30s.

**Mutation hooks:**
5. `useCreateBonusRound(guildId)` — POST mutation. On success: invalidate rounds queries, show success toast. On error: show error toast.
6. `useUpdatePayment(guildId)` — PATCH mutation with **optimistic update**. Follow Pattern 3 from research: onMutate cancels queries, snapshots previous, updates cache with new paid status. onError reverts from snapshot and shows error toast. onSettled invalidates roundDetail query. When toggling to unpaid, show Sonner warning toast with undo action (5s duration).
7. `useBulkUpdatePayments(guildId)` — PATCH mutation for bulk. On success: invalidate roundDetail query, show success toast. On error: show error toast.
8. `useUpdatePaymentNotes(guildId)` — Separate mutation for notes auto-save on blur. PATCH same endpoint but only sends notes field (plus current paid status to avoid race condition — see Pitfall 4).

**Helper:**
- `centsToDisplay(cents: number): string` — returns `$X.XX` format. Export for use in UI components.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify the hooks file exports all 8 hooks + bonusKeys + centsToDisplay: `grep -c 'export' src/hooks/use-bonus.ts` should show 10+ exports.
  </verify>
  <done>All 8 React Query hooks created with correct query keys, pagination logic, optimistic updates for payments, and toast notifications. Helper function for cents display exported. TypeScript compiles clean.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. All proxy routes exist at correct paths under `src/app/api/guilds/[guildId]/bonus/`
3. Types file exports all interfaces: BonusRound, BonusTarget, BonusPayment, BonusRoundDetail, BonusRoundsResponse, BonusRoundDetailResponse, BonusResultTarget, BonusResultsResponse, BonusLeaderboardEntry, BonusLeaderboardResponse, CreateBonusRoundRequest, RoundFilter
4. Hooks file exports: bonusKeys, useBonusRounds, useBonusRoundDetail, useBonusResults, useBonusLeaderboard, useCreateBonusRound, useUpdatePayment, useBulkUpdatePayments, useUpdatePaymentNotes, centsToDisplay
5. Optimistic update in useUpdatePayment includes onMutate snapshot + onError revert
</verification>

<success_criteria>
Complete data layer for bonus system: types compile, proxy routes forward to backend, hooks provide full CRUD interface. All UI plans (02-04) can import from bonus.ts and use-bonus.ts without any additional data layer work.
</success_criteria>

<output>
After completion, create `.planning/phases/12-bonus-system/12-01-SUMMARY.md`
</output>
