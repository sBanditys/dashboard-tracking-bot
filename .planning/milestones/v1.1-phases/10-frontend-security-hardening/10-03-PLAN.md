---
phase: 10-frontend-security-hardening
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/middleware.ts
  - src/lib/server/security-headers.ts
  - next.config.mjs
autonomous: true

must_haves:
  truths:
    - "Dashboard serves Content-Security-Policy header on all page responses"
    - "CSP prevents inline script execution (no unsafe-inline for scripts)"
    - "Dashboard serves X-Frame-Options, X-Content-Type-Options, Referrer-Policy, and Permissions-Policy headers"
    - "Discord CDN avatars load correctly (img-src allowlisted)"
    - "NProgress bar and Toaster styles render correctly under CSP"
    - "next-themes dark/light mode toggle works without CSP violations"
    - "Development mode allows unsafe-eval for Next.js HMR"
  artifacts:
    - path: "src/lib/server/security-headers.ts"
      provides: "CSP policy builder and security headers utility"
      exports: ["getSecurityHeaders", "buildCspHeader"]
    - path: "src/middleware.ts"
      provides: "Middleware with CSP nonce generation and security headers on responses"
      contains: "x-nonce|Content-Security-Policy"
    - path: "next.config.mjs"
      provides: "Next.js config with security headers for static assets"
      contains: "headers"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/server/security-headers.ts"
      via: "import getSecurityHeaders"
      pattern: "getSecurityHeaders"
    - from: "src/middleware.ts"
      to: "src/app/layout.tsx"
      via: "x-nonce request header read by Next.js for script/style nonce injection"
      pattern: "x-nonce"
---

<objective>
Add Content-Security-Policy headers and full security headers suite to the dashboard.

Purpose: Prevent XSS attacks via CSP (AUTH-04) and strengthen overall HTTP security posture. CSP is enforced immediately (not report-only) per user decision. The full security headers suite includes X-Frame-Options, X-Content-Type-Options, Referrer-Policy, and Permissions-Policy.

Output: Security headers utility, updated middleware with CSP nonce generation, updated next.config.mjs with security headers for static assets.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-frontend-security-hardening/10-CONTEXT.md
@.planning/phases/10-frontend-security-hardening/10-RESEARCH.md
@.planning/phases/10-frontend-security-hardening/10-01-SUMMARY.md
@src/middleware.ts
@src/app/layout.tsx
@src/app/providers.tsx
@src/app/globals.css
@src/app/global-error.tsx
@next.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security headers utility and integrate CSP into middleware</name>
  <files>src/lib/server/security-headers.ts, src/middleware.ts</files>
  <action>
**Part A: Create `src/lib/server/security-headers.ts`**

Build a CSP policy builder and security headers utility:

1. Create `buildCspHeader(nonce: string)` function that returns a CSP header string:
   ```
   default-src 'self';
   script-src 'self' 'nonce-{nonce}' 'strict-dynamic' {+ 'unsafe-eval' in dev only};
   style-src 'self' 'unsafe-inline';
   img-src 'self' blob: data: https://cdn.discordapp.com;
   font-src 'self';
   connect-src 'self';
   object-src 'none';
   base-uri 'self';
   form-action 'self';
   frame-ancestors 'none';
   upgrade-insecure-requests;
   ```

   Key CSP decisions (Claude's discretion based on codebase audit):

   **script-src:** Use `'nonce-{nonce}'` with `'strict-dynamic'`. In development, add `'unsafe-eval'` for Next.js HMR/Fast Refresh. Do NOT use `'unsafe-inline'` for scripts.

   **style-src:** Use `'self' 'unsafe-inline'` (NOT nonce-based for styles). Rationale from codebase audit:
   - `next-themes` injects an inline `<script>` that sets `class="dark"` on `<html>` -- this is handled by script nonce.
   - NProgress in `providers.tsx` creates a `<style>` element via `document.createElement('style')` and appends it to `<head>` at runtime. This DOM-manipulated style element CANNOT receive a nonce (nonces are for static inline styles in the HTML response, not dynamically created elements).
   - Multiple components use React's `style={{}}` JSX prop which generates inline style attributes.
   - `global-error.tsx` uses inline styles exclusively (no Tailwind available in error boundary).
   - Tailwind CSS itself is compiled to a stylesheet file (safe under `'self'`), but CSS custom properties via `var()` and some Tailwind runtime features may generate inline styles.
   - Using `'unsafe-inline'` for styles is an acceptable security tradeoff -- style injection is far less dangerous than script injection, and nonce-based style-src would break NProgress, global-error, and component inline styles.

   **img-src:** Include `https://cdn.discordapp.com` for Discord avatar images (used throughout the dashboard for guild icons and user avatars).

   **connect-src:** `'self'` is sufficient -- all API calls go through the Next.js proxy, no direct external API calls from the client.

   **font-src:** `'self'` -- uses local Geist fonts loaded via `next/font/local` (no external font CDNs).

2. Create `getSecurityHeaders(nonce: string)` function that returns a `Record<string, string>`:
   ```typescript
   export function getSecurityHeaders(nonce: string): Record<string, string> {
     return {
       'Content-Security-Policy': buildCspHeader(nonce),
       'X-Frame-Options': 'DENY',
       'X-Content-Type-Options': 'nosniff',
       'Referrer-Policy': 'strict-origin-when-cross-origin',
       'Permissions-Policy': 'geolocation=(), camera=(), microphone=()',
     };
   }
   ```

   Per user decision: full security headers suite beyond CSP.

3. Export both `buildCspHeader` and `getSecurityHeaders`.

**Part B: Update `src/middleware.ts` to add CSP nonce generation and security headers**

The middleware already has CSRF protection from Plan 01. Layer CSP on top:

1. Generate a nonce at the start of the middleware function:
   ```typescript
   const nonce = Buffer.from(crypto.randomUUID()).toString('base64');
   ```

2. Import `getSecurityHeaders` from `@/lib/server/security-headers`.

3. After the existing middleware logic produces a response (either `NextResponse.next()` or a redirect):
   - For `NextResponse.next()` responses (page loads): set `x-nonce` request header so Next.js can read it for framework script/style injection:
     ```typescript
     const requestHeaders = new Headers(request.headers);
     requestHeaders.set('x-nonce', nonce);
     const response = NextResponse.next({ request: { headers: requestHeaders } });
     ```
   - Apply all security headers to the response:
     ```typescript
     const securityHeaders = getSecurityHeaders(nonce);
     for (const [key, value] of Object.entries(securityHeaders)) {
       response.headers.set(key, value);
     }
     ```
   - For redirect responses: apply security headers but skip `x-nonce` (redirects don't render content).

4. Do NOT apply CSP to API routes -- CSP is for HTML pages, not JSON API responses. The middleware matcher already excludes `api` routes, but verify this is maintained. If the CSRF integration from Plan 01 expanded the matcher to include API routes, the CSP header application should be conditional: only set CSP headers when the path does NOT start with `/api/`.

5. Ensure the middleware response flow is clean:
   - CSRF validation runs first (from Plan 01).
   - Auth redirect logic runs second (existing).
   - CSP nonce and security headers are applied to the final response (new).
   - Return the response with all headers set.

IMPORTANT: The `x-nonce` header allows Next.js to automatically apply the nonce to framework-injected `<script>` and `<link>` tags. This is the official Next.js pattern from their CSP guide. The `next-themes` inline script that prevents flash-of-wrong-theme will receive the nonce automatically through this mechanism.
  </action>
  <verify>
1. `npx tsc --noEmit` passes.
2. `npm run build` completes successfully.
3. Start dev server and verify in browser:
   - Open DevTools > Network tab, load a page.
   - Check response headers for the page document (not API calls):
     - `Content-Security-Policy` header present with nonce value.
     - `X-Frame-Options: DENY` present.
     - `X-Content-Type-Options: nosniff` present.
     - `Referrer-Policy: strict-origin-when-cross-origin` present.
     - `Permissions-Policy: geolocation=(), camera=(), microphone=()` present.
   - Check DevTools > Console for CSP violations -- there should be NONE.
   - Verify dark mode toggle works (next-themes script executes).
   - Verify NProgress bar appears on navigation (inline styles work under unsafe-inline).
   - Verify Discord avatars load (img-src allows cdn.discordapp.com).
   - Verify toast notifications display correctly (Sonner with inline styles).
   - Verify charts render (Recharts with inline styles).
  </verify>
  <done>
CSP header is served on all page responses with nonce-based script-src and unsafe-inline style-src. Full security headers suite (X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy) is applied. No CSP violations in the browser console. Dark mode, NProgress, Discord avatars, toasts, and charts all work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add security headers to next.config.mjs for static asset coverage</name>
  <files>next.config.mjs</files>
  <action>
Update `next.config.mjs` to add security headers via the `headers()` config option. This covers responses that bypass middleware (static assets served by Next.js, `_next/static/*`, etc.):

```javascript
const nextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'cdn.discordapp.com',
        pathname: '/avatars/**',
      },
    ],
  },
  async headers() {
    return [
      {
        // Apply security headers to all routes
        source: '/(.*)',
        headers: [
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
          { key: 'Permissions-Policy', value: 'geolocation=(), camera=(), microphone=()' },
        ],
      },
    ];
  },
};
```

Note: CSP is NOT set here because it requires a per-request nonce (handled by middleware). The `headers()` config provides static headers only. The non-CSP security headers are set both here AND in middleware for defense-in-depth (middleware headers take precedence for page requests; config headers cover static assets and edge cases).

Preserve the existing `images.remotePatterns` and `bundleAnalyzer` wrapper.
  </action>
  <verify>
1. `npm run build` completes.
2. Start dev server, load a static asset (e.g., a CSS file under `/_next/static/`), and verify response includes:
   - `X-Frame-Options: DENY`
   - `X-Content-Type-Options: nosniff`
   - `Referrer-Policy: strict-origin-when-cross-origin`
   - `Permissions-Policy: geolocation=(), camera=(), microphone=()`
  </verify>
  <done>
Security headers are applied to all responses including static assets via next.config.mjs. Combined with middleware CSP, every response from the dashboard has the full security headers suite.
  </done>
</task>

</tasks>

<verification>
- All page responses include Content-Security-Policy header with nonce-based script-src.
- All responses (pages + static assets) include X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy.
- No CSP violations appear in browser console during normal usage.
- Dark mode toggle, NProgress, Discord avatars, toasts, charts all render correctly.
- API routes do NOT receive CSP headers (JSON responses don't need them).
- `npm run build` passes.
</verification>

<success_criteria>
1. Content-Security-Policy header is present on all page responses with a unique nonce per request.
2. Scripts without the correct nonce are blocked by CSP (testable by injecting a script tag in DevTools).
3. X-Frame-Options DENY prevents iframe embedding.
4. Full security headers suite is present on all responses.
5. No functional regressions -- all existing UI features work under CSP.
6. Build succeeds with no errors.
</success_criteria>

<output>
After completion, create `.planning/phases/10-frontend-security-hardening/10-03-SUMMARY.md`
</output>
