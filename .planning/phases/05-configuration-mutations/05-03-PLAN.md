---
phase: 05-configuration-mutations
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/audit.ts
  - src/hooks/use-audit-log.ts
  - src/app/api/guilds/[guildId]/audit-log/route.ts
  - src/components/audit/audit-log-table.tsx
  - src/app/(dashboard)/guilds/[guildId]/activity/page.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Audit log displays in table format with Time, User, Action, Details columns"
    - "Changes show full diff (old value to new value)"
    - "User can filter by user and action type"
    - "Activity page accessible via sidebar navigation"
  artifacts:
    - path: "src/types/audit.ts"
      provides: "AuditLogEntry and AuditLogResponse types"
      exports: ["AuditLogEntry", "AuditLogResponse", "AuditLogFilters"]
    - path: "src/hooks/use-audit-log.ts"
      provides: "useAuditLog query hook with filters"
      exports: ["useAuditLog"]
    - path: "src/app/api/guilds/[guildId]/audit-log/route.ts"
      provides: "GET endpoint for audit log"
      exports: ["GET"]
    - path: "src/components/audit/audit-log-table.tsx"
      provides: "Sortable table with filters"
      min_lines: 100
    - path: "src/app/(dashboard)/guilds/[guildId]/activity/page.tsx"
      provides: "Dedicated Activity page"
      min_lines: 30
  key_links:
    - from: "src/components/audit/audit-log-table.tsx"
      to: "useAuditLog"
      via: "hook import and usage"
      pattern: "useAuditLog"
    - from: "src/components/layout/sidebar.tsx"
      to: "Activity page"
      via: "navigation link"
      pattern: "activity"
---

<objective>
Create the audit log system as a complete vertical slice - types, hook, API route, table component, and page.

Purpose: Implement CONF-05 (view audit log showing who changed what and when). Per CONTEXT.md: table format with sortable columns, full diff display, filterable by user and action type, on dedicated "Activity" page in sidebar.

Output: Complete audit log feature accessible at /guilds/:guildId/activity with filtering and diff display.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-mutations/05-CONTEXT.md
@.planning/phases/05-configuration-mutations/05-RESEARCH.md

# Existing patterns
@src/hooks/use-tracking.ts
@src/app/api/guilds/[guildId]/accounts/route.ts
@src/components/ui/data-table.tsx
@src/components/filters/status-select.tsx
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Audit Types and Hook</name>
  <files>
src/types/audit.ts
src/hooks/use-audit-log.ts
  </files>
  <action>
**Create src/types/audit.ts:**
```typescript
export interface AuditLogActor {
  id: string
  type: 'user' | 'system' | 'bot'
  name?: string
}

export interface AuditLogEntry {
  id: string
  created_at: string
  actor: AuditLogActor
  action: string  // e.g., 'account.create', 'settings.update', 'brand.delete'
  target_type: string  // e.g., 'account', 'brand', 'settings'
  target_id: string | null
  target_name: string | null  // For display
  changes: Record<string, { old: unknown; new: unknown }> | null
}

export interface AuditLogFilters {
  user?: string  // actor.id filter
  action?: string  // action type filter
  page?: number
  limit?: number
}

export interface AuditLogResponse {
  entries: AuditLogEntry[]
  pagination: {
    page: number
    limit: number
    total: number
    total_pages: number
  }
  filters: {
    users: Array<{ id: string; name: string }>  // Available filter options
    actions: string[]
  }
}
```

**Create src/hooks/use-audit-log.ts:**
```typescript
'use client'

import { useQuery } from '@tanstack/react-query'
import type { AuditLogResponse, AuditLogFilters } from '@/types/audit'

export function useAuditLog(guildId: string, filters: AuditLogFilters = {}) {
  return useQuery<AuditLogResponse>({
    queryKey: ['guild', guildId, 'audit-log', filters],
    queryFn: async () => {
      const params = new URLSearchParams()
      if (filters.user) params.set('user', filters.user)
      if (filters.action) params.set('action', filters.action)
      params.set('page', String(filters.page ?? 1))
      params.set('limit', String(filters.limit ?? 25))

      const response = await fetch(`/api/guilds/${guildId}/audit-log?${params}`)
      if (!response.ok) {
        throw new Error('Failed to fetch audit log')
      }
      return response.json()
    },
    staleTime: 30 * 1000, // 30 seconds - activity changes frequently
    enabled: !!guildId,
  })
}
```
  </action>
  <verify>
Files exist. TypeScript compilation passes: `npx tsc --noEmit`.
  </verify>
  <done>
Audit types and useAuditLog hook created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Audit Log API Route and Table Component</name>
  <files>
src/app/api/guilds/[guildId]/audit-log/route.ts
src/components/audit/audit-log-table.tsx
  </files>
  <action>
**Create audit-log/route.ts:**
Standard proxy pattern:
- Forward GET to `${API_URL}/api/v1/guilds/${guildId}/audit-log`
- Forward query params: user, action, page, limit
- Auth from cookies, 401 if missing
- Error: "Failed to fetch audit log"

**Create src/components/audit/audit-log-table.tsx:**
'use client' component with:

**Props:**
```typescript
interface AuditLogTableProps {
  guildId: string
}
```

**State:**
- filters: AuditLogFilters state with user, action, page
- Use useAuditLog(guildId, filters)

**Filter UI (per CONTEXT.md: filterable by user and action type):**
- Two Listbox dropdowns: User filter and Action filter
- Use response.filters.users and response.filters.actions for options
- "All Users" and "All Actions" as default options

**Table structure (per CONTEXT.md: Time, User, Action, Details columns):**
- Time: format with date-fns formatDistanceToNow or format
- User: actor.name or actor.id if no name
- Action: Humanize action string (e.g., 'account.create' -> 'Created account')
- Details: target_name + diff display

**Diff display (per CONTEXT.md: show full diff old value -> new value):**
For each key in entry.changes:
```tsx
<div key={key} className="text-sm">
  <span className="text-gray-400">{key}:</span>
  <span className="text-red-400 line-through ml-2">{String(change.old)}</span>
  <span className="text-gray-400 mx-1">â†’</span>
  <span className="text-green-400">{String(change.new)}</span>
</div>
```

**Pagination:**
Use existing Pagination component or simple prev/next buttons.

**Styling:**
- Table with border-collapse, bg-surface rounded-lg
- Header row with text-gray-400 text-sm font-medium
- Body rows with border-b border-border, hover:bg-background/50
- py-3 px-4 for cells
  </action>
  <verify>
Files exist. TypeScript compilation passes: `npx tsc --noEmit`. Directory src/components/audit/ exists.
  </verify>
  <done>
Audit log API route and table component with filters and diff display created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Activity Page and Add to Sidebar</name>
  <files>
src/app/(dashboard)/guilds/[guildId]/activity/page.tsx
src/components/layout/sidebar.tsx
  </files>
  <action>
**Create activity/page.tsx:**
```typescript
'use client'

import { AuditLogTable } from '@/components/audit/audit-log-table'

interface PageProps {
  params: { guildId: string }
}

export default function ActivityPage({ params }: PageProps) {
  const { guildId } = params

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold text-white">Activity Log</h1>
        <p className="text-gray-400 text-sm mt-1">
          Track all changes made to guild settings and tracked items
        </p>
      </div>

      <AuditLogTable guildId={guildId} />
    </div>
  )
}
```

**Update sidebar.tsx:**
The sidebar currently has hardcoded navigation. We need to add a guild-context-aware Activity link.

The sidebar doesn't have guildId context. Instead of modifying sidebar globally, consider:
1. Option A: Add Activity to GuildTabs component (which has guildId)
2. Option B: Use pathname parsing in sidebar

**Chosen approach: Add to sidebar as a pattern that works when on a guild page.**

In sidebar.tsx, detect if we're on a guild page using pathname:
```typescript
const pathname = usePathname()
const guildMatch = pathname.match(/\/guilds\/([^\/]+)/)
const guildId = guildMatch?.[1]
```

Add a conditional nav item when guildId is present:
```typescript
// In navItems, or as separate guild-specific section
{guildId && (
  <Link
    href={`/guilds/${guildId}/activity`}
    className={cn(
      'flex items-center gap-3 px-3 py-2 rounded-sm text-sm font-medium transition-colors',
      pathname.includes('/activity')
        ? 'bg-accent-purple text-white'
        : 'text-gray-300 hover:bg-surface/50 hover:text-white'
    )}
  >
    <span className="text-lg">ðŸ“‹</span>
    Activity
  </Link>
)}
```

Add this as a separate "Guild" section in the sidebar that appears when viewing a guild.
  </action>
  <verify>
Files exist. TypeScript compilation passes: `npx tsc --noEmit`. Directory src/app/(dashboard)/guilds/[guildId]/activity/ exists.
  </verify>
  <done>
Activity page exists at /guilds/:guildId/activity and is accessible via sidebar navigation when on a guild page.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. Navigate to /guilds/:guildId/activity shows the Activity page
3. Sidebar shows Activity link when on a guild page
4. AuditLogTable renders with filter dropdowns
5. Diff display shows old -> new values
</verification>

<success_criteria>
- Audit types exported from src/types/audit.ts
- useAuditLog hook exported from src/hooks/use-audit-log.ts
- GET /api/guilds/:guildId/audit-log proxy route exists
- AuditLogTable component with filters and sortable columns
- Activity page at /guilds/:guildId/activity
- Sidebar navigation shows Activity link when on guild pages
- Diff display shows old value -> new value format
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-mutations/05-03-SUMMARY.md`
</output>
