---
milestone: v1.1
audited: 2026-02-22T00:00:00Z
status: gaps_found
scores:
  requirements: 22/24
  phases: 5/5
  integration: 46/47
  flows: 7/8
gaps:
  requirements:
    - id: "AUTH-03"
      status: "partial"
      phase: "Phase 10"
      claimed_by_plans: ["10-01-PLAN.md"]
      completed_by_plans: ["10-01-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Phase 10 verification passed — all mutations at time of Phase 10 used fetchWithRetry. However, Phase 13's useConfirmImport (src/hooks/use-import.ts:95) introduced a new POST mutation using raw fetch() without X-CSRF-Token header. CSRF enforcement in proxy.ts will return 403 EBADCSRFTOKEN."
    - id: "IMPEX-04"
      status: "partial"
      phase: "Phase 13"
      claimed_by_plans: ["13-01-PLAN.md", "13-05-PLAN.md"]
      completed_by_plans: ["13-01-SUMMARY.md", "13-05-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Phase 13 verification passed all 20 checks. However, cross-phase integration reveals src/hooks/use-import.ts:95 uses raw fetch() for POST /api/guilds/[guildId]/accounts/import/confirm. Since proxy.ts enforces CSRF on all non-auth mutation routes, this POST returns 403 at runtime. Import confirm is broken."
  integration:
    - from: "Phase 13 useConfirmImport"
      to: "Phase 10 CSRF enforcement"
      issue: "Raw fetch() in use-import.ts:95 bypasses fetchWithRetry CSRF token injection"
  flows:
    - flow: "CSV Import Confirm"
      breaks_at: "POST /api/guilds/[guildId]/accounts/import/confirm — 403 EBADCSRFTOKEN"
tech_debt:
  - phase: 10-frontend-security-hardening
    items:
      - "CSRF token rotation changed from per-session to per-request (proxy.ts line 200) — diverges from 10-01-SUMMARY design decision. Recovery via fetchWithRetry silent retry. Could cause failures under rapid concurrent mutations."
      - "@edge-csrf/nextjs package removed during Next.js 14→16 upgrade. CSRF reimplemented as custom double-submit cookie in proxy.ts."
  - phase: 12-bonus-system
    items:
      - "existingWeekStarts={[]} always empty in page.tsx — week picker won't visually disable already-used weeks. Backend rejects duplicates with 409."
      - "Stale comment in data/page.tsx line 23 about placeholder (ExportTab is actually fully rendered)"
  - phase: 13-alert-import-management
    items:
      - "import-history.tsx shows 'will appear here' stub when entries empty — no import history API endpoint exists yet"
---

# Milestone v1.1 Audit Report

**Milestone:** v1.1 Security Hardening & Backend Alignment
**Audited:** 2026-02-22
**Status:** gaps_found
**Score:** 22/24 requirements satisfied (2 partial)

## Phase Verification Summary

| Phase | Name | Status | Score | Requirements |
|-------|------|--------|-------|--------------|
| 9 | Authentication Security | passed | 4/4 | AUTH-01 ✓, AUTH-02 ✓, AUTH-06 ✓ |
| 10 | Frontend Security Hardening | passed | 11/11 | AUTH-03 ⚠, AUTH-04 ✓, AUTH-05 ✓ |
| 11 | Session Management | passed | 4/4 | SESS-01 ✓, SESS-02 ✓, SESS-03 ✓ |
| 12 | Bonus System | passed | 7/7 | BONUS-01–07 ✓ |
| 13 | Alert & Import Management | passed | 20/20 | ALERT-01–04 ✓, IMPEX-01–03 ✓, IMPEX-04 ⚠ |

All 5 phases individually verified as passed. Gaps emerge from cross-phase integration.

## Requirements Coverage (3-Source Cross-Reference)

| Requirement | VERIFICATION.md | REQUIREMENTS.md | Integration | Final Status |
|-------------|-----------------|-----------------|-------------|--------------|
| AUTH-01 | ✓ passed (Phase 9) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| AUTH-02 | ✓ passed (Phase 9) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| AUTH-03 | ✓ passed (Phase 10) | [ ] unchecked | PARTIAL | **partial** — useConfirmImport bypasses CSRF |
| AUTH-04 | ✓ passed (Phase 10) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| AUTH-05 | ✓ passed (Phase 10) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| AUTH-06 | ✓ passed (Phase 9) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| SESS-01 | ✓ passed (Phase 11) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| SESS-02 | ✓ passed (Phase 11) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| SESS-03 | ✓ passed (Phase 11) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| BONUS-01 | ✓ passed (Phase 12) | [x] checked | WIRED | **satisfied** |
| BONUS-02 | ✓ passed (Phase 12) | [x] checked | WIRED | **satisfied** |
| BONUS-03 | ✓ passed (Phase 12) | [x] checked | WIRED | **satisfied** |
| BONUS-04 | ✓ passed (Phase 12) | [x] checked | WIRED | **satisfied** |
| BONUS-05 | ✓ passed (Phase 12) | [x] checked | WIRED | **satisfied** |
| BONUS-06 | ✓ passed (Phase 12) | [x] checked | WIRED | **satisfied** |
| BONUS-07 | ✓ passed (Phase 12) | [x] checked | WIRED | **satisfied** |
| ALERT-01 | ✓ passed (Phase 13) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| ALERT-02 | ✓ passed (Phase 13) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| ALERT-03 | ✓ passed (Phase 13) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| ALERT-04 | ✓ passed (Phase 13) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| IMPEX-01 | ✓ passed (Phase 13) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| IMPEX-02 | ✓ passed (Phase 13) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| IMPEX-03 | ✓ passed (Phase 13) | [ ] unchecked | WIRED | **satisfied** (update checkbox) |
| IMPEX-04 | ✓ passed (Phase 13) | [ ] unchecked | PARTIAL | **partial** — import confirm blocked by CSRF |

**Satisfied:** 22/24  |  **Partial:** 2  |  **Unsatisfied:** 0  |  **Orphaned:** 0

## Critical Gap: Import Confirm Bypasses CSRF (AUTH-03, IMPEX-04)

**Location:** `src/hooks/use-import.ts` line 95

**Problem:** `useConfirmImport` uses raw `fetch()` for the POST request to `/api/guilds/${guildId}/accounts/import/confirm`. The proxy (`src/proxy.ts`) enforces CSRF on all non-auth mutation routes by checking for an `X-CSRF-Token` header matching the `_csrf_token` cookie. Since raw `fetch()` doesn't inject this header, the request returns **403 EBADCSRFTOKEN**.

**Impact:** Import confirm flow is broken at runtime. User can upload and preview CSV but cannot execute the import.

**Fix:** Replace `fetch(` with `fetchWithRetry(` at line 95. `fetchWithRetry` is already imported at line 6 and automatically injects the CSRF header for POST requests.

**Affected Requirements:**
- **AUTH-03** (CSRF on all mutations): One mutation route not covered
- **IMPEX-04** (import confirm with progress): Blocked at runtime by CSRF enforcement

## Cross-Phase Integration

### Wiring Summary

| Category | Connected | Issues |
|----------|-----------|--------|
| Phase exports | 47 | 0 orphaned |
| API routes | 22 consumed | 0 orphaned |
| Auth protection | 5 areas | 0 unprotected |
| E2E flows | 7 complete | 1 broken (import confirm) |

### Integration Points Verified

- ✓ Phase 10 CSRF applies to Phase 11/12/13 mutations (via fetchWithRetry)
- ✓ Phase 10 error sanitization covers all Phase 11/12/13 API routes
- ✓ Phase 10 CSP headers don't break Phase 12/13 UI
- ✓ Phase 9 auth middleware protects Phase 11/12/13 routes
- ✓ Phase 11 session revocation invalidates JTIs for all features
- ✓ Sidebar includes Bonus (Phase 12) and Manage (Phase 13) sections
- ✓ Sessions accessible via Settings → Active Sessions (Phase 11)
- ✗ Phase 13 useConfirmImport bypasses Phase 10 CSRF enforcement

## Tech Debt

### Phase 10: Frontend Security
- CSRF token rotation changed from per-session to per-request during Next.js 16 upgrade
- @edge-csrf/nextjs replaced with custom implementation in proxy.ts

### Phase 12: Bonus System
- `existingWeekStarts={[]}` always empty — week picker won't show used weeks (backend 409 provides safety net)

### Phase 13: Alert & Import
- Import history shows stub when no entries (no backend endpoint yet)
- Stale comment in data/page.tsx about placeholder

## Human Verification Items (Aggregated)

**Phase 9:** 5 items (session refresh UX, expiry grace, return URL, unverified email page/middleware)
**Phase 10:** 8 items (CSRF UX, CSP headers, script blocking, avatars, dark mode, NProgress, error messages, static assets)
**Phase 11:** 3 items (visual appearance, multi-device logout, current session detection)
**Phase 12:** 6 items (visual layout, week picker, payment toggle, bulk confirm, creation form, leaderboard)
**Phase 13:** 7 items (admin guard, threshold toggle, drag-drop, SSE import progress, export cancel, shift-click, sidebar admin)

**Total:** 29 human verification items across 5 phases (non-blocking)

---

_Audited: 2026-02-22_
_Auditor: Claude (milestone-audit orchestrator + gsd-integration-checker)_
