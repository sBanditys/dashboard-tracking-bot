---
phase: 12-bonus-system
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/bonus/leaderboard-tab.tsx
autonomous: true
requirements:
  - BONUS-07

must_haves:
  truths:
    - "User can view leaderboard showing achievement rankings across all rounds"
    - "User can switch ranking between hit rate percentage and total bonus earned"
    - "User can filter leaderboard by time range (4, 8, 12 weeks, All time)"
    - "Top 3 entries display with podium treatment and medal icons"
    - "Empty state shows friendly message when no bonus data exists"
  artifacts:
    - path: "src/components/bonus/leaderboard-tab.tsx"
      provides: "Leaderboard tab with podium + ranked table"
      contains: "LeaderboardTab"
  key_links:
    - from: "src/components/bonus/leaderboard-tab.tsx"
      to: "src/hooks/use-bonus.ts"
      via: "useBonusLeaderboard hook"
      pattern: "useBonusLeaderboard"
---

<objective>
Build the leaderboard tab component with podium display for top 3, ranked table for the rest, switchable ranking metrics, and time range filters.

Purpose: The leaderboard gives users visibility into group performance across bonus rounds — which groups consistently hit their targets and earn the most bonus. This is a read-only view separate from the rounds tab.

Output: `src/components/bonus/leaderboard-tab.tsx`
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-bonus-system/12-RESEARCH.md
@.planning/phases/12-bonus-system/12-01-SUMMARY.md

# Types and hooks from Plan 01
@src/types/bonus.ts
@src/hooks/use-bonus.ts

# Existing leaderboard reference
@src/components/analytics/leaderboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create leaderboard tab with podium, ranked table, and controls</name>
  <files>
    src/components/bonus/leaderboard-tab.tsx
  </files>
  <action>
**Create `src/components/bonus/leaderboard-tab.tsx`:**
- Props: `{ guildId: string }`

**IMPORTANT:** Check 12-01-SUMMARY.md for the leaderboard max weeks finding. If the backend zod schema has a max value for `weeks`, use that value for "All time" instead of 9999.

**Controls bar (top of component):**
- **Ranking metric switcher**: two buttons — "Hit Rate" and "Total Bonus". Use `useState<'hit_rate' | 'total_bonus'>('hit_rate')`. Styled as pill toggle (same pattern as filter tabs in research).
- **Time range preset buttons**: `useState<number>` for weeks. Four options:
  ```typescript
  const WEEK_OPTIONS = [
    { label: '4 weeks', value: 4 },
    { label: '8 weeks', value: 8 },
    { label: '12 weeks', value: 12 },
    { label: 'All time', value: 9999 }, // or max from backend schema
  ]
  ```
  Styled as small pill buttons, active state with accent-purple.

**Data fetching:**
- Use `useBonusLeaderboard(guildId, weeks)` from Plan 01
- Sort entries client-side based on active ranking metric:
  - `hit_rate`: sort by `hit_rate_percent` descending
  - `total_bonus`: sort by `total_bonus_cents` descending
- Split sorted entries into `top3` (first 3) and `rest` (remaining)

**Meta info bar:**
- Show from `data.meta`: "X groups across Y evaluated rounds" and "Since {date}" — use date-fns `format` for the since date

**Podium display (top 3):**
- Three podium blocks arranged horizontally: 2nd place (left, shorter), 1st place (center, tallest), 3rd place (right, shortest)
- Visual height difference using padding/height (e.g., 1st: h-32, 2nd: h-24, 3rd: h-20)
- Each podium block shows:
  - Medal icon from lucide-react: `Trophy` for gold (1st), `Medal` for silver (2nd), `Award` or another medal-like icon for bronze (3rd). Color with gold (#FFD700), silver (#C0C0C0), bronze (#CD7F32) via Tailwind arbitrary values or inline style.
  - Group name (bold)
  - Hit rate percentage
  - Bonus amount (`centsToDisplay`)
- If fewer than 3 entries, show only available podium blocks (2 or 1)

**Ranked table (rest of entries):**
- Table with columns: Rank (#), Group, Brand, Rounds, Achieved, Hit Rate, Total Bonus
- Rank starts at 4 (continuing from podium)
- Hit rate shown as percentage with color coding: green >= 75%, yellow >= 50%, red < 50%
- Total bonus shown via `centsToDisplay`
- Paid vs unpaid bonus columns: include both `total_paid_cents` and `total_unpaid_cents` as separate columns (Claude's discretion — include them for transparency)
- Style matching project's table patterns (see analytics leaderboard.tsx for reference)

**Loading state:**
- Skeleton for podium (3 blocks with pulse animation)
- Skeleton rows for table

**Empty state:**
- When leaderboard array is empty: centered icon + "No bonus data yet" heading + "Create and evaluate rounds to see rankings" subtext
- No action button (creating rounds is in the Rounds tab)

**Error state:**
- "Failed to load leaderboard" with retry button
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify file exists: `ls src/components/bonus/leaderboard-tab.tsx`. Check it uses the leaderboard hook: `grep 'useBonusLeaderboard' src/components/bonus/leaderboard-tab.tsx`.
  </verify>
  <done>Leaderboard tab renders with podium for top 3 (gold/silver/bronze medal icons), ranked table for remaining entries, switchable ranking metric (hit rate vs total bonus), and preset time range buttons. Empty and loading states handled. Paid/unpaid columns shown in table.</done>
</task>

<task type="auto">
  <name>Task 2: Wire leaderboard tab into bonus page and verify integration</name>
  <files>
    src/app/(dashboard)/guilds/[guildId]/bonus/page.tsx
  </files>
  <action>
**Update `src/app/(dashboard)/guilds/[guildId]/bonus/page.tsx`:**
- Replace the placeholder Leaderboard tab content with the actual `<LeaderboardTab guildId={guildId} />` component
- Import `LeaderboardTab` from `@/components/bonus/leaderboard-tab`
- Ensure the tab switcher correctly toggles between `<RoundsTab>` and `<LeaderboardTab>`

**Also wire the Create Round button:**
- Import `CreateRoundModal` from `@/components/bonus/create-round-modal` (from Plan 03)
- Add `useState<boolean>(false)` for modal open state
- The "Create Round" button in the page header opens the modal
- Pass `existingWeekStarts` to the modal: derive from the current rounds data. Extract `week_start` from all loaded rounds. If the hook doesn't expose all rounds (only current page), pass what's available — the backend will reject duplicates with a 409 anyway.
- Only render the button and modal if `isAdmin` is true

**Note:** If Plan 03 hasn't executed yet when this plan runs, import the CreateRoundModal with a try/catch or wrap in a conditional. However, since Plans 02, 03, and 04 are all Wave 2, the executor handles potential ordering. The safest approach: add the import and let TypeScript flag if the file doesn't exist yet — the executor will handle ordering.

**Fallback if Plan 03 is not ready:** If `create-round-modal.tsx` doesn't exist yet, add a TODO comment and a simple placeholder button that does nothing. The Plan 03 executor will complete the wiring.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Check the page imports LeaderboardTab: `grep 'LeaderboardTab' src/app/\(dashboard\)/guilds/\[guildId\]/bonus/page.tsx`.
  </verify>
  <done>Leaderboard tab is wired into the main bonus page. Switching between Rounds and Leaderboard tabs works. Create Round button opens the creation modal (when available from Plan 03).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. Leaderboard tab renders at `/guilds/[guildId]/bonus` when Leaderboard tab is selected
3. Podium shows top 3 with medal icons and correct ranking
4. Ranked table shows remaining entries with all columns
5. Ranking metric switcher re-sorts entries
6. Time range buttons update the leaderboard data
7. Empty state renders when no data
8. Loading skeleton shows while fetching
</verification>

<success_criteria>
Leaderboard tab is fully functional with podium display, ranked table, metric switching, and time range filtering. Integrated into the bonus page as the second top-level tab.
</success_criteria>

<output>
After completion, create `.planning/phases/12-bonus-system/12-04-SUMMARY.md`
</output>
