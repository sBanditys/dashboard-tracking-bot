---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/auth.ts
  - src/lib/api-client.ts
  - src/middleware.ts
  - src/app/api/auth/login/route.ts
  - src/app/api/auth/logout/route.ts
  - src/app/api/auth/callback/route.ts
  - src/app/api/user/route.ts
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/layout.tsx
  - src/hooks/use-user.ts
  - src/types/user.ts
autonomous: true

must_haves:
  truths:
    - "User can click Discord login button and be redirected to Discord OAuth"
    - "After Discord authorization, user is redirected back with JWT cookie set"
    - "User session persists across browser refresh without re-login"
    - "Unauthenticated users are redirected from dashboard routes to login"
    - "Authenticated users are redirected from login to dashboard"
    - "User can log out and cookie is cleared"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Route protection middleware"
      contains: "NextResponse.redirect"
    - path: "src/lib/auth.ts"
      provides: "Auth utilities"
      exports: ["getSession", "verifyAuth"]
    - path: "src/app/api/auth/callback/route.ts"
      provides: "OAuth callback handler"
      contains: "cookies().set"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with Discord button"
      min_lines: 50
    - path: "src/hooks/use-user.ts"
      provides: "React Query hook for user data"
      contains: "useQuery"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/auth.ts"
      via: "getSession import"
      pattern: "import.*getSession"
    - from: "src/app/api/auth/callback/route.ts"
      to: "cookies"
      via: "Setting auth_token cookie"
      pattern: "cookies.*set.*auth_token"
    - from: "src/hooks/use-user.ts"
      to: "/api/user"
      via: "Fetching current user"
      pattern: "fetch.*api/user"
---

<objective>
Implement Discord OAuth authentication flow through the existing API, with persistent sessions using HttpOnly cookies.

Purpose: Enable users to securely log in via Discord and maintain sessions for 30 days (AUTH-01, AUTH-02, AUTH-03).
Output: Complete auth system with login page, OAuth callback, protected routes, and logout functionality.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth utilities and API client</name>
  <files>
    src/lib/auth.ts
    src/lib/api-client.ts
    src/types/user.ts
    src/middleware.ts
  </files>
  <action>
    Create src/types/user.ts:
    - User interface with: id, username, discriminator (optional), avatar, email (optional)
    - Session interface with: user, token, expiresAt

    Create src/lib/auth.ts:
    - getSession(): Read auth_token cookie, return session or null
    - verifyAuth(): Check if session exists and is valid
    - Use cookies() from 'next/headers' (async in Next.js 14)

    Create src/lib/api-client.ts:
    - apiClient function that wraps fetch with:
      - Base URL from NEXT_PUBLIC_API_URL env var
      - Automatic Authorization header from cookie
      - JSON content-type headers
      - Error handling that returns typed responses
    - Type-safe methods: get, post, put, delete

    Create src/middleware.ts:
    - Protect routes under /(dashboard) - redirect to /login if no auth_token
    - Redirect authenticated users from /login to /
    - Exclude from middleware: /api/*, /legal/*, /_next/*, /favicon.ico, static files
    - Store callbackUrl in query param when redirecting to login
    - CRITICAL: Check pathname before redirecting to prevent loops

    Middleware config matcher:
    ```typescript
    export const config = {
      matcher: [
        '/((?!api|legal|_next/static|_next/image|favicon.ico|.*\\.png$).*)',
      ],
    }
    ```
  </action>
  <verify>
    TypeScript compiles without errors.
    Middleware file exists at src/middleware.ts (Next.js auto-detects).
  </verify>
  <done>
    Auth utilities created, API client ready, middleware configured for route protection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create API routes for auth flow</name>
  <files>
    src/app/api/auth/login/route.ts
    src/app/api/auth/logout/route.ts
    src/app/api/auth/callback/route.ts
    src/app/api/user/route.ts
  </files>
  <action>
    Create src/app/api/auth/login/route.ts:
    - GET handler that initiates Discord OAuth
    - Call backend API to get Discord OAuth URL
    - Return redirect URL to client (not direct redirect - let client handle)
    - If API fails, return error JSON

    Create src/app/api/auth/callback/route.ts:
    - GET handler for OAuth callback from Discord
    - Extract 'code' from query params
    - Call backend API to exchange code for JWT
    - Set auth_token as HttpOnly cookie:
      - httpOnly: true
      - secure: process.env.NODE_ENV === 'production'
      - sameSite: 'lax'
      - maxAge: 60 * 60 * 24 * 30 (30 days)
      - path: '/'
    - Redirect to callbackUrl from state or default to '/'
    - Handle errors gracefully - redirect to /login?error=callback_failed

    Create src/app/api/auth/logout/route.ts:
    - POST handler to clear session
    - Delete auth_token cookie (set maxAge to 0 or use cookies().delete())
    - Return success JSON, let client handle redirect

    Create src/app/api/user/route.ts:
    - GET handler to fetch current user
    - Read auth_token from cookies
    - Forward to backend API with Authorization header
    - Return user data or 401 if not authenticated
  </action>
  <verify>
    curl http://localhost:3000/api/auth/login returns OAuth URL or error
    curl http://localhost:3000/api/user returns 401 without cookie
  </verify>
  <done>
    All auth API routes created, cookies set correctly, logout clears session.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create login page with Discord OAuth flow</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/hooks/use-user.ts
  </files>
  <action>
    Create src/app/(auth)/layout.tsx:
    - Full-screen centered layout (no sidebar)
    - Dark background with centered content
    - Responsive padding

    Create src/app/(auth)/login/page.tsx:
    - Full-screen branded login page per CONTEXT decisions:
      - Logo/title: "Tracking Dashboard"
      - Tagline: "Monitor your Discord bot tracking data"
      - Prominent Discord button (purple accent color)
    - Login flow:
      1. Click "Sign in with Discord" button
      2. Show loading state: "Connecting..."
      3. Fetch /api/auth/login to get OAuth URL
      4. Redirect to Discord OAuth URL
    - Handle errors: Show error card with retry button
    - Check for ?error query param (from callback failures)
    - Use 'use client' for interactivity
    - Discord button should have Discord logo/icon (use SVG inline or emoji)

    Create src/hooks/use-user.ts:
    - useUser() hook using React Query
    - Fetch from /api/user
    - staleTime: 5 minutes
    - retry: false (don't retry auth failures)
    - Return { user, isLoading, isError }

    - useLogout() hook
    - POST to /api/auth/logout
    - Clear React Query cache with queryClient.removeQueries()
    - Redirect to /login via window.location.href
  </action>
  <verify>
    Navigate to /login - see branded login page with Discord button.
    Click button - loading state shows, then redirects to Discord (will fail without real API, but flow works).
    Check React DevTools - useUser hook is available.
  </verify>
  <done>
    Login page displays branded UI, Discord OAuth flow initiates on click, user hook available.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. /login shows branded page with Discord button
2. Clicking login button shows loading state
3. /api/auth/logout clears cookie (check with browser DevTools)
4. Middleware redirects / to /login when not authenticated
5. useUser hook returns appropriate state
6. No TypeScript errors, no console errors
</verification>

<success_criteria>
- AUTH-01: Login via Discord OAuth flow implemented (initiates correctly)
- AUTH-02: Session persistence via 30-day HttpOnly cookie
- AUTH-03: Logout endpoint clears cookie
- Middleware protects dashboard routes
- Login page matches design decisions (branded, dark mode, prominent button)
- API client ready for future API calls
- useUser and useLogout hooks available
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
