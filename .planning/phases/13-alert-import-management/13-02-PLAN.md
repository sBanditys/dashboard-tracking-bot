---
phase: 13-alert-import-management
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  # Hooks
  - src/hooks/use-alerts.ts
  - src/hooks/use-email-alerts.ts
  - src/hooks/use-import.ts
  - src/hooks/use-exports.ts
  # Manage section routing
  - src/app/(dashboard)/guilds/[guildId]/manage/layout.tsx
  - src/components/manage/admin-guard.tsx
  - src/components/manage/manage-nav.tsx
  # Sidebar update
  - src/components/layout/sidebar.tsx
autonomous: true
requirements: [ALERT-01, ALERT-04, IMPEX-01, IMPEX-02, IMPEX-03, IMPEX-04]

must_haves:
  truths:
    - "Alert threshold hooks fetch paginated data with infinite scroll support"
    - "Email config hooks fetch and mutate email delivery settings and recipients"
    - "Import hooks handle file upload, preview, and SSE confirm streaming"
    - "Manage section only accessible to guild admins (ADMINISTRATOR bit 0x8)"
    - "Non-admins see 403 forbidden page when navigating to /manage URLs"
    - "Sidebar shows Manage nav items (Alerts, Data) only for admin users"
    - "Alerts nav item shows count of active thresholds as a badge"
  artifacts:
    - path: "src/hooks/use-alerts.ts"
      provides: "useAlertThresholds, useCreateThreshold, useDeleteThreshold, useToggleThreshold"
      exports: ["useAlertThresholds", "useCreateThreshold", "useToggleThreshold"]
    - path: "src/hooks/use-email-alerts.ts"
      provides: "useEmailConfig, useUpdateEmailConfig, useAddRecipient, useRemoveRecipient"
      exports: ["useEmailConfig", "useUpdateEmailConfig"]
    - path: "src/hooks/use-import.ts"
      provides: "useImportPreview, useConfirmImport, useImportTemplate"
      exports: ["useImportPreview", "useConfirmImport"]
    - path: "src/app/(dashboard)/guilds/[guildId]/manage/layout.tsx"
      provides: "Admin-gated layout with manage sub-navigation"
      contains: "ADMINISTRATOR"
    - path: "src/components/manage/admin-guard.tsx"
      provides: "403 forbidden component for non-admins"
      exports: ["AdminForbidden"]
    - path: "src/components/layout/sidebar.tsx"
      provides: "Manage nav items visible only to admin users"
      contains: "manage/alerts"
  key_links:
    - from: "src/hooks/use-alerts.ts"
      to: "/api/guilds/{guildId}/alert-thresholds"
      via: "fetchWithRetry in useInfiniteQuery"
      pattern: "fetchWithRetry.*alert-thresholds"
    - from: "src/hooks/use-import.ts"
      to: "/api/guilds/{guildId}/accounts/import/confirm"
      via: "fetch + ReadableStream for POST-SSE"
      pattern: "reader\\.read\\(\\)"
    - from: "src/app/(dashboard)/guilds/[guildId]/manage/layout.tsx"
      to: "src/components/manage/admin-guard.tsx"
      via: "Renders AdminForbidden when permissions check fails"
      pattern: "AdminForbidden"
---

<objective>
Build all React Query hooks for alerts, email config, and imports. Create the admin-gated manage section with routing, layout, and sidebar navigation.

Purpose: Provide the data-fetching layer and navigation structure that all Phase 13 UI pages depend on.

Output: 4 hook files, manage layout with admin guard, sidebar updated with Manage section.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-alert-import-management/13-RESEARCH.md
@.planning/phases/13-alert-import-management/13-01-SUMMARY.md

Key reference files:
@src/hooks/use-exports.ts (existing hook patterns)
@src/hooks/use-tracking.ts (infinite query pattern)
@src/hooks/use-user.ts (user permissions access)
@src/hooks/use-sse.ts (SSE hook reference)
@src/components/layout/sidebar.tsx (sidebar to modify)
@src/types/alert.ts (from Plan 01)
@src/types/import.ts (from Plan 01)
@src/types/user.ts (UserGuild.permissions)
@src/lib/fetch-with-retry.ts (fetchWithRetry client)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create React Query hooks for alerts, email config, and imports</name>
  <files>
    src/hooks/use-alerts.ts
    src/hooks/use-email-alerts.ts
    src/hooks/use-import.ts
    src/hooks/use-exports.ts
  </files>
  <action>
  **Create `src/hooks/use-alerts.ts`:**

  Follow the pattern from `use-tracking.ts` for infinite queries and `use-exports.ts` for mutations.

  1. `useAlertThresholds(guildId, filters)` ‚Äî `useInfiniteQuery`:
     - queryKey: `['guild', guildId, 'alerts', 'thresholds', filters]`
     - Fetch from `/api/guilds/${guildId}/alert-thresholds?page=${pageParam}&limit=20&...filters`
     - `getNextPageParam`: if `lastPage.pagination.page >= lastPage.pagination.total_pages` return undefined, else `page + 1`
     - `staleTime: 30 * 1000`, `refetchOnWindowFocus: true`
     - `enabled: !!guildId`
     - Return type: `ThresholdPage` from `@/types/alert`

  2. `useActiveThresholdCount(guildId)` ‚Äî simple query that extracts `active_count` from the first page of thresholds, or a separate lightweight query. Use the `active_count` from the first page of `useAlertThresholds` via a derived value. Alternatively, export a helper function `getActiveCount` that reads from the query cache.

  3. `useCreateThreshold(guildId)` ‚Äî `useMutation`:
     - POST to `/api/guilds/${guildId}/groups/${groupId}/alert-thresholds` with JSON body
     - On success: invalidate `['guild', guildId, 'alerts']`, show success toast
     - On error: show error toast
     - Return type: `AlertThreshold`

  4. `useDeleteThreshold(guildId)` ‚Äî `useMutation`:
     - DELETE to `/api/guilds/${guildId}/groups/${groupId}/alert-thresholds/${thresholdId}`
     - On success: invalidate `['guild', guildId, 'alerts']`, show success toast
     - On error: show error toast

  5. `useToggleThreshold(guildId)` ‚Äî `useMutation`:
     - PATCH to `/api/guilds/${guildId}/groups/${groupId}/alert-thresholds/${thresholdId}` with `{ enabled: boolean }`
     - On success: invalidate `['guild', guildId, 'alerts']` ‚Äî NO optimistic update (per locked decision: waits for API confirmation)
     - On error: show error toast

  6. `useUpdateAlertSettings(guildId)` ‚Äî `useMutation`:
     - PATCH to `/api/guilds/${guildId}/groups/${groupId}/alert-settings` with alert settings body
     - On success: invalidate `['guild', guildId, 'alerts']`, success toast
     - On error: error toast

  7. `useBulkToggleThresholds(guildId)` ‚Äî `useMutation`:
     - Accept array of `{ groupId, thresholdId, enabled }` and execute sequentially via Promise.all
     - On success: invalidate cache, toast
     - On error: toast with count of failures

  8. `useBulkDeleteThresholds(guildId)` ‚Äî `useMutation`:
     - Accept array of `{ groupId, thresholdId }` and delete sequentially
     - On success: invalidate, toast
     - On error: toast

  **Create `src/hooks/use-email-alerts.ts`:**

  1. `useEmailConfig(guildId)` ‚Äî `useQuery`:
     - GET from `/api/guilds/${guildId}/email-config`
     - Return `EmailConfigResponse` (config + recipients + maxRecipients)
     - `staleTime: 60 * 1000`

  2. `useUpdateEmailConfig(guildId)` ‚Äî `useMutation`:
     - PUT to `/api/guilds/${guildId}/email-config` with `{ deliveryMode, digestHour }`
     - Invalidate email config query on success
     - Success toast

  3. `useAddRecipient(guildId)` ‚Äî `useMutation`:
     - POST to `/api/guilds/${guildId}/email-recipients` with `{ email }`
     - Invalidate email config query
     - Success toast: "Verification email sent"

  4. `useRemoveRecipient(guildId)` ‚Äî `useMutation`:
     - DELETE to `/api/guilds/${guildId}/email-recipients/${recipientId}`
     - Invalidate email config query
     - Success toast

  5. `useResendVerification(guildId)` ‚Äî `useMutation`:
     - POST to `/api/guilds/${guildId}/email-recipients/${recipientId}/resend-verification`
     - Success toast: "Verification email resent"
     - On error: error toast

  **Create `src/hooks/use-import.ts`:**

  1. `useImportTemplate(guildId)` ‚Äî function (not a hook) that triggers download:
     - Call `fetchWithRetry('/api/guilds/${guildId}/accounts/template')`, get blob, create download link
     - Return async function `downloadTemplate`

  2. `useImportPreview(guildId)` ‚Äî `useMutation`:
     - POST multipart/form-data to `/api/guilds/${guildId}/accounts/import`
     - Create `FormData`, append file
     - Return `ImportPreview` response
     - On error: toast

  3. `useConfirmImport(guildId)` ‚Äî custom hook with POST-SSE streaming:
     - **Cannot use EventSource** (it's a POST endpoint). Use `fetch()` + `ReadableStream` parsing.
     - Accept `importId` and `onProgress` callback
     - Send POST to `/api/guilds/${guildId}/accounts/import/confirm` with `{ importId }`
     - Read response body as stream using `response.body.getReader()`
     - Parse SSE lines: split on `\n`, look for `data: ` prefix, JSON.parse
     - Call `onProgress(event)` for each `ImportProgressEvent`
     - Return `{ confirm, isConfirming, error }` ‚Äî `confirm` is the trigger function
     - Invalidate `['guild', guildId, 'accounts']` on completion

  **Update `src/hooks/use-exports.ts`:**
  - Import the new `ExportDataType` from `@/types/export`
  - No functional changes needed ‚Äî the existing hooks already forward `dataType` to the API; the type extension in export.ts already widens the accepted values

  Ensure all hooks use `'use client'` directive, import from `@/types/alert`, `@/types/import`, and follow existing patterns (fetchWithRetry, toast from sonner, useQueryClient for cache invalidation).
  </action>
  <verify>
  `npx tsc --noEmit` passes from dashboard root.
  All hook files exist and export their named hooks.
  Grep for `useInfiniteQuery` in `use-alerts.ts` confirms infinite scroll pattern.
  Grep for `reader.read()` in `use-import.ts` confirms POST-SSE streaming pattern.
  </verify>
  <done>
  All hooks created: 8 alert hooks (infinite query + mutations + bulk), 5 email config hooks, 3 import hooks (template download, preview mutation, SSE confirm), export types widened.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create manage section routing, admin guard, and sidebar navigation</name>
  <files>
    src/app/(dashboard)/guilds/[guildId]/manage/layout.tsx
    src/components/manage/admin-guard.tsx
    src/components/manage/manage-nav.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
  **Create `src/components/manage/admin-guard.tsx`:**

  A client component that renders a 403 forbidden page for non-admins:
  - Props: `guildId: string`
  - Display: centered message "You don't have permission to access this page" with a shield/lock icon (use lucide-react `ShieldX` or `Lock`)
  - Include "Go back to guild" link pointing to `/guilds/${guildId}`
  - Include "Go to guilds list" link pointing to `/guilds`
  - Style consistent with existing error/empty state patterns (centered, padded, dark theme)
  - Export as named `AdminForbidden`

  **Create `src/components/manage/manage-nav.tsx`:**

  A client component for manage section sub-navigation:
  - Props: `guildId: string`
  - Two nav items: "Alerts" (href: `/guilds/${guildId}/manage/alerts`) and "Data" (href: `/guilds/${guildId}/manage/data`)
  - Use lucide-react icons: `Bell` for Alerts, `Database` or `FileSpreadsheet` for Data
  - Active state detection using `usePathname()` ‚Äî highlight active item with `bg-accent-purple text-white` (same pattern as sidebar)
  - Render as horizontal pill navigation (flex row with gap, each item is a Link with rounded pill styling)
  - Responsive: wraps on mobile
  - Export as named `ManageNav`

  **Create `src/app/(dashboard)/guilds/[guildId]/manage/layout.tsx`:**

  A **client component** (use 'use client') since it needs `useUser()` hook for permission checking:
  - Extract `guildId` from `useParams()` (client-side)
  - Use `useUser()` hook to get the current user
  - Check admin: find guild in `user.guilds` by `guildId`, check `(Number(guild.permissions) & 0x8) !== 0`
  - If loading user data: show loading skeleton
  - If no admin permission: render `<AdminForbidden guildId={guildId} />`
  - If admin: render `<ManageNav guildId={guildId} />` followed by `{children}`
  - Add a section header "Manage" above the nav

  **Update `src/components/layout/sidebar.tsx`:**

  Add "Manage" section in the guild-specific navigation block (after the existing guild nav items, before the legal section):

  1. Import `useUser` from `@/hooks/use-user`
  2. Import `useActiveThresholdCount` from `@/hooks/use-alerts`
  3. In the component body, call `const { user } = useUser()`
  4. Determine admin status: `const isGuildAdmin = user?.guilds?.find(g => g.id === guildId) && (Number(user.guilds.find(g => g.id === guildId)!.permissions) & 0x8) !== 0`
  5. Call `const { count } = useActiveThresholdCount(guildId)` ‚Äî only meaningful when `guildId` is present and user is admin (the hook should handle disabled state via `enabled: !!guildId`)
  6. After the existing guild nav items (Deleted Items link), add a conditional block:
     ```
     {guildId && isGuildAdmin && (
       <>
         <div className="my-3 border-t border-border" />
         <p className="px-3 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">Manage</p>
         <Link href={`/guilds/${guildId}/manage/alerts`} ...>
           <span>üîî</span> Alerts
           {count > 0 && <span className="ml-auto text-xs bg-accent-purple rounded-full px-2">{count}</span>}
         </Link>
         <Link href={`/guilds/${guildId}/manage/data`} ...>
           <span>üìÅ</span> Data
         </Link>
       </>
     )}
     ```
  7. Use the same `cn()` active state pattern as existing nav items: `pathname.includes('/manage/alerts')` and `pathname.includes('/manage/data')`
  8. Ensure the Alerts link is `flex items-center` so the badge aligns properly to the right via `ml-auto`

  Ensure no existing behavior is broken. The Manage section should only appear when: (a) viewing a guild page (`guildId` exists), and (b) user has ADMINISTRATOR permission on that guild.
  </action>
  <verify>
  `npx tsc --noEmit` passes.
  Files exist: `manage/layout.tsx`, `admin-guard.tsx`, `manage-nav.tsx`.
  Sidebar has conditional Manage section with admin check.
  Grep for `0x8` in layout.tsx confirms admin permission check.
  Grep for `manage/alerts` in sidebar.tsx confirms nav links added.
  Grep for `useActiveThresholdCount` in sidebar.tsx confirms badge count is wired.
  </verify>
  <done>
  Manage section is admin-gated: layout checks ADMINISTRATOR permission, sidebar shows Manage nav only to admins, non-admins see 403 page. ManageNav provides Alerts/Data sub-navigation.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes ‚Äî all hooks and components type-clean
- All hook exports match expected API: useAlertThresholds, useCreateThreshold, useToggleThreshold, useDeleteThreshold, useUpdateAlertSettings, useBulkToggleThresholds, useBulkDeleteThresholds, useEmailConfig, useUpdateEmailConfig, useAddRecipient, useRemoveRecipient, useResendVerification, useImportPreview, useConfirmImport
- Manage layout correctly gates on ADMINISTRATOR permission
- Sidebar conditionally shows Manage section for admin users only
- ManageNav has Alerts and Data links with active state
</verification>

<success_criteria>
1. Alert threshold hooks support infinite scroll with filters
2. Email config hooks support full CRUD for config and recipients
3. Import hooks handle multipart upload, POST-SSE streaming, and template download
4. Manage layout renders children for admins and 403 for non-admins
5. Sidebar shows Manage section (Alerts, Data) only for guild admins
6. All code passes TypeScript check
</success_criteria>

<output>
After completion, create `.planning/phases/13-alert-import-management/13-02-SUMMARY.md`
</output>
