---
phase: 08-polish-optimization
plan: 07
type: execute
wave: 3
depends_on: ["08-04", "08-05"]
files_modified:
  - src/components/export/export-history-table.tsx
  - src/app/(dashboard)/guilds/page.tsx
  - src/components/forms/guild-settings-form.tsx
autonomous: true

must_haves:
  truths:
    - "Expired exports show 'Expired' badge and download button is disabled"
    - "Zero-guild state shows clean message: 'You don't have access to any servers'"
    - "Concurrent edit detection warns user if settings changed since page load"
    - "Form validation uses hybrid pattern: validate on submit first, then on blur after first attempt"
  artifacts:
    - path: "src/components/export/export-history-table.tsx"
      provides: "Export history with expired badge and disabled download"
      contains: "expired"
    - path: "src/app/(dashboard)/guilds/page.tsx"
      provides: "Guilds page with zero-guild empty state"
      contains: "don't have access"
    - path: "src/components/forms/guild-settings-form.tsx"
      provides: "Settings form with concurrent edit detection and hybrid validation"
      contains: "stale"
  key_links:
    - from: "src/components/export/export-history-table.tsx"
      to: "ExportRecord.expiresAt"
      via: "date comparison"
      pattern: "expired|expires"
---

<objective>
Handle expired exports, zero-guild state, concurrent edit detection, and form validation improvements.

Purpose: Edge cases that users encounter in production — expired downloads, empty states, conflicting edits, and form UX.
Output: Expired export badges, zero-guild message, concurrent edit warning, hybrid form validation.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-optimization/08-CONTEXT.md
@.planning/phases/08-polish-optimization/08-04-SUMMARY.md
@.planning/phases/08-polish-optimization/08-05-SUMMARY.md

@src/components/export/export-history-table.tsx
@src/app/(dashboard)/guilds/page.tsx
@src/components/forms/guild-settings-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Handle expired exports and zero-guild state</name>
  <files>
    src/components/export/export-history-table.tsx
    src/app/(dashboard)/guilds/page.tsx
  </files>
  <action>
    1. **Expired exports in ExportHistoryTable**:
       - Check if export has an `expiresAt` field or derive expiration from `createdAt` + retention period
       - If export record has a download URL and status is 'completed', check if current date > expiresAt
       - If expired: show "Expired" badge (bg-orange-500/20 text-orange-400) alongside or replacing the "Completed" badge
       - Disable the download button/link for expired exports: add `pointer-events-none opacity-50` classes, remove href
       - Add tooltip or small text: "Export expired. Create a new export."
       - If the API doesn't provide expiresAt, check if there's a status that indicates expiration, or add a client-side check (e.g., exports older than 7 days are considered expired)

    2. **Zero-guild state on guilds page**:
       - Read the current guilds page to understand its structure
       - When guilds list is loaded but empty (data?.guilds?.length === 0 or similar):
         - Show clean centered message: "You don't have access to any servers"
         - Add subtext: "Ask a server admin to grant you access, or make sure you have the correct permissions on Discord."
         - Use the existing EmptyState component pattern if available
         - Style: centered vertically and horizontally, subtle icon (server/globe SVG), muted colors
       - Make sure this doesn't conflict with the loading state (only show when data is loaded AND empty)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Export history table shows expired badge for old exports
    - Download disabled for expired exports
    - Guilds page shows clean message when user has zero guilds
  </verify>
  <done>
    Expired exports show orange "Expired" badge with disabled download. Zero-guild state shows clean message guiding user to get server access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Concurrent edit detection and form validation improvements</name>
  <files>
    src/components/forms/guild-settings-form.tsx
  </files>
  <action>
    1. **Concurrent edit detection**:
       - When GuildSettingsForm receives settings prop, store the settings data timestamp or full settings snapshot as "lastKnownSettings"
       - Before each mutation (channel change), refetch current settings from server (or check query cache freshness)
       - If the settings in cache have changed since the component loaded (compare with stored snapshot), show a warning before saving
       - Implement as: before calling mutation.mutate(), check if queryClient.getQueryData(['guild', guildId]) has different settings than the original props
       - If stale, show a small inline warning: "Settings were updated by another user. Reload to see changes or save to overwrite."
       - Add two buttons in the warning: "Reload" (invalidates query and resets form) and "Save Anyway" (proceeds with mutation)
       - If the backend doesn't return timestamps, compare the full settings object values

    2. **Hybrid form validation** (for GuildSettingsForm):
       - Since this form uses auto-save on channel change (not a submit button), hybrid validation is less applicable here
       - For the concurrent edit detection, the "validation" is checking staleness before save
       - If there are any input fields (text inputs) in settings form, add: validate on submit first, then on blur after first failed attempt
       - If settings form is purely channel selects (auto-save), the concurrent edit detection IS the validation

    Note: The concurrent edit detection should be lightweight. Don't add full optimistic locking — just a simple client-side comparison of the settings snapshot when the component mounted vs current query cache state.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GuildSettingsForm detects when settings changed since load
    - Stale warning shown with Reload/Save Anyway options
  </verify>
  <done>
    GuildSettingsForm detects concurrent edits by comparing settings snapshot on mount vs current cache state before saving. Shows inline warning with Reload/Save Anyway options.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Expired exports clearly indicated with badge and disabled download
- Zero guilds shows clean message
- Settings form warns on concurrent edits
</verification>

<success_criteria>
- Expired exports are visually distinct with disabled download
- Users with no guild access see helpful message, not a blank page
- Concurrent edit detection prevents silent overwrites of other users' changes
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-optimization/08-07-SUMMARY.md`
</output>
