---
phase: 16-restore-nextjs-middleware
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/middleware.ts]
autonomous: true
requirements: [AUTH-03, AUTH-04]

must_haves:
  truths:
    - "CSRF _csrf_token cookie is set on page responses (double-submit pattern active)"
    - "Content-Security-Policy header is present on all page responses with nonce-based script-src"
    - "Unauthenticated requests to /guilds, /settings, /dashboard redirect to /?returnTo=/path at SSR level"
    - "Next.js dev server starts without build errors (no dual middleware/proxy conflict)"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Active Next.js middleware with CSRF, CSP, auth redirect"
      contains: "export async function middleware"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/server/security-headers.ts"
      via: "import { buildCspHeader, getSecurityHeaders }"
      pattern: "import.*buildCspHeader.*security-headers"
    - from: "src/middleware.ts"
      to: "Next.js runtime"
      via: "Named middleware export detected by isMiddlewareFilename()"
      pattern: "export async function middleware"
---

<objective>
Undo the regression from commit 2feb03e that renamed middleware.ts to proxy.ts. Rename src/proxy.ts back to src/middleware.ts and change the exported function name from `proxy` to `middleware`, restoring CSRF cookie issuance, CSP header injection, and auth redirects.

Purpose: Close the remaining AUTH-03 and AUTH-04 gaps by ensuring Next.js middleware is active under the user's locked convention (middleware.ts).
Output: Active src/middleware.ts with all existing security logic intact.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-restore-nextjs-middleware/16-RESEARCH.md
@.planning/phases/15-reactivate-nextjs-middleware/15-01-SUMMARY.md
@.planning/phases/15-reactivate-nextjs-middleware/15-02-SUMMARY.md
@src/proxy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename proxy.ts to middleware.ts and restore middleware export</name>
  <files>src/middleware.ts</files>
  <action>
    1. Rename the file using git mv to preserve history:
       ```bash
       git mv src/proxy.ts src/middleware.ts
       ```

    2. In `src/middleware.ts`, change the function export on line 113 from:
       ```typescript
       export async function proxy(request: NextRequest) {
       ```
       to:
       ```typescript
       export async function middleware(request: NextRequest) {
       ```

    3. Verify no other references to the old function name exist in the file (there should be none — the function is only exported, never called by name internally).

    4. Confirm `src/proxy.ts` no longer exists and `src/middleware.ts` is the only middleware/proxy file (Next.js 16 throws a build error if both exist).

    IMPORTANT: No logic changes. The entire file body stays identical — only the function name changes. Per RESEARCH.md, `middleware.ts` is a deprecated but fully functional convention in Next.js 16.1.6. A deprecation warning in console output is expected and harmless.
  </action>
  <verify>
    - `ls src/middleware.ts` succeeds
    - `ls src/proxy.ts` fails (file removed)
    - `grep "export async function middleware" src/middleware.ts` returns a match
    - `grep "export async function proxy" src/middleware.ts` returns no match
    - `npx tsc --noEmit` has no new errors from source files (ignore auto-generated .next/dev/types errors)
  </verify>
  <done>
    src/middleware.ts exists with `export async function middleware`, src/proxy.ts does not exist, TypeScript compiles without new errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify middleware activation with E2E tests</name>
  <files>e2e/csrf-cookie.spec.ts, e2e/security-headers.spec.ts, e2e/auth-redirect.spec.ts</files>
  <action>
    Run the existing Playwright E2E tests from Phase 15 to verify middleware is active. These tests check observable behavior (cookies, headers, redirects) and will confirm the rename restored functionality.

    Use Playwright API directly (not the test runner) since the test runner hangs in sandbox environments (documented in Phase 15-02 SUMMARY). Write a quick verification script that:

    1. Launches Chromium headless via Playwright
    2. Navigates to /login and checks:
       - `_csrf_token` cookie is set (AUTH-03)
       - `Content-Security-Policy` header is present with nonce (AUTH-04)
       - `X-Request-ID` header is present
    3. Makes an unauthenticated request to /guilds and checks:
       - 307 redirect status
       - Location header contains `returnTo`
    4. Reports pass/fail for each assertion

    NOTE: This requires the dev server to be running on localhost:3001. If the dev server is not running, start it with `npm run dev` in background and wait for it to be ready before testing.

    If E2E cannot run (no dev server, port conflict, etc.), fall back to static verification:
    - Confirm file exists and has correct export
    - Confirm TypeScript compiles
    - Confirm no dual middleware/proxy files exist
    - Document that runtime verification should be done manually by the user
  </action>
  <verify>
    - E2E assertions pass: CSRF cookie set, CSP header present, auth redirect works
    - OR static verification confirms correct file structure if E2E cannot run
  </verify>
  <done>
    Middleware activation confirmed via E2E tests showing _csrf_token cookie, Content-Security-Policy header, and auth redirect all working. All Phase 16 success criteria met: AUTH-03 (CSRF) and AUTH-04 (CSP) are satisfied.
  </done>
</task>

</tasks>

<verification>
1. `src/middleware.ts` exists with `export async function middleware` (not proxy.ts/proxy)
2. `_csrf_token` cookie is set on page responses (CSRF double-submit pattern active)
3. `Content-Security-Policy` header is present on all page responses
4. Auth redirect happens at SSR level for unauthenticated requests to protected routes
5. No TypeScript compilation errors introduced
</verification>

<success_criteria>
- src/middleware.ts is the sole middleware file with named `middleware` export
- E2E tests (or static verification) confirm CSRF cookie, CSP header, and auth redirect are functional
- AUTH-03 and AUTH-04 requirements are satisfied
- No logic changes from the existing proxy.ts implementation
</success_criteria>

<output>
After completion, create `.planning/phases/16-restore-nextjs-middleware/16-01-SUMMARY.md`
</output>
