---
phase: 10-frontend-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/error-sanitizer.ts
  - src/app/api/guilds/route.ts
  - src/app/api/guilds/[guildId]/route.ts
  - src/app/api/guilds/[guildId]/settings/route.ts
  - src/app/api/guilds/[guildId]/accounts/route.ts
  - src/app/api/guilds/[guildId]/accounts/[accountId]/route.ts
  - src/app/api/guilds/[guildId]/brands/route.ts
  - src/app/api/guilds/[guildId]/brands/[brandId]/route.ts
  - src/app/api/guilds/[guildId]/posts/route.ts
  - src/app/api/guilds/[guildId]/channels/route.ts
  - src/app/api/guilds/[guildId]/usage/route.ts
  - src/app/api/guilds/[guildId]/audit-log/route.ts
  - src/app/api/guilds/[guildId]/analytics/route.ts
  - src/app/api/guilds/[guildId]/analytics/activity/route.ts
  - src/app/api/guilds/[guildId]/analytics/leaderboard/route.ts
  - src/app/api/guilds/[guildId]/analytics/top-accounts/route.ts
  - src/app/api/guilds/[guildId]/analytics/weekly-submissions/route.ts
  - src/app/api/guilds/[guildId]/status/route.ts
  - src/app/api/guilds/[guildId]/exports/route.ts
  - src/app/api/guilds/[guildId]/exports/[exportId]/route.ts
  - src/app/api/guilds/[guildId]/bulk/delete/route.ts
  - src/app/api/guilds/[guildId]/bulk/reassign/route.ts
  - src/app/api/guilds/[guildId]/trash/route.ts
  - src/app/api/guilds/[guildId]/trash/[itemId]/route.ts
  - src/app/api/guilds/[guildId]/trash/[itemId]/restore/route.ts
autonomous: true

must_haves:
  truths:
    - "Backend error responses never contain stack traces, file paths, or internal implementation details"
    - "User sees contextual error messages describing WHAT failed (e.g., 'Failed to load tracking data', 'Could not save settings')"
    - "Error codes from the backend are preserved for client-side logic (e.g., unverified_email, EBADCSRFTOKEN)"
    - "Catch blocks never leak raw error objects or strings to the client"
  artifacts:
    - path: "src/lib/server/error-sanitizer.ts"
      provides: "Error sanitization utility with contextual message mapping"
      exports: ["sanitizeError", "SanitizedError"]
    - path: "src/app/api/guilds/[guildId]/settings/route.ts"
      provides: "Settings proxy route with sanitized error responses"
      contains: "sanitizeError"
  key_links:
    - from: "src/app/api/guilds/[guildId]/settings/route.ts"
      to: "src/lib/server/error-sanitizer.ts"
      via: "import sanitizeError"
      pattern: "sanitizeError"
    - from: "src/app/api/guilds/[guildId]/accounts/route.ts"
      to: "src/lib/server/error-sanitizer.ts"
      via: "import sanitizeError"
      pattern: "sanitizeError"
---

<objective>
Sanitize all backend error responses in the proxy layer so no stack traces, file paths, or internal details leak to the client.

Purpose: Prevent information leakage (AUTH-05). Currently, API routes forward raw backend error responses (`return NextResponse.json(data, { status: response.status })`), which may contain Prisma error messages, internal paths, or stack traces. This plan creates a sanitization utility and applies it to all proxy routes.

Output: Error sanitizer utility at `src/lib/server/error-sanitizer.ts`, all guild API routes updated to sanitize error responses before returning to client.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-frontend-security-hardening/10-CONTEXT.md
@.planning/phases/10-frontend-security-hardening/10-RESEARCH.md
@src/app/api/guilds/[guildId]/settings/route.ts
@src/app/api/guilds/[guildId]/accounts/route.ts
@src/app/api/guilds/[guildId]/brands/route.ts
@src/app/api/guilds/[guildId]/bulk/delete/route.ts
@src/app/api/guilds/[guildId]/exports/route.ts
@src/lib/server/backend-fetch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error sanitizer utility</name>
  <files>src/lib/server/error-sanitizer.ts</files>
  <action>
Create `src/lib/server/error-sanitizer.ts` with the following:

1. Define types:
   ```typescript
   interface BackendError {
     message?: string;
     error?: string;
     code?: string;
     stack?: string;
     details?: unknown;
     statusCode?: number;
   }

   export interface SanitizedError {
     error: string;  // Use "error" key to match existing codebase convention (routes use { error: '...' })
     code?: string;
   }
   ```

2. Create a map of known backend error codes to user-friendly messages:
   ```typescript
   const FRIENDLY_MESSAGES: Record<string, string> = {
     'GUILD_NOT_FOUND': 'Server not found',
     'ACCOUNT_NOT_FOUND': 'Account not found',
     'BRAND_NOT_FOUND': 'Brand not found',
     'INSUFFICIENT_PERMISSIONS': "You don't have permission to perform this action",
     'VALIDATION_ERROR': 'Invalid input provided',
     'RATE_LIMIT_EXCEEDED': 'Too many requests. Please try again later',
     'DUPLICATE_ENTRY': 'This item already exists',
     'NOT_FOUND': 'Resource not found',
     'UNAUTHORIZED': 'Authentication required',
     'FORBIDDEN': 'Access denied',
     'unverified_email': 'Email verification required',
   };
   ```

3. Create a function to detect if a message is safe to forward:
   ```typescript
   function isMessageSafe(message: string): boolean {
     if (!message || message.length > 200) return false;
     // Block stack traces, file paths, internal errors
     const unsafePatterns = [
       /at\s+\w+\s*\(/,        // Stack trace lines: "at Function ("
       /\/[\w.-]+\/[\w.-]+/,    // File paths: /src/lib/...
       /Error:\s/,              // Error class names: "PrismaClientKnownRequestError: ..."
       /ECONNREFUSED/,          // Network errors
       /ETIMEDOUT/,             // Timeout errors
       /prisma/i,               // Prisma internals
       /\\n\s+at\s/,            // Multi-line stack traces
       /column\s+"?\w+"?\s/i,   // Database column references
       /relation\s+"?\w+"?\s/i, // Database relation references
       /constraint\s+"?\w+"?\s/i, // Database constraint references
     ];
     return !unsafePatterns.some(pattern => pattern.test(message));
   }
   ```

4. Create the main `sanitizeError` function:
   ```typescript
   export function sanitizeError(
     statusCode: number,
     backendResponse: unknown,
     context: string
   ): SanitizedError {
     // Parse backend response -- could be object, string, or undefined
     const parsed: BackendError = typeof backendResponse === 'object' && backendResponse !== null
       ? backendResponse as BackendError
       : {};

     const code = parsed.code;

     // Preserve known error codes for client-side logic
     // (e.g., 'unverified_email' triggers redirect in fetchWithRetry)
     if (code && FRIENDLY_MESSAGES[code]) {
       return { error: FRIENDLY_MESSAGES[code], code };
     }

     // Check if the backend message is safe to forward
     const backendMsg = parsed.message || parsed.error || '';
     if (backendMsg && isMessageSafe(backendMsg)) {
       return { error: backendMsg, ...(code && { code }) };
     }

     // Fallback to contextual generic messages per user decision:
     // "Contextual error messages that describe WHAT failed"
     const contextualMessages: Record<number, (ctx: string) => string> = {
       400: (ctx) => `Invalid ${ctx} data`,
       403: (ctx) => `You don't have permission to ${ctx}`,
       404: (ctx) => `${ctx} not found`,
       409: (ctx) => `Conflict while trying to ${ctx}`,
       422: (ctx) => `Invalid ${ctx} data`,
       429: () => 'Too many requests. Please try again later',
       500: (ctx) => `Failed to ${ctx}`,
       502: (ctx) => `${ctx} service unavailable`,
       503: (ctx) => `${ctx} service temporarily unavailable`,
     };

     const getMessage = contextualMessages[statusCode] || contextualMessages[500];
     return { error: getMessage(context), ...(code && { code }) };
   }
   ```

5. Create a helper for catch blocks (internal errors that should NEVER leak):
   ```typescript
   export function internalError(context: string): SanitizedError {
     return { error: `Failed to ${context}` };
   }
   ```

Per user decision: contextual error messages that describe WHAT failed, no stack traces or internal paths, no generic "something went wrong".
  </action>
  <verify>
1. `npx tsc --noEmit` passes.
2. Verify the module exports correctly by checking imports resolve.
  </verify>
  <done>
Error sanitizer utility exists with `sanitizeError()` for backend errors and `internalError()` for catch blocks. Known error codes map to friendly messages. Unsafe patterns (stack traces, file paths, Prisma errors) are detected and blocked.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply error sanitization to all guild API proxy routes</name>
  <files>
src/app/api/guilds/route.ts
src/app/api/guilds/[guildId]/route.ts
src/app/api/guilds/[guildId]/settings/route.ts
src/app/api/guilds/[guildId]/accounts/route.ts
src/app/api/guilds/[guildId]/accounts/[accountId]/route.ts
src/app/api/guilds/[guildId]/brands/route.ts
src/app/api/guilds/[guildId]/brands/[brandId]/route.ts
src/app/api/guilds/[guildId]/posts/route.ts
src/app/api/guilds/[guildId]/channels/route.ts
src/app/api/guilds/[guildId]/usage/route.ts
src/app/api/guilds/[guildId]/audit-log/route.ts
src/app/api/guilds/[guildId]/analytics/route.ts
src/app/api/guilds/[guildId]/analytics/activity/route.ts
src/app/api/guilds/[guildId]/analytics/leaderboard/route.ts
src/app/api/guilds/[guildId]/analytics/top-accounts/route.ts
src/app/api/guilds/[guildId]/analytics/weekly-submissions/route.ts
src/app/api/guilds/[guildId]/status/route.ts
src/app/api/guilds/[guildId]/exports/route.ts
src/app/api/guilds/[guildId]/exports/[exportId]/route.ts
src/app/api/guilds/[guildId]/bulk/delete/route.ts
src/app/api/guilds/[guildId]/bulk/reassign/route.ts
src/app/api/guilds/[guildId]/trash/route.ts
src/app/api/guilds/[guildId]/trash/[itemId]/route.ts
src/app/api/guilds/[guildId]/trash/[itemId]/restore/route.ts
  </files>
  <action>
For EACH guild API route file listed above, apply two changes:

**Change 1: Sanitize backend error responses (non-ok responses)**

Current pattern (UNSAFE -- forwards raw backend data):
```typescript
const data = await response.json()
return NextResponse.json(data, { status: response.status })
```

New pattern (SAFE -- sanitizes on error, passes through on success):
```typescript
const data = await response.json()
if (!response.ok) {
  const sanitized = sanitizeError(response.status, data, '{context}')
  return NextResponse.json(sanitized, { status: response.status })
}
return NextResponse.json(data)
```

The `{context}` string should be a lowercase action description specific to each route handler. Examples:
- `GET /guilds` -> `'load servers'`
- `GET /guilds/[guildId]` -> `'load server details'`
- `PATCH /guilds/[guildId]/settings` -> `'update settings'`
- `GET /guilds/[guildId]/accounts` -> `'load accounts'`
- `POST /guilds/[guildId]/accounts` -> `'add account'`
- `DELETE /guilds/[guildId]/accounts/[accountId]` -> `'delete account'`
- `GET /guilds/[guildId]/brands` -> `'load brands'`
- `POST /guilds/[guildId]/brands` -> `'add brand'`
- `DELETE /guilds/[guildId]/brands/[brandId]` -> `'delete brand'`
- `GET /guilds/[guildId]/posts` -> `'load posts'`
- `GET /guilds/[guildId]/channels` -> `'load channels'`
- `GET /guilds/[guildId]/usage` -> `'load usage data'`
- `GET /guilds/[guildId]/audit-log` -> `'load audit log'`
- `GET /guilds/[guildId]/analytics` -> `'load analytics'`
- `GET /guilds/[guildId]/analytics/activity` -> `'load activity data'`
- `GET /guilds/[guildId]/analytics/leaderboard` -> `'load leaderboard'`
- `GET /guilds/[guildId]/analytics/top-accounts` -> `'load top accounts'`
- `GET /guilds/[guildId]/analytics/weekly-submissions` -> `'load weekly submissions'`
- `GET /guilds/[guildId]/status` -> `'load server status'`
- `POST /guilds/[guildId]/exports` -> `'create export'`
- `GET /guilds/[guildId]/exports` -> `'load export history'`
- `GET /guilds/[guildId]/exports/[exportId]` -> `'load export details'`
- `POST /guilds/[guildId]/bulk/delete` -> `'bulk delete'`
- `POST /guilds/[guildId]/bulk/reassign` -> `'bulk reassign'`
- `GET /guilds/[guildId]/trash` -> `'load trash'`
- `DELETE /guilds/[guildId]/trash/[itemId]` -> `'permanently delete item'`
- `POST /guilds/[guildId]/trash/[itemId]/restore` -> `'restore item'`

**Change 2: Replace catch block error messages with internalError()**

Current pattern (some routes leak error details):
```typescript
} catch (error) {
  console.error('Export API error:', error)
  return NextResponse.json({ error: 'Failed to create export', details: String(error) }, { status: 500 })
}
```

New pattern (SAFE):
```typescript
} catch {
  return NextResponse.json(internalError('{context}'), { status: 500 })
}
```

Remove ANY `console.error` that includes the raw error object (it's fine to log but do NOT return error details to client). Remove any `details: String(error)` or similar patterns that expose internals.

**Change 3: Add import to each file**

Add at the top of each route file:
```typescript
import { sanitizeError, internalError } from '@/lib/server/error-sanitizer'
```

**Routes to SKIP (do NOT modify):**
- `src/app/api/auth/*` routes -- these handle their own auth flow errors and should NOT be sanitized (they return specific auth error codes needed by the client).
- `src/app/api/guilds/[guildId]/status/stream/route.ts` -- SSE streaming, returns plain text, already sanitized.
- `src/app/api/guilds/[guildId]/exports/[exportId]/progress/route.ts` -- SSE streaming, returns plain text, already sanitized.
- `src/app/api/user/route.ts` -- user profile endpoint, review but likely skip.

NOTE: The existing exports route (`src/app/api/guilds/[guildId]/exports/route.ts`) has a catch block that leaks `details: String(error)` -- this MUST be fixed.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no type errors.
2. `npm run build` completes successfully.
3. Verify no route returns raw `data` on error paths -- search for the pattern: every `!response.ok` check should use `sanitizeError`, every `catch` should use `internalError`.
4. Verify no `details: String(error)` or similar patterns remain in route files.
  </verify>
  <done>
All guild API proxy routes sanitize error responses: backend errors go through sanitizeError() with contextual messages, catch blocks use internalError(). No stack traces, file paths, or internal details can leak to the client. The exports route no longer leaks `details: String(error)`.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes.
- No API route returns raw backend error data on failure paths.
- Error responses contain contextual user-friendly messages (e.g., "Failed to load accounts", "Could not update settings").
- Error codes (e.g., `unverified_email`) are preserved for client-side logic.
- Stack traces, file paths, Prisma errors, and database details are blocked by unsafe pattern detection.
- SSE/streaming routes and auth routes are unchanged.
</verification>

<success_criteria>
1. Error sanitizer utility exists at `src/lib/server/error-sanitizer.ts` with `sanitizeError()` and `internalError()` exports.
2. All guild API proxy routes import and use the sanitizer for error responses.
3. No route file contains `details: String(error)` or forwards raw backend error data on `!response.ok`.
4. Known error codes (unverified_email, CSRF codes) are preserved in sanitized responses.
5. Build succeeds with no TypeScript errors.
</success_criteria>

<output>
After completion, create `.planning/phases/10-frontend-security-hardening/10-02-SUMMARY.md`
</output>
