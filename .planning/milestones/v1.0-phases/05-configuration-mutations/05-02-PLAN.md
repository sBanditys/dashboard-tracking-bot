---
phase: 05-configuration-mutations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/channel-select.tsx
  - src/app/api/guilds/[guildId]/channels/route.ts
  - src/hooks/use-guilds.ts
  - src/types/guild.ts
autonomous: true

must_haves:
  truths:
    - "User can search channels by typing in combobox"
    - "Only text channels are shown (type 0)"
    - "Channels without bot permission show warning"
  artifacts:
    - path: "src/components/ui/channel-select.tsx"
      provides: "Searchable Discord channel combobox"
      min_lines: 60
    - path: "src/app/api/guilds/[guildId]/channels/route.ts"
      provides: "GET endpoint for Discord channels"
      exports: ["GET"]
    - path: "src/hooks/use-guilds.ts"
      provides: "useGuildChannels query hook"
      exports: ["useGuildChannels"]
    - path: "src/types/guild.ts"
      provides: "Channel and ChannelsResponse types"
      contains: "interface Channel"
  key_links:
    - from: "src/components/ui/channel-select.tsx"
      to: "@headlessui/react"
      via: "Combobox import"
      pattern: "Combobox.*from.*@headlessui/react"
    - from: "src/hooks/use-guilds.ts"
      to: "/api/guilds/:guildId/channels"
      via: "fetch in useGuildChannels"
      pattern: "fetch.*api/guilds.*channels"
---

<objective>
Create the searchable channel selection combobox and supporting infrastructure.

Purpose: Enable Discord channel selection for notification settings (CONF-04). The combobox filters as you type per CONTEXT.md decision, shows only text channels, and warns about potential permission issues.

Output: ChannelSelect component using Headless UI Combobox, useGuildChannels hook, and GET proxy route for channels.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-mutations/05-CONTEXT.md
@.planning/phases/05-configuration-mutations/05-RESEARCH.md

# Existing patterns
@src/components/filters/status-select.tsx
@src/hooks/use-guilds.ts
@src/app/api/guilds/[guildId]/accounts/route.ts
@src/types/guild.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Channel Types</name>
  <files>src/types/guild.ts</files>
  <action>
Add Channel and ChannelsResponse types to the existing guild.ts file.

```typescript
export interface Channel {
  id: string
  name: string
  type: number  // 0 = text, 2 = voice, 4 = category, 5 = announcement
  bot_has_access: boolean
}

export interface ChannelsResponse {
  channels: Channel[]
}
```

Add these at the end of the file after the existing types.
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`. Types are exported from src/types/guild.ts.
  </verify>
  <done>
Channel and ChannelsResponse types exported from guild.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Channels API Route and Hook</name>
  <files>
src/app/api/guilds/[guildId]/channels/route.ts
src/hooks/use-guilds.ts
  </files>
  <action>
**Create channels/route.ts:**
Following the existing proxy pattern (see accounts/route.ts):
- Type RouteParams = { params: Promise<{ guildId: string }> }
- Export async function GET(request: NextRequest, { params }: RouteParams)
- Extract token from cookies, return 401 if missing
- Forward to `${API_URL}/api/v1/guilds/${guildId}/channels`
- Return response status and body
- Error: "Failed to fetch channels"

**Add useGuildChannels to use-guilds.ts:**
```typescript
import type { ChannelsResponse } from '@/types/guild'

export function useGuildChannels(guildId: string) {
  return useQuery<ChannelsResponse>({
    queryKey: ['guild', guildId, 'channels'],
    queryFn: async () => {
      const response = await fetch(`/api/guilds/${guildId}/channels`)
      if (!response.ok) {
        throw new Error('Failed to fetch channels')
      }
      return response.json()
    },
    staleTime: 5 * 60 * 1000, // 5 minutes - channels don't change often
    enabled: !!guildId,
  })
}
```
  </action>
  <verify>
Files exist. TypeScript compilation passes: `npx tsc --noEmit`. Route at src/app/api/guilds/[guildId]/channels/route.ts, hook exported from use-guilds.ts.
  </verify>
  <done>
GET /api/guilds/:guildId/channels proxy route and useGuildChannels hook exist.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ChannelSelect Component</name>
  <files>src/components/ui/channel-select.tsx</files>
  <action>
Create a searchable channel combobox using Headless UI Combobox. Follow these specifications from RESEARCH.md Pattern 3:

**Props interface:**
```typescript
interface ChannelSelectProps {
  channels: Channel[]  // Pass channels from useGuildChannels
  value: string | null
  onChange: (channelId: string | null) => void
  placeholder?: string
  className?: string
}
```

**Implementation:**
- 'use client' directive
- Import Combobox, ComboboxInput, ComboboxOptions, ComboboxOption, ComboboxButton from @headlessui/react
- Use useState for query string
- Filter to text channels only (type === 0) using useMemo
- Filter by query string (case-insensitive includes on channel.name)
- Display format: # channel-name
- Show permission warning inline: "(may lack permissions)" in text-yellow-500 text-xs when !bot_has_access

**Styling (match status-select.tsx):**
- Input: w-full py-3 pl-3 pr-10 bg-surface border border-border rounded-lg text-sm text-gray-300
- Input placeholder styling
- Chevron button on right side
- Options dropdown: absolute z-20 mt-1 w-full bg-surface border border-border rounded-lg shadow-lg max-h-60 overflow-auto
- Option: py-3 px-4 text-sm text-gray-300 data-[focus]:bg-background cursor-pointer

Include ComboboxButton with chevron SVG icon (copy from status-select.tsx).
  </action>
  <verify>
File exists at src/components/ui/channel-select.tsx. TypeScript compilation passes: `npx tsc --noEmit`. Component filters to type === 0 channels only.
  </verify>
  <done>
ChannelSelect component exists with searchable combobox, text-channel filtering, and permission warnings.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. Channel types exist in guild.ts
3. useGuildChannels hook is importable from use-guilds.ts
4. ChannelSelect component exports correctly
5. Combobox filters channels as you type (visible in code: query filter logic)
</verification>

<success_criteria>
- Channel and ChannelsResponse types exported from guild.ts
- GET /api/guilds/:guildId/channels proxy route exists
- useGuildChannels hook exists in use-guilds.ts
- ChannelSelect component uses Headless UI Combobox with search filtering
- Only text channels (type 0) shown
- Permission warning displayed for channels without bot access
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-mutations/05-02-SUMMARY.md`
</output>
