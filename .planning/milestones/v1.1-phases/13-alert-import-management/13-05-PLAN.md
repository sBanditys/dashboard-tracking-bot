---
phase: 13-alert-import-management
plan: 05
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - src/app/(dashboard)/guilds/[guildId]/manage/data/page.tsx
  - src/components/import-export/import-tab.tsx
  - src/components/import-export/upload-zone.tsx
  - src/components/import-export/import-validation-display.tsx
  - src/components/import-export/import-history.tsx
autonomous: true
requirements: [IMPEX-02, IMPEX-03, IMPEX-04]

must_haves:
  truths:
    - "Admin can drag and drop a CSV file for import preview"
    - "Upload zone validates file type and size before sending to backend"
    - "Admin sees validation preview showing valid/invalid rows with errors"
    - "Admin can confirm import and see real-time progress bar via SSE"
    - "User can download CSV import template"
    - "Admin sees import history with date, count, and status"
    - "Concurrent import shows blocking message (409 handling)"
  artifacts:
    - path: "src/app/(dashboard)/guilds/[guildId]/manage/data/page.tsx"
      provides: "Data page shell with Import/Export tabs"
      contains: "Import"
    - path: "src/components/import-export/upload-zone.tsx"
      provides: "Drag and drop upload zone with file validation"
      exports: ["UploadZone"]
    - path: "src/components/import-export/import-validation-display.tsx"
      provides: "Validation preview showing valid/invalid rows"
      exports: ["ImportValidationDisplay"]
    - path: "src/components/import-export/import-tab.tsx"
      provides: "Complete import flow: upload, validate, confirm, progress"
      exports: ["ImportTab"]
  key_links:
    - from: "src/components/import-export/import-tab.tsx"
      to: "src/hooks/use-import.ts"
      via: "useImportPreview and useConfirmImport"
      pattern: "useImportPreview|useConfirmImport"
    - from: "src/components/import-export/upload-zone.tsx"
      to: "src/components/import-export/import-tab.tsx"
      via: "onFileSelected callback"
      pattern: "onFileSelected"
---

<objective>
Build the data management page shell and the import tab with drag-and-drop upload, validation preview, confirmation dialog, real-time progress tracking, and import history.

Purpose: Enable admins to import accounts via CSV with full validation and progress feedback.

Output: Data page at `/guilds/[guildId]/manage/data` with Import tab fully functional.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-alert-import-management/13-RESEARCH.md
@.planning/phases/13-alert-import-management/13-01-SUMMARY.md
@.planning/phases/13-alert-import-management/13-02-SUMMARY.md

Key reference files:
@src/hooks/use-import.ts (from Plan 02)
@src/types/import.ts (from Plan 01)
@src/components/ui/confirmation-modal.tsx (existing)
@src/components/empty-state.tsx (existing)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upload zone and validation display components</name>
  <files>
    src/components/import-export/upload-zone.tsx
    src/components/import-export/import-validation-display.tsx
  </files>
  <action>
  **Create `src/components/import-export/upload-zone.tsx`:**

  A `'use client'` component for drag-and-drop CSV file upload (locked decisions: drag & drop on desktop, tap-to-upload on mobile, client pre-check for file type and CSV structure).

  Props: `onFileSelected: (file: File) => void`, `disabled?: boolean`, `error?: string | null`

  Implementation using native HTML drag events (NO react-dropzone — per research, no external library):

  1. **Hidden file input:** `<input type="file" accept=".csv" ref={fileInputRef} className="sr-only" />` with `onChange` handler.

  2. **Drop zone container:** Large dashed-border area with upload icon.
     - Default state: `border-2 border-dashed border-border rounded-lg p-8` with upload cloud icon (lucide-react `Upload`), "Drag & drop your CSV file here" text, and "or browse" button.
     - Drag hover state: `border-accent-purple bg-accent-purple/5` — detect via `onDragOver`/`onDragLeave`/`onDrop`.
     - Error state (locked decision): `border-red-500 bg-red-500/5` with error message displayed.
     - Disabled state: reduced opacity, pointer-events-none.

  3. **Client pre-checks** (locked decisions):
     - File type: must be `.csv` or `text/csv` MIME type. If not: set error "Only CSV files are supported".
     - File size: must be under 1MB. If not: set error "File must be under 1MB".
     - Basic CSV structure: read first line and check for comma-separated values (at least 2 columns). If not: set error "File does not appear to be a valid CSV".

  4. **Limits display** (locked decision): Show "500 rows max, 1MB file size limit" as muted text below the drop zone.

  5. **Keyboard accessibility** (locked decision): Visible "Browse file" button that triggers hidden input click. Button is focusable and Enter-activatable.

  6. **Mobile:** On touch devices, show just the "Tap to upload" button (hide "drag & drop" text). Detect with `@media (pointer: coarse)` via Tailwind `pointer-coarse:` or check in JS.

  **Create `src/components/import-export/import-validation-display.tsx`:**

  A `'use client'` component displaying the validation preview after CSV upload.

  Props: `preview: ImportPreview`, `onConfirm: () => void`, `onCancel: () => void`, `isConfirming: boolean`

  Layout:
  1. **Summary bar:** "X valid rows, Y invalid rows of Z total" with green/red counts.

  2. **If all rows valid** (locked decision: all-or-nothing validation):
     - Show success message: "All rows validated successfully"
     - Show sample preview: first 5 rows in a compact table (username, platform, brand, group columns)
     - Show "Import {N} accounts" confirm button + "Cancel" button

  3. **If any invalid rows:**
     - Show error message: "X rows have validation errors. All rows must be valid to proceed."
     - Show error list: table/cards showing each invalid row with row number, column, error message, and the problematic value
     - Highlight errors with red text/background
     - "Upload corrected file" button (calls onCancel to go back to upload zone)
     - No confirm button available (all-or-nothing)

  4. **Confirm button** triggers `onConfirm`. Show loading state while `isConfirming` is true.

  Style: `bg-surface border border-border rounded-lg` with proper sections separated by borders. Error rows use `bg-red-500/5` background. Valid summary uses green accent.

  Mobile: Error table uses horizontal scroll or converts to card layout (Claude's discretion: use horizontal scroll with `overflow-x-auto` for simplicity).
  </action>
  <verify>
  `npx tsc --noEmit` passes.
  Files exist: `upload-zone.tsx`, `import-validation-display.tsx`.
  Grep for `onDragOver` in upload-zone confirms drag event handling.
  Grep for `1MB` or `1024 * 1024` confirms file size check.
  Grep for `all-or-nothing` or invalid row check in validation display.
  </verify>
  <done>
  Upload zone supports drag-and-drop with file type/size validation and error states. Validation display shows valid/invalid rows, blocks import when errors exist, shows sample preview when all valid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build import tab, data page shell, and import history</name>
  <files>
    src/components/import-export/import-tab.tsx
    src/components/import-export/import-history.tsx
    src/app/(dashboard)/guilds/[guildId]/manage/data/page.tsx
  </files>
  <action>
  **Create `src/components/import-export/import-tab.tsx`:**

  A `'use client'` component orchestrating the full import flow.

  Props: `guildId: string`

  Uses hooks: `useImportPreview`, `useConfirmImport`, import template download function from `@/hooks/use-import`.

  Flow states (managed via local state machine):
  1. **Upload state:** Show `UploadZone` + "Download template" button. Template button calls the download function from `useImportTemplate`.
  2. **Validating state:** Show spinner + "Validating CSV..." message while `useImportPreview` mutation is in progress.
  3. **Preview state:** Show `ImportValidationDisplay` with the preview data. If all valid: confirm/cancel buttons. If errors: upload corrected file button.
  4. **Confirming state:** Show extra confirmation dialog (locked decision): "Import {N} accounts?" with Cancel/Confirm buttons. Use the existing `ConfirmationModal` from `@/components/ui/confirmation-modal`.
  5. **Importing state:** Show progress bar with real-time SSE updates.
     - Progress bar: animated, shows "{processed}/{total} accounts imported" with percentage
     - Use ARIA live region: announce at 25%, 50%, 75%, 100% milestones (locked decision)
     - Progress bar color: purple accent. On error: turns red.
  6. **Complete state:** Show success summary — "X accounts imported successfully" with link to view accounts page (`/guilds/${guildId}/accounts`). If partial failure: show error count too.
  7. **Error state:** Progress bar turns red + error message + "Try again" button that resets to upload state.

  **409 Conflict handling** (concurrent import lock):
  - When the preview or confirm API returns 409, show blocking message: "An import is currently in progress. Please wait for it to complete."
  - Disable the upload zone
  - Show "Check status" button that re-attempts the request

  On file selected:
  1. Call `useImportPreview.mutateAsync` with FormData
  2. On success: transition to preview state
  3. On error: show error in upload zone

  On confirm:
  1. Open extra confirmation dialog
  2. On dialog confirm: call `useConfirmImport.confirm(importId)`
  3. SSE events update progress state
  4. On complete event: transition to complete state

  **Create `src/components/import-export/import-history.tsx`:**

  A `'use client'` component showing recent imports below the upload area (locked decision).

  Props: `guildId: string`

  For now, this component renders a list of import history entries. Since the backend may not have a dedicated import history endpoint, check if one exists. If not, show a stub with "Import history will appear here" message. If the backend does provide import history in the import preview response or via audit log, use that data.

  Each entry shows: date, filename, row count, status (completed/failed/partial) with colored badge, created by username.

  Paginated: 20 items per page with simple prev/next buttons.

  **Create `src/app/(dashboard)/guilds/[guildId]/manage/data/page.tsx`:**

  A `'use client'` page component with Import and Export tabs.

  Layout:
  1. **Page header:** "Data Management" title
  2. **Tab navigation:** Two tabs: "Import" and "Export" — Use segmented button group (same styling as other tab UIs in the project). Active tab has `bg-accent-purple text-white`. Tab switch has slide left/right transition (locked decision): use `transition-transform duration-200` on a sliding indicator.
  3. **Tab content:**
     - Import tab: render `<ImportTab guildId={guildId} />`
     - Export tab: render placeholder "Export tab coming soon" (will be implemented in Plan 06)

  Tab state: managed via URL search param or local state. Prefer local state with `useState<'import' | 'export'>('import')`.

  The page is wrapped by the manage layout which already handles admin gating.
  </action>
  <verify>
  `npx tsc --noEmit` passes.
  Files exist: `import-tab.tsx`, `import-history.tsx`, `manage/data/page.tsx`.
  Grep for `useImportPreview` in import-tab confirms upload flow.
  Grep for `useConfirmImport` in import-tab confirms SSE progress flow.
  Grep for `aria-live` or `role="progressbar"` in import-tab confirms ARIA progress announcements.
  Grep for `409` in import-tab confirms concurrent import handling.
  Data page has Import/Export tabs with slide transition.
  </verify>
  <done>
  Import tab has: drag-and-drop upload with client pre-checks, validation preview (all-or-nothing), extra confirmation dialog, real-time SSE progress bar with ARIA announcements, completion summary, 409 conflict handling. Import history shows recent imports. Data page has tabbed layout with Import/Export tabs.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Upload zone handles drag-and-drop with file validation
- CSV client pre-check catches wrong file type and oversized files
- Validation display correctly shows valid/invalid rows
- Import confirm shows progress bar with live SSE updates
- 409 Conflict shows blocking message
- Template download triggers file download
- Data page tabs switch between Import and Export
</verification>

<success_criteria>
1. Drag-and-drop upload zone validates file type and size
2. Validation preview shows all errors when rows are invalid
3. All-or-nothing: import blocked if any rows invalid
4. Extra confirmation dialog before starting import
5. Real-time progress bar with SSE streaming during import
6. ARIA live region announcements at 25/50/75/100%
7. Success summary with link to view imported accounts
8. Template download works
9. Import history shows below upload area
10. Tab navigation with Import/Export switching
</success_criteria>

<output>
After completion, create `.planning/phases/13-alert-import-management/13-05-SUMMARY.md`
</output>
