---
phase: 12-bonus-system
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/app/(dashboard)/guilds/[guildId]/bonus/page.tsx
  - src/components/bonus/rounds-tab.tsx
  - src/components/bonus/round-card.tsx
  - src/components/bonus/round-card-skeleton.tsx
  - src/components/bonus/targets-tab.tsx
  - src/components/bonus/payments-tab.tsx
  - src/components/bonus/results-tab.tsx
  - src/components/layout/sidebar.tsx
autonomous: true
requirements:
  - BONUS-01
  - BONUS-02
  - BONUS-04
  - BONUS-05
  - BONUS-06

must_haves:
  truths:
    - "User can view paginated list of bonus rounds with status indicators and filter tabs"
    - "User can click a round card to expand it inline showing Targets, Payments, and Results tabs"
    - "Admin can toggle individual payment status with optimistic UI and undo for reversals"
    - "Admin can bulk-update all payments with confirmation dialog"
    - "User can view round results with summary stats, progress bars, and near-miss highlighting"
    - "Bonus page is accessible from sidebar navigation"
  artifacts:
    - path: "src/app/(dashboard)/guilds/[guildId]/bonus/page.tsx"
      provides: "Main bonus page with Rounds/Leaderboard top-level tabs"
      contains: "BonusPage"
    - path: "src/components/bonus/rounds-tab.tsx"
      provides: "Rounds list with filter tabs and Load More"
      contains: "RoundsTab"
    - path: "src/components/bonus/round-card.tsx"
      provides: "Collapsible card with inner tabs"
      contains: "RoundCard"
    - path: "src/components/bonus/payments-tab.tsx"
      provides: "Payment toggles with optimistic updates"
      contains: "PaymentsTab"
    - path: "src/components/bonus/results-tab.tsx"
      provides: "Results visualization with progress bars"
      contains: "ResultsTab"
  key_links:
    - from: "src/components/bonus/rounds-tab.tsx"
      to: "src/hooks/use-bonus.ts"
      via: "useBonusRounds hook"
      pattern: "useBonusRounds"
    - from: "src/components/bonus/payments-tab.tsx"
      to: "src/hooks/use-bonus.ts"
      via: "useUpdatePayment hook with optimistic updates"
      pattern: "useUpdatePayment"
    - from: "src/components/bonus/results-tab.tsx"
      to: "src/hooks/use-bonus.ts"
      via: "useBonusResults hook"
      pattern: "useBonusResults"
---

<objective>
Build the main bonus page with rounds listing, inline card expansion, and all inner tab content (Targets, Payments, Results).

Purpose: This is the core user experience — viewing bonus rounds, managing payments, and reviewing results. The page shell hosts both the Rounds and Leaderboard top-level tabs, with Leaderboard content built in Plan 04.

Output: Bonus page, rounds list with filters, expandable round cards with three inner tabs, sidebar navigation entry
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-bonus-system/12-RESEARCH.md
@.planning/phases/12-bonus-system/12-01-SUMMARY.md

# Types and hooks from Plan 01
@src/types/bonus.ts
@src/hooks/use-bonus.ts

# Existing UI patterns to follow
@src/components/layout/sidebar.tsx
@src/app/(dashboard)/guilds/[guildId]/manage/data/page.tsx
@src/components/ui/confirmation-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bonus page shell, rounds tab with filter/pagination, and sidebar entry</name>
  <files>
    src/app/(dashboard)/guilds/[guildId]/bonus/page.tsx
    src/components/bonus/rounds-tab.tsx
    src/components/bonus/round-card.tsx
    src/components/bonus/round-card-skeleton.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
**Create `src/app/(dashboard)/guilds/[guildId]/bonus/page.tsx`:**
- Client component (`'use client'`)
- Extract `guildId` from `useParams()`
- Two top-level tabs: "Rounds" and "Leaderboard" — use local `useState<'rounds' | 'leaderboard'>` for active tab
- Tab bar styled with the project's tab pattern (inline-flex bg-surface border rounded-lg — see 12-RESEARCH.md Filter Tab Pattern)
- Render `<RoundsTab>` when active tab is 'rounds', placeholder `<LeaderboardTab>` div when 'leaderboard' (Plan 04 will replace)
- Page title "Bonus Rounds" with optional "Create Round" button (for admins — check permission bit 0x8 using useUser() + guild permissions)
- Admin check pattern: `const { user } = useUser(); const guild = user?.guilds?.find(g => g.id === guildId); const isAdmin = guild && (Number(guild.permissions) & 0x8) !== 0`

**Create `src/components/bonus/rounds-tab.tsx`:**
- Props: `{ guildId: string }`
- Filter tabs at top: All / Evaluated / Pending — `useState<RoundFilter>('all')`
- Use `useBonusRounds(guildId, filter)` hook from Plan 01
- Map rounds to `<RoundCard>` components
- Accordion: `useState<string | null>(null)` for expandedRoundId — only one card expanded at a time
- "Load More" button at bottom: shows when `hasMore` is true, calls `loadMore()`, shows loading spinner when fetching
- Loading state: render 3 `<RoundCardSkeleton>` cards
- Error state: "Failed to load bonus rounds" with retry button
- **Friendly empty state**: icon/illustration + "No bonus rounds yet" text + prominent "Create Round" button (visible only to admins)

**Create `src/components/bonus/round-card.tsx`:**
- Props: `{ round: BonusRound, expanded: boolean, onToggle: () => void, guildId: string }`
- **Collapsed state**: Card showing week dates (formatted with date-fns `format`), bonus amount (use `centsToDisplay`), target count, mini achieved/missed icons per target group. Unevaluated rounds: "Pending" badge with muted/faded opacity card style. Evaluated rounds: green/red achievement summary.
- **Expanded state**: Fetch round detail via `useBonusRoundDetail(guildId, round.id, expanded)` — enabled only when expanded. Show inner tabs: "Targets", "Payments", "Results" using local `useState<'targets' | 'payments' | 'results'>('targets')`.
- Smooth expand/collapse transition (CSS transition on max-height or use grid row animation)
- Render `<TargetsTab>`, `<PaymentsTab>`, or `<ResultsTab>` based on active inner tab
- Each inner tab is lazy — only rendered when active

**Create `src/components/bonus/round-card-skeleton.tsx`:**
- Skeleton card matching collapsed round card dimensions — pulse animation with bg-surface-hover blocks for date range, amount, target indicators

**Update `src/components/layout/sidebar.tsx`:**
- Add "Bonus" link under the guild navigation section (NOT under Manage — bonus is viewable by all users, not just admins)
- Link to `/guilds/${guildId}/bonus`
- Use Trophy icon from lucide-react
- Active state when pathname includes `/bonus`
  </action>
  <verify>
Run `npx tsc --noEmit` — no new type errors. Verify page exists: `ls src/app/\(dashboard\)/guilds/\[guildId\]/bonus/page.tsx`. Run `npm run build` or `next build` to check no build errors on the new page route.
  </verify>
  <done>Bonus page renders with Rounds/Leaderboard tabs, rounds list shows filter tabs and Load More pagination, round cards display collapsed summary with expand-on-click, skeleton loading states work, sidebar has Bonus navigation link.</done>
</task>

<task type="auto">
  <name>Task 2: Create Targets, Payments, and Results inner tab components</name>
  <files>
    src/components/bonus/targets-tab.tsx
    src/components/bonus/payments-tab.tsx
    src/components/bonus/results-tab.tsx
  </files>
  <action>
**Create `src/components/bonus/targets-tab.tsx`:**
- Props: `{ targets: BonusTarget[] }`
- Flat list of targets (not grouped by brand) — each row shows:
  - Account group label + brand label as a muted tag/badge
  - Target views number
  - Actual views (if evaluated) or "—" if pending
  - Achievement indicator: green check icon for achieved, red X for missed, muted dash for unevaluated
- Sortable by group name and achievement status — use local useState for sort config

**Create `src/components/bonus/payments-tab.tsx`:**
- Props: `{ roundId: string, guildId: string, payments: BonusPayment[], evaluated: boolean, isAdmin: boolean }`
- If NOT evaluated: show explanation message "Payments will be available after this round is evaluated" with info icon and muted styling. Return early.
- **Running total progress bar** at top: shows paid vs total amount as a horizontal bar with `$X.XX paid of $Y.YY total` label. Use Tailwind bg-green-500/bg-surface for filled/unfilled.
- **Bulk action buttons** above the payment list (admin only):
  - "Mark All Paid" button — shown when ANY payment is unpaid
  - "Mark All Unpaid" button — shown when ANY payment is paid
  - Each requires confirmation dialog (use existing `confirmation-modal.tsx` or `@headlessui/react` Dialog) showing count of affected payments and total dollar amount
  - Use `useBulkUpdatePayments(guildId)` mutation
- **Payment list** — each row shows:
  - Group name
  - Amount in dollars (`centsToDisplay`)
  - Paid/unpaid toggle switch (inline, no confirmation for single toggle). Disabled when `!isAdmin`.
  - When toggling to unpaid (paid -> unpaid), use `useUpdatePayment` and show Sonner warning toast with undo action (see research Pattern 4)
  - Paid-by user + date (if paid)
  - **Notes field**: always visible `<textarea>` or `<input>` with character counter (e.g., "42/500"). Auto-saves on blur via `useUpdatePaymentNotes` — only fires if value changed from original (use useRef to track original). Include current paid status in the PATCH to avoid race condition (Pitfall 4).
- **Sorting**: sortable by group name, paid status, and amount — use local useState for sort config + JS `.sort()`
- Non-admin users: toggles are disabled, bulk buttons hidden, notes are read-only

**Create `src/components/bonus/results-tab.tsx`:**
- Props: `{ roundId: string, guildId: string, evaluated: boolean }`
- If NOT evaluated: show "Results will be available after this round is evaluated" with muted styling. Return early.
- Fetch results via `useBonusResults(guildId, roundId, evaluated)` — enabled only when tab is active and round is evaluated
- **Summary stat cards** at top (4 cards in a grid):
  - "X Achieved" (green)
  - "Y Missed" (red)
  - "Z Near-Miss" (yellow/amber)
  - "$X.XX Total Bonus" (accent purple)
- **Results list**: each target row shows:
  - Group label + brand label
  - Progress bar: actual views vs target views — width percentage `min(100, (actual/target) * 100)%`. Color: green if achieved, yellow if near_miss, red if missed.
  - Actual / Target numbers beside the bar
  - Near-miss: inline amber/yellow badge "Near Miss" beside group name for prominence
  - Delta and delta_percent shown as supplementary info
- Loading state: skeleton cards for summary + skeleton rows for results list
  </action>
  <verify>
Run `npx tsc --noEmit` — no new type errors. Verify all 3 tab files exist: `ls src/components/bonus/targets-tab.tsx src/components/bonus/payments-tab.tsx src/components/bonus/results-tab.tsx`.
  </verify>
  <done>Targets tab shows flat list with achievement icons. Payments tab has progress bar, bulk actions with confirmation, individual toggles with optimistic updates and undo toast, auto-saving notes with character counter. Results tab shows summary stat cards and progress bars per target with near-miss highlighting. Non-admins see read-only payment views.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. Bonus page accessible at `/guilds/[guildId]/bonus` with working Rounds/Leaderboard tab switcher
3. Sidebar shows Bonus link with Trophy icon
4. Rounds list renders cards with filter tabs and Load More
5. Clicking card expands inline with Targets/Payments/Results inner tabs
6. Payment toggles work with optimistic updates; undo toast appears when marking unpaid
7. Bulk payment actions show confirmation dialog with count and dollar total
8. Results tab shows summary stats and progress bars with near-miss highlighting
9. Empty state shows friendly message with Create Round button for admins
</verification>

<success_criteria>
Core bonus round viewing and payment management works end-to-end. Users can browse rounds, expand for details, view results. Admins can manage payments individually and in bulk. The only missing pieces are round creation (Plan 03) and leaderboard content (Plan 04).
</success_criteria>

<output>
After completion, create `.planning/phases/12-bonus-system/12-02-SUMMARY.md`
</output>
