---
phase: 08-polish-optimization
plan: 05
type: execute
wave: 2
depends_on: ["08-03"]
files_modified:
  - src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/posts/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/brands/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/activity/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Filter state and search queries persist across browser back/forward on accounts and posts pages"
    - "Cached data displays immediately on page revisit without skeleton flash"
    - "Loaded items show count like '50 accounts' instead of loading indicator on cached revisits"
  artifacts:
    - path: "src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx"
      provides: "Accounts page with persistent filter state and skeleton flash fix"
      contains: "usePersistentState"
    - path: "src/app/(dashboard)/guilds/[guildId]/posts/page.tsx"
      provides: "Posts page with persistent filter state and skeleton flash fix"
      contains: "usePersistentState"
  key_links:
    - from: "src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx"
      to: "src/hooks/use-persistent-state.ts"
      via: "import usePersistentState"
      pattern: "usePersistentState"
---

<objective>
Replace useState with usePersistentState for filter/search state on data pages, fix skeleton flash on cached data, and add loaded count display.

Purpose: Users never lose their filters on back/forward navigation, see cached data instantly without loading flash, and know how many items are loaded.
Output: All data pages with persistent state, skeleton flash fix, loaded count.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-optimization/08-CONTEXT.md
@.planning/phases/08-polish-optimization/08-03-SUMMARY.md

@src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx
@src/app/(dashboard)/guilds/[guildId]/posts/page.tsx
@src/hooks/use-persistent-state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add persistent state and skeleton flash fix to Accounts page</name>
  <files>
    src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx
  </files>
  <action>
    1. Import `usePersistentState` from '@/hooks/use-persistent-state'

    2. Replace `useState` with `usePersistentState` for filter state:
       - `const [search, setSearch] = usePersistentState(`${guildId}-accounts-search`, '')`
       - `const [platform, setPlatform] = usePersistentState(`${guildId}-accounts-platform`, '')`
       - `const [group, setGroup] = usePersistentState(`${guildId}-accounts-group`, searchParams.get('group') ?? '')`
       - `const [pageSize, setPageSize] = usePersistentState(`${guildId}-accounts-pageSize`, 50)`

    3. Fix skeleton flash on cached data:
       - Find where the loading skeleton is shown (likely `if (isLoading)` or similar)
       - Change condition from `isLoading` to `isLoading && !data` (or equivalent for infinite queries)
       - This ensures: first visit shows skeleton, subsequent visits show cached data instantly

    4. Add loaded count display:
       - After the data loads, show a count like "50 accounts" near the top of the list
       - Calculate total from all loaded infinite query pages: `data?.pages?.reduce((sum, page) => sum + page.accounts.length, 0) ?? 0`
       - Display as small muted text: `<span className="text-sm text-gray-400">{count} accounts</span>`
       - Place near the filter bar or above the card grid

    5. Keep URL-based group initialization as fallback: if searchParams has group AND persistent state is empty, use URL value
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - usePersistentState imported and used for all filter state
    - Loading condition checks `!data` to prevent flash on cached visits
    - Loaded count displayed
  </verify>
  <done>
    Accounts page persists filters to sessionStorage, shows cached data instantly without skeleton flash, and displays loaded item count.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add persistent state and skeleton flash fix to remaining pages</name>
  <files>
    src/app/(dashboard)/guilds/[guildId]/posts/page.tsx
    src/app/(dashboard)/guilds/[guildId]/brands/page.tsx
    src/app/(dashboard)/guilds/[guildId]/activity/page.tsx
    src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx
  </files>
  <action>
    Apply the same pattern from Task 1 to all remaining data pages:

    1. **Posts page**:
       - Replace filter useState with usePersistentState (search, platform, status, brand_id, pageSize, etc.) using `${guildId}-posts-{field}` keys
       - Fix skeleton flash: `isLoading && !data` pattern
       - Add loaded count: "X posts"

    2. **Brands page**:
       - If it has filter state (search), replace with usePersistentState
       - Fix skeleton flash pattern
       - If no filters, just fix skeleton flash

    3. **Activity page**:
       - If it has filter state, replace with usePersistentState
       - Fix skeleton flash pattern for audit log data

    4. **Analytics page**:
       - Replace time range state with usePersistentState: `${guildId}-analytics-timeRange`
       - Fix skeleton flash: show cached charts immediately on revisit

    For each page:
    - Import usePersistentState
    - Identify all useState calls for filter/search/preference state
    - Replace with usePersistentState using guild-scoped keys
    - Fix loading condition to prevent flash on cached data

    Do NOT persist modal/dialog state, selection state, or ephemeral UI state â€” only persist filter preferences.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All data pages use usePersistentState for filter state
    - All pages use `isLoading && !data` pattern to prevent skeleton flash
    - Posts page shows loaded count
  </verify>
  <done>
    All data pages persist filter state across back/forward navigation, show cached data instantly without skeleton flash, and display loaded counts where applicable.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Accounts, Posts, Brands, Activity, Analytics pages all use usePersistentState
- Skeleton flash fixed on all pages (condition checks for existing data)
- Loaded count displayed on list pages
</verification>

<success_criteria>
- Browser back/forward preserves all filter state on every data page
- Revisiting a page within 5 minutes shows cached data instantly (no skeleton flash)
- Loaded count shows "X accounts" / "X posts" style display
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-optimization/08-05-SUMMARY.md`
</output>
