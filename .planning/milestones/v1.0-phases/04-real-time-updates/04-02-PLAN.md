---
phase: 04-real-time-updates
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/hooks/use-guilds.ts
  - src/components/bot-status.tsx
autonomous: true

must_haves:
  truths:
    - "Status updates reflect within 5 seconds without manual refresh"
    - "User sees connecting/connected/error connection states"
    - "User can click to retry when connection fails"
    - "Last seen timestamp displays in relative format when offline"
  artifacts:
    - path: "src/hooks/use-guilds.ts"
      provides: "SSE-enhanced status hook"
      exports: ["useGuildStatusRealtime"]
      contains: "useSSE"
    - path: "src/components/bot-status.tsx"
      provides: "Status indicator with connection states"
      contains: "connectionState"
  key_links:
    - from: "src/hooks/use-guilds.ts"
      to: "src/hooks/use-sse.ts"
      via: "import useSSE"
      pattern: "import.*useSSE.*from"
    - from: "src/hooks/use-guilds.ts"
      to: "queryClient.setQueryData"
      via: "React Query cache update"
      pattern: "setQueryData.*guild.*guildId.*status"
    - from: "src/components/bot-status.tsx"
      to: "date-fns formatDistanceToNow"
      via: "relative time display"
      pattern: "formatDistanceToNow"
---

<objective>
Integrate SSE with status display for real-time bot health updates.

Purpose: Connect the SSE infrastructure to the UI, replacing polling with push-based updates that reflect within 5 seconds.
Output: Enhanced useGuildStatusRealtime hook and BotStatus component with full connection state handling.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-real-time-updates/04-CONTEXT.md
@.planning/phases/04-real-time-updates/04-RESEARCH.md
@.planning/phases/04-real-time-updates/04-01-SUMMARY.md

# Files to modify
@src/hooks/use-guilds.ts
@src/components/bot-status.tsx
@src/types/guild.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add useGuildStatusRealtime hook with SSE integration</name>
  <files>src/hooks/use-guilds.ts</files>
  <action>
Add a new hook `useGuildStatusRealtime` that enhances the existing polling with SSE.

Requirements:
- Import useSSE from `@/hooks/use-sse`
- Import useQueryClient from `@tanstack/react-query`
- Create new hook that:
  1. Gets queryClient via useQueryClient()
  2. Uses useSSE with URL `/api/guilds/${guildId}/status/stream` (or null if no guildId)
  3. onMessage callback: Update React Query cache via `queryClient.setQueryData(['guild', guildId, 'status'], data as GuildStatus)`
  4. Uses existing useQuery for initial data and fallback polling
  5. When SSE connected: disable refetchInterval (set to false)
  6. When SSE disconnected/error: enable fallback polling (60s interval)
  7. Returns all useQuery properties plus connectionState and reconnect from useSSE

Keep the existing `useGuildStatus` hook unchanged for backwards compatibility.

Hook signature:
```typescript
export function useGuildStatusRealtime(guildId: string) {
  // Returns: { data, isLoading, error, connectionState, reconnect, ... }
}
```

Follow the pattern from 04-RESEARCH.md "SSE + React Query Integration" example.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/hooks/use-guilds.ts
```
  </verify>
  <done>useGuildStatusRealtime hook exists and integrates SSE with React Query cache updates</done>
</task>

<task type="auto">
  <name>Task 2: Enhance BotStatus component with connection states</name>
  <files>src/components/bot-status.tsx</files>
  <action>
Enhance the BotStatus component to display connection states and support manual reconnection.

Requirements:
- Add new props: `connectionState?: ConnectionState`, `onReconnect?: () => void`
- Import ConnectionState type from `@/hooks/use-sse`
- Replace custom getTimeAgo with `formatDistanceToNow` from date-fns (use `{ addSuffix: true }`)
- Display states per CONTEXT.md:
  - `connecting`: Gray dot, "Connecting..." text
  - `connected` + healthy: Green pulsing dot, "Online" text
  - `connected` + offline: Red static dot, "Offline" text, "Last seen: X ago", "Check Discord"
  - `error`: Yellow dot, "Connection lost" text, "Click to retry"
- Make component a button when `connectionState === 'error'` (clickable for retry)
- Otherwise render as div (not clickable)
- Add transition animation for smooth state changes
- Keep backwards compatibility: if connectionState not provided, default to 'connected' behavior

Styling per CONTEXT.md decisions:
- Green dot: `bg-green-500 animate-pulse`
- Red dot: `bg-red-500` (static)
- Yellow dot: `bg-yellow-500`
- Gray dot: `bg-gray-400 animate-pulse`
- Text colors: green-400, red-400, yellow-400, gray-400 respectively

Follow the enhanced BotStatus pattern from 04-RESEARCH.md.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/components/bot-status.tsx
```
  </verify>
  <done>BotStatus component displays all connection states with proper styling and reconnect functionality</done>
</task>

<task type="auto">
  <name>Task 3: Wire up real-time status in guild detail page</name>
  <files>src/app/(dashboard)/guilds/[guildId]/page.tsx</files>
  <action>
Update the guild detail page to use the real-time status hook.

Requirements:
- Replace `useGuildStatus` import with `useGuildStatusRealtime` from `@/hooks/use-guilds`
- Destructure `connectionState` and `reconnect` from the hook result
- Pass `connectionState` and `onReconnect={reconnect}` to BotStatus component
- Everything else remains unchanged (status data props stay the same)

The change is minimal - just swap the hook and pass the new props.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit "src/app/(dashboard)/guilds/[guildId]/page.tsx"
```
  </verify>
  <done>Guild detail page uses real-time status with connection state display</done>
</task>

</tasks>

<verification>
- [ ] `useGuildStatusRealtime` hook exists and exports from use-guilds.ts
- [ ] BotStatus accepts connectionState and onReconnect props
- [ ] BotStatus uses formatDistanceToNow from date-fns
- [ ] Guild detail page passes connectionState to BotStatus
- [ ] All files compile without TypeScript errors
- [ ] Dev server starts without errors: `npm run dev`
</verification>

<success_criteria>
Real-time status updates work end-to-end:
- SSE connection established on guild page load
- Status updates appear within 5 seconds (when backend sends events)
- Connection states display correctly (connecting, connected, error)
- Manual reconnect works when clicked in error state
- Fallback polling activates when SSE disconnected
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-updates/04-02-SUMMARY.md`
</output>
