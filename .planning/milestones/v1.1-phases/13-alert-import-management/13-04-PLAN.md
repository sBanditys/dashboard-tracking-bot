---
phase: 13-alert-import-management
plan: 04
type: execute
wave: 4
depends_on: ["13-03"]
files_modified:
  - src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx
  - src/components/alerts/threshold-bulk-bar.tsx
  - src/components/alerts/email-config-section.tsx
  - src/components/alerts/alert-settings-panel.tsx
autonomous: true
requirements: [ALERT-04]

must_haves:
  truths:
    - "Admin can select multiple thresholds with checkboxes and shift-click range selection"
    - "Sticky bulk action bar shows Enable All, Disable All, Delete actions"
    - "Bulk delete requires type-to-confirm dialog"
    - "Admin can configure email delivery mode (immediate vs digest)"
    - "Admin can manage email recipients (add, remove, resend verification)"
    - "Admin can toggle alert settings per group (streak, threshold, status alerts)"
  artifacts:
    - path: "src/components/alerts/threshold-bulk-bar.tsx"
      provides: "Sticky bulk action bar with enable/disable/delete actions"
      exports: ["ThresholdBulkBar"]
    - path: "src/components/alerts/email-config-section.tsx"
      provides: "Email delivery config with recipients list"
      exports: ["EmailConfigSection"]
    - path: "src/components/alerts/alert-settings-panel.tsx"
      provides: "Per-group alert settings toggles"
      exports: ["AlertSettingsPanel"]
  key_links:
    - from: "src/components/alerts/threshold-bulk-bar.tsx"
      to: "src/hooks/use-alerts.ts"
      via: "useBulkToggleThresholds and useBulkDeleteThresholds"
      pattern: "useBulk"
    - from: "src/components/alerts/email-config-section.tsx"
      to: "src/hooks/use-email-alerts.ts"
      via: "useEmailConfig, useUpdateEmailConfig, useAddRecipient, useRemoveRecipient"
      pattern: "useEmailConfig|useAddRecipient"
---

<objective>
Add bulk operations, email alert configuration, and per-group alert settings to the alerts page.

Purpose: Complete the alerts management experience with multi-select actions, email delivery configuration, and group-level settings toggles.

Output: Bulk action bar, email config section, alert settings panel integrated into the alerts page.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-alert-import-management/13-RESEARCH.md
@.planning/phases/13-alert-import-management/13-02-SUMMARY.md
@.planning/phases/13-alert-import-management/13-03-SUMMARY.md

Key reference files:
@src/hooks/use-alerts.ts (bulk hooks)
@src/hooks/use-email-alerts.ts (email config hooks)
@src/hooks/use-selection.ts (useShiftSelection)
@src/components/bulk/selection-bar.tsx (existing bulk bar pattern)
@src/components/ui/type-to-confirm-modal.tsx (existing)
@src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx (from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bulk operations with multi-select and sticky action bar</name>
  <files>
    src/components/alerts/threshold-bulk-bar.tsx
    src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx
  </files>
  <action>
  **Create `src/components/alerts/threshold-bulk-bar.tsx`:**

  A `'use client'` component for the sticky bulk action bar (locked decisions: checkboxes on each card, "Select all" for visible, sticky bar, Enable All/Disable All/Delete).

  Props: `selectedCount: number`, `onEnableAll: () => void`, `onDisableAll: () => void`, `onDelete: () => void`, `onSelectAll: () => void`, `onDeselectAll: () => void`, `isAllSelected: boolean`, `isLoading: boolean`

  Layout:
  - Sticky bottom bar: `fixed bottom-0 left-0 right-0 md:left-64 z-40` (avoids sidebar overlap, same as existing `SelectionBar`)
  - Background: `bg-surface border-t border-border shadow-lg`
  - Content: flex row with:
    - Left: "{N} selected" text + "Select all" / "Deselect all" button
    - Right: "Enable All" button (green), "Disable All" button (yellow), "Delete" button (red/danger)
  - Only visible when `selectedCount > 0` — animate in from bottom with `transition-all duration-200`
  - Loading state: show spinner on the active action button

  Accessibility: All buttons have descriptive labels. Bar has `role="toolbar"` with `aria-label="Bulk actions"`.

  **Update `src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx`:**

  Integrate bulk selection and bulk action bar:

  1. Import and use `useShiftSelection` from `@/hooks/use-selection`:
     - Pass the flattened thresholds list to the hook
     - Get `selectedIds`, `toggleSelect`, `selectRange`, `selectAll`, `deselectAll`, `isSelected`

  2. Pass selection props to each `ThresholdCard`:
     - `isSelected={isSelected(threshold.id)}`
     - `onSelect={(id) => toggleSelect(id)}` — for single click
     - Handle shift-click via `selectRange` following the existing pattern

  3. Add "Select all visible" checkbox at the top of the threshold list (per locked decision: selects all currently visible/filtered thresholds).

  4. Render `<ThresholdBulkBar>` at bottom of page when `selectedIds.size > 0`.

  5. Bulk actions:
     - **Enable All:** Call `useBulkToggleThresholds` with all selected thresholds set to `enabled: true`. Map selectedIds to their threshold objects to get `groupId`.
     - **Disable All:** Same but `enabled: false`.
     - **Delete:** Open a `TypeToConfirmModal` with `confirmText="delete"` and message "This will permanently delete {N} thresholds". On confirm: call `useBulkDeleteThresholds`. After success: clear selection, animate removal.

  6. After successful bulk operation: clear selection (`deselectAll()`), invalidate cache.
  </action>
  <verify>
  `npx tsc --noEmit` passes.
  File exists: `threshold-bulk-bar.tsx`.
  Grep for `useShiftSelection` in alerts/page.tsx confirms multi-select integration.
  Grep for `useBulkDeleteThresholds` confirms bulk delete.
  Grep for `TypeToConfirmModal` in page.tsx confirms both single and bulk delete use type-to-confirm.
  Grep for `fixed bottom-0` in threshold-bulk-bar.tsx confirms sticky positioning.
  </verify>
  <done>
  Bulk operations work: checkboxes on cards, shift-click range selection, select-all for visible items, sticky bottom bar with Enable All/Disable All/Delete, bulk delete requires type-to-confirm.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create email config section and alert settings panel</name>
  <files>
    src/components/alerts/email-config-section.tsx
    src/components/alerts/alert-settings-panel.tsx
    src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx
  </files>
  <action>
  **Create `src/components/alerts/email-config-section.tsx`:**

  A `'use client'` component for email alert configuration (placement: Claude's discretion — implement as a collapsible section below the threshold list on the alerts page).

  Props: `guildId: string`

  Uses hooks: `useEmailConfig`, `useUpdateEmailConfig`, `useAddRecipient`, `useRemoveRecipient`, `useResendVerification` from `@/hooks/use-email-alerts`.

  Layout:
  1. **Section header:** "Email Notifications" with a collapsible toggle (expand/collapse)

  2. **Delivery mode toggle:** Two options: "Immediate" and "Daily Digest" as segmented buttons.
     - When "Immediate" selected: no additional config
     - When "Daily Digest" selected: show time picker dropdown (24 hour options in UTC, e.g., "00:00 UTC", "01:00 UTC", ..., "23:00 UTC"). Use a simple `<select>` per project style preference.
     - On change: call `useUpdateEmailConfig` mutation

  3. **Rate limit info:** Display "Max {rateLimit} emails/hour per recipient" as muted info text (per locked decision).

  4. **Recipients list:** Inline list of email recipients. Each entry shows:
     - Masked email (first 3 chars + "***@domain.com" — comes pre-masked from backend)
     - Verification badge: green checkmark if verified, yellow "Pending" if not verified and < 24h, red "Expired" if `verificationExpired` is true
     - Resend verification button: shown when not verified or expired, calls `useResendVerification`
     - Remove button: trash icon, calls `useRemoveRecipient`, confirm with simple confirmation dialog
     - Max recipients display: "X of {maxRecipients} recipients" text

  5. **Add recipient form:** Email input + "Add" button at bottom of recipients list.
     - Client-side email format validation (regex check) before sending to backend (per locked decision)
     - On submit: call `useAddRecipient`
     - On success: input clears, "Verification email sent" toast (handled by hook)
     - If at max recipients: disable add button, show "Maximum recipients reached" message

  Style: `bg-surface border border-border rounded-lg p-6`, consistent with card styling.

  **Create `src/components/alerts/alert-settings-panel.tsx`:**

  A `'use client'` component for per-group alert settings (Claude's discretion on presentation: implement as a banner/card that appears when filtering by a specific group).

  Props: `guildId: string`, `groupId: string`, `settings: AlertSettings | null`

  When a specific group is selected in the filters, show this panel above the threshold cards:
  - Three toggle switches: "Streak Alerts", "Threshold Alerts", "Status Alerts"
  - Each toggle calls `useUpdateAlertSettings` with the updated settings
  - Non-optimistic: show loading spinner while mutation is in progress
  - If no settings exist (null), show toggles with defaults (all false) and create on first toggle

  Style: Compact banner with `bg-surface/50 border border-border rounded-lg p-4`, flex row on desktop, stacked on mobile.

  **Update `src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx`:**

  Integrate the new components:

  1. Add `<AlertSettingsPanel>` conditionally — only render when `filters.groupId` is set (a specific group is selected in the filter). Pass the group's alert settings from the threshold data.

  2. Add `<EmailConfigSection>` below the threshold list grid. It manages its own data fetching internally.

  3. Page ordering from top to bottom:
     - Page header ("Alert Thresholds" + "Create threshold" button + Discord channel info)
     - ThresholdFilters
     - AlertSettingsPanel (conditional: only when filtering by group)
     - Threshold card grid with infinite scroll
     - Loaded count display
     - ThresholdBulkBar (sticky, when selection active)
     - EmailConfigSection (below threshold list)
  </action>
  <verify>
  `npx tsc --noEmit` passes.
  Files exist: `email-config-section.tsx`, `alert-settings-panel.tsx`.
  Grep for `useEmailConfig` in email-config-section confirms data fetching.
  Grep for `useUpdateAlertSettings` in alert-settings-panel confirms settings mutation.
  Grep for `EmailConfigSection` in alerts page.tsx confirms integration.
  Grep for `AlertSettingsPanel` in alerts page.tsx confirms conditional rendering.
  </verify>
  <done>
  Email config section shows: delivery mode toggle, digest time picker, rate limit info, recipients with verification status/resend/remove, add recipient form with client-side validation. Alert settings panel shows per-group toggles for streak/threshold/status alerts. Both integrated into alerts page.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Bulk bar appears when checkboxes are selected
- Shift-click selects a range of thresholds
- Bulk delete requires type-to-confirm
- Email config shows delivery mode, recipients with verification status
- Alert settings panel appears when filtering by group
- All toggles are non-optimistic (wait for API confirmation)
</verification>

<success_criteria>
1. Checkboxes on cards with shift-click range selection
2. Sticky bulk bar with Enable All, Disable All, Delete
3. Bulk delete shows type-to-confirm modal
4. Email delivery mode toggle (immediate/digest) with time picker
5. Recipients list with masked emails, verification badges, resend/remove buttons
6. Add recipient with client-side email validation
7. Per-group alert settings toggles (streak, threshold, status)
8. Alert settings panel appears only when filtering by specific group
</success_criteria>

<output>
After completion, create `.planning/phases/13-alert-import-management/13-04-SUMMARY.md`
</output>
