---
phase: 20-cursor-pagination-migration
plan: 02
type: execute
wave: 2
depends_on:
  - 20-01
files_modified:
  - src/hooks/use-tracking.ts
  - src/hooks/use-bulk-operations.ts
  - src/hooks/use-trash.ts
  - src/hooks/use-guilds.ts
  - src/hooks/use-import.ts
autonomous: true
requirements:
  - PAGE-03

must_haves:
  truths:
    - "Adding a tracked account optimistically prepends the new account to the first page of the infinite list"
    - "Deleting a tracked account optimistically removes it from the infinite cache"
    - "Optimistic rollback restores the previous cache snapshot on mutation error"
    - "After any account/post mutation settles, resetQueries (not invalidateQueries) clears all accumulated pages and re-fetches from the beginning"
    - "Bulk delete, bulk reassign, trash restore, and import all use resetQueries for accounts/posts infinite queries"
    - "Non-infinite queries (guild details, brands, trash) still use invalidateQueries unchanged"
  artifacts:
    - path: "src/hooks/use-tracking.ts"
      provides: "Optimistic add/delete account mutations with resetQueries on settle"
      contains: "resetQueries"
    - path: "src/hooks/use-bulk-operations.ts"
      provides: "resetQueries for bulk delete and bulk reassign"
      contains: "resetQueries"
    - path: "src/hooks/use-trash.ts"
      provides: "resetQueries for trash restore"
      contains: "resetQueries"
    - path: "src/hooks/use-guilds.ts"
      provides: "resetQueries for delete account in guilds hook"
      contains: "resetQueries"
    - path: "src/hooks/use-import.ts"
      provides: "resetQueries for post-import accounts cache"
      contains: "resetQueries"
  key_links:
    - from: "src/hooks/use-tracking.ts"
      to: "queryClient.resetQueries"
      via: "onSettled callback in useAddAccount/useDeleteAccount"
      pattern: "resetQueries.*queryKey.*accounts"
    - from: "src/hooks/use-bulk-operations.ts"
      to: "queryClient.resetQueries"
      via: "onSuccess callback in useBulkDelete/useBulkReassign"
      pattern: "resetQueries.*queryKey.*accounts|posts"
---

<objective>
Replace invalidateQueries with resetQueries for all mutations that affect accounts and posts infinite scroll lists, and add optimistic updates to add/delete account mutations.

Purpose: Prevent mixed-shape cache pages after mutations — resetQueries clears all accumulated pages and re-fetches from scratch instead of re-fetching each cached page with potentially stale cursors. Optimistic updates provide instant feedback per user decision.
Output: All mutation hooks use resetQueries for accounts/posts, and add/delete account mutations are optimistic.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-cursor-pagination-migration/20-RESEARCH.md
@.planning/phases/20-cursor-pagination-migration/20-01-SUMMARY.md

@src/hooks/use-tracking.ts
@src/hooks/use-bulk-operations.ts
@src/hooks/use-trash.ts
@src/hooks/use-guilds.ts
@src/hooks/use-import.ts
@src/types/tracking.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add optimistic updates to useAddAccount/useDeleteAccount and switch to resetQueries</name>
  <files>
    src/hooks/use-tracking.ts
  </files>
  <action>
**useDeleteAccount (in use-tracking.ts):**

1. Add `onMutate` for optimistic removal:
   ```typescript
   onMutate: async (accountId: string) => {
       // Cancel outgoing refetches
       await queryClient.cancelQueries({ queryKey: ['guild', guildId, 'accounts'] })
       // Snapshot previous data
       const previousData = queryClient.getQueriesData({ queryKey: ['guild', guildId, 'accounts'] })
       // Optimistically remove the account from all pages
       queryClient.setQueriesData(
           { queryKey: ['guild', guildId, 'accounts', 'infinite'] },
           (old: InfiniteData<AccountsResponse> | undefined) => {
               if (!old) return old
               return {
                   ...old,
                   pages: old.pages.map((page) => ({
                       ...page,
                       accounts: page.accounts.filter((a) => a.id !== accountId),
                   })),
               }
           }
       )
       return { previousData }
   },
   ```
   Import `InfiniteData` from `@tanstack/react-query` and `AccountsResponse` type.

2. Add `onError` rollback — restore the snapshot on failure (integrate with existing onError):
   ```typescript
   onError: (error, _accountId, context) => {
       // Restore optimistic cache on error
       if (context?.previousData) {
           context.previousData.forEach(([queryKey, data]) =>
               queryClient.setQueryData(queryKey, data)
           )
       }
       // ... existing error toast logic ...
   },
   ```

3. Replace `onSuccess` cache management — change `queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'accounts'] })` to nothing (handled in onSettled).

4. Add `onSettled` to always reset from server:
   ```typescript
   onSettled: () => {
       queryClient.resetQueries({ queryKey: ['guild', guildId, 'accounts'] })
   },
   ```

5. Keep the existing `queryClient.invalidateQueries({ queryKey: ['guild', guildId] })` in onSuccess — this invalidates the guild details (account_count) which is a non-infinite query and should still use invalidateQueries.

6. Remove the success toast entirely per locked decision: "No toast or notification for add/remove mutations — the optimistic list change IS the feedback." BUT keep the retry-related toast logic (dismiss retry toast + "Changes saved" on retry success).

**useAddAccount (in use-tracking.ts):**

7. Add `onMutate` for optimistic prepend — create an optimistic Account object at the top of the first page:
   ```typescript
   onMutate: async (newAccountData: AddAccountRequest) => {
       await queryClient.cancelQueries({ queryKey: ['guild', guildId, 'accounts'] })
       const previousData = queryClient.getQueriesData({ queryKey: ['guild', guildId, 'accounts'] })
       queryClient.setQueriesData(
           { queryKey: ['guild', guildId, 'accounts', 'infinite'] },
           (old: InfiniteData<AccountsResponse> | undefined) => {
               if (!old) return old
               const optimisticAccount: Account = {
                   id: `optimistic-${Date.now()}`,
                   platform: newAccountData.platform,
                   username: newAccountData.username,
                   brand: '',
                   group: null,
                   is_verified: false,
                   verified_at: null,
                   refresh: null,
                   created_at: new Date().toISOString(),
               }
               return {
                   ...old,
                   pages: old.pages.map((page, i) =>
                       i === 0 ? { ...page, accounts: [optimisticAccount, ...page.accounts] } : page
                   ),
               }
           }
       )
       return { previousData }
   },
   ```
   Import `Account` type from `@/types/tracking`.

8. Add `onError` rollback (same pattern as delete).

9. Add `onSettled` with resetQueries:
   ```typescript
   onSettled: () => {
       queryClient.resetQueries({ queryKey: ['guild', guildId, 'accounts'] })
   },
   ```

10. In `onSuccess`: remove `queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'accounts'] })` (now handled by onSettled resetQueries). Keep `invalidateQueries` for `['guild', guildId]` (guild details count) and `['guild', guildId, 'brands']` (brand account_count). Remove the non-retry success toast per locked decision.

**Important:** The `useMutation` generic type may need to be updated to include the `context` type for the onMutate return. Use the pattern:
```typescript
useMutation<ResponseType, Error, ParamType, { previousData: [QueryKey, unknown][] }>
```
  </action>
  <verify>
    <automated>cd /Users/gabrielleal/Desktop/dashboard-tracking-bot && npx tsc --noEmit 2>&1 | head -40</automated>
    <manual>Verify useDeleteAccount and useAddAccount have onMutate (optimistic), onError (rollback), onSettled (resetQueries)</manual>
  </verify>
  <done>
    - useDeleteAccount optimistically removes account from infinite cache, rolls back on error, resets on settle
    - useAddAccount optimistically prepends account to first page, rolls back on error, resets on settle
    - Neither mutation shows a success toast for normal (non-retry) operations per locked decision
    - Guild details and brands still use invalidateQueries (non-infinite queries)
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace invalidateQueries with resetQueries in remaining mutation hooks</name>
  <files>
    src/hooks/use-bulk-operations.ts
    src/hooks/use-trash.ts
    src/hooks/use-guilds.ts
    src/hooks/use-import.ts
  </files>
  <action>
**In src/hooks/use-bulk-operations.ts:**

1. In `useBulkDelete` onSuccess: change
   ```typescript
   queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```
   to
   ```typescript
   queryClient.resetQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```
   and similarly for posts:
   ```typescript
   queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'posts'] })
   ```
   to
   ```typescript
   queryClient.resetQueries({ queryKey: ['guild', guildId, 'posts'] })
   ```
   Keep `invalidateQueries` for `['guild', guildId]` (guild details, non-infinite).

2. In `useBulkReassign` onSuccess: change
   ```typescript
   queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```
   to
   ```typescript
   queryClient.resetQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```
   Keep `invalidateQueries` for `['guild', guildId, 'brands']` and `['guild', guildId]` (non-infinite queries).

**In src/hooks/use-trash.ts:**

3. In `useRestoreItem` onSuccess: change both accounts and posts invalidateQueries to resetQueries:
   ```typescript
   // Before:
   queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'accounts'] })
   // After:
   queryClient.resetQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```
   Same for posts. Keep `invalidateQueries` for `['guild', guildId, 'trash']` and `['guild', guildId]` (non-infinite queries).

**In src/hooks/use-guilds.ts:**

4. In `useDeleteAccount` onSuccess (line 291): change
   ```typescript
   queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```
   to
   ```typescript
   queryClient.resetQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```
   Keep `invalidateQueries` for `['guild', guildId]`.

**In src/hooks/use-import.ts:**

5. After the streaming import completes (line 185): change
   ```typescript
   queryClient.invalidateQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```
   to
   ```typescript
   queryClient.resetQueries({ queryKey: ['guild', guildId, 'accounts'] })
   ```

**Key rule:** ONLY change invalidateQueries to resetQueries for query keys that match infinite-scroll lists (`['guild', guildId, 'accounts']` and `['guild', guildId, 'posts']`). Do NOT change invalidateQueries for non-infinite queries like guild details, brands, or trash — those should remain as invalidateQueries.
  </action>
  <verify>
    <automated>cd /Users/gabrielleal/Desktop/dashboard-tracking-bot && npx tsc --noEmit 2>&1 | head -40 && grep -rn "invalidateQueries.*accounts\|invalidateQueries.*posts" src/hooks/ | grep -v brands | grep -v trash | grep -v guild</automated>
    <manual>Verify no remaining invalidateQueries calls target accounts or posts query keys (except through brands/trash/guild-details keys)</manual>
  </verify>
  <done>
    - All mutations affecting accounts/posts infinite lists use resetQueries
    - Non-infinite queries (guild details, brands, trash) still use invalidateQueries
    - No mixed-shape cache pages possible after mutations
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — no TypeScript compilation errors
2. `grep -rn "invalidateQueries.*accounts" src/hooks/` returns only non-infinite query key matches (guild details, brands)
3. `grep -rn "invalidateQueries.*posts" src/hooks/` returns no results for posts query key (all migrated to resetQueries)
4. `grep -rn "resetQueries" src/hooks/` shows entries in use-tracking.ts, use-bulk-operations.ts, use-trash.ts, use-guilds.ts, use-import.ts
5. useAddAccount and useDeleteAccount have onMutate/onError/onSettled for optimistic updates
</verification>

<success_criteria>
- Every mutation that changes accounts or posts lists uses resetQueries (not invalidateQueries) for infinite query keys
- Optimistic add prepends account to first page, optimistic delete removes account from all pages
- Rollback restores previous cache on mutation error
- Non-infinite queries continue to use invalidateQueries
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/20-cursor-pagination-migration/20-02-SUMMARY.md`
</output>
