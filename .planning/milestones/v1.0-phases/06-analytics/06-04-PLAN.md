---
phase: 06-analytics
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/analytics/leaderboard.tsx
  - src/components/analytics/leaderboard-skeleton.tsx
  - src/components/analytics/activity-timeline.tsx
  - src/components/analytics/activity-event.tsx
autonomous: true

must_haves:
  truths:
    - "Leaderboard shows top accounts ranked by engagement with view/like counts"
    - "Leaderboard has 'View all' link when showing top-5 preview"
    - "Activity timeline groups events by day with relative labels (Today, Yesterday)"
    - "Activity timeline uses infinite scroll consistent with tracking pages"
    - "Events link to related items (posts, accounts)"
  artifacts:
    - path: "src/components/analytics/leaderboard.tsx"
      provides: "Leaderboard ranking component"
      exports: ["Leaderboard"]
    - path: "src/components/analytics/activity-timeline.tsx"
      provides: "Activity timeline with infinite scroll"
      exports: ["ActivityTimeline"]
    - path: "src/components/analytics/activity-event.tsx"
      provides: "Single event item"
      exports: ["ActivityEvent"]
  key_links:
    - from: "src/components/analytics/leaderboard.tsx"
      to: "src/types/analytics.ts"
      via: "imports LeaderboardEntry"
      pattern: "import.*LeaderboardEntry"
    - from: "src/components/analytics/activity-timeline.tsx"
      to: "src/hooks/use-analytics.ts"
      via: "useAnalyticsActivity infinite query"
      pattern: "useAnalyticsActivity"
---

<objective>
Build the leaderboard and activity timeline components for the analytics page.

Purpose: The leaderboard ranks tracked accounts by engagement, helping users identify top performers. The activity timeline provides a chronological view of all events (posts captured, config changes), doubling as navigation to related items.
Output: Leaderboard with "View all" support, ActivityTimeline with day grouping and infinite scroll, ActivityEvent item component.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

Reference existing patterns:
@src/hooks/use-analytics.ts (useAnalyticsActivity infinite query — from Plan 01)
@src/types/analytics.ts (LeaderboardEntry, ActivityEvent types — from Plan 01)
@src/components/ui/skeleton.tsx (Skeleton component)
@src/components/platform-icon.tsx (Platform icon rendering)
@src/components/empty-state.tsx (Empty state pattern)
@src/lib/utils.ts (cn utility)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Leaderboard component with ranking and "View all"</name>
  <files>src/components/analytics/leaderboard.tsx, src/components/analytics/leaderboard-skeleton.tsx</files>
  <action>
    1. Create `src/components/analytics/leaderboard.tsx`:

    Props interface:
    ```typescript
    import type { LeaderboardEntry } from '@/types/analytics'

    interface LeaderboardProps {
      entries: LeaderboardEntry[]
      limit?: number        // Show top N (default 5 for preview, undefined for full)
      showViewAll?: boolean  // Show "View all" link
      viewAllHref?: string   // Where "View all" navigates
      className?: string
    }
    ```

    Implementation:
    - Container: `bg-surface border border-border rounded-sm p-6` with className merge
    - Header row: "Top Accounts" in `text-lg font-semibold text-white mb-4`
    - If entries is empty: show centered "No engagement data yet" in text-gray-400 text-sm within a min-h-[200px] flex
    - Table-like layout using divs (no `<table>` — consistent with existing card patterns):
      - Column headers: `text-xs text-gray-500 uppercase tracking-wider` — Rank, Account, Views, Likes, Posts
      - Each row: `flex items-center py-3 border-b border-border last:border-0`
      - Rank: `text-lg font-bold text-gray-400 w-8` — show #1, #2, etc. Top 3 get special colors: #1 gold (text-yellow-400), #2 silver (text-gray-300), #3 bronze (text-orange-400)
      - Account: `flex items-center gap-2` — PlatformIcon (from `@/components/platform-icon`) + username in text-white
      - Views: `text-gray-300` with `.toLocaleString()` formatting
      - Likes: `text-gray-300` with `.toLocaleString()` formatting
      - Posts: `text-gray-400` count
    - If `limit` is set, slice entries to `limit`
    - If `showViewAll && entries.length > 0`: Show "View all" link at bottom
      - `text-sm text-accent-purple hover:underline` — links to `viewAllHref`
      - Use Next.js `Link` component

    2. Create `src/components/analytics/leaderboard-skeleton.tsx`:
    - Props: `{ count?: number }` (default 5)
    - Same container as Leaderboard
    - Skeleton for header (h-6 w-40 mb-4)
    - `count` rows of skeleton items:
      - Each: flex items-center gap-4 py-3
      - Skeleton circle for rank (h-6 w-6)
      - Skeleton line for account (h-4 w-32)
      - Skeleton line for metrics (h-4 w-16) x3
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors.</verify>
  <done>Leaderboard renders ranked accounts with engagement metrics. Top 3 have medal-colored ranks. Empty state for no data. "View all" link when in preview mode.</done>
</task>

<task type="auto">
  <name>Task 2: Create ActivityTimeline with day grouping and infinite scroll</name>
  <files>src/components/analytics/activity-timeline.tsx, src/components/analytics/activity-event.tsx</files>
  <action>
    1. Create `src/components/analytics/activity-event.tsx`:

    Props:
    ```typescript
    import type { ActivityEvent as ActivityEventType } from '@/types/analytics'

    interface ActivityEventProps {
      event: ActivityEventType
      guildId: string
    }
    ```

    Implementation:
    - Row layout: `flex items-start gap-3 py-2`
    - Left icon: colored circle/dot based on event type:
      - `post_captured`: blue dot (bg-blue-500)
      - `settings_changed`: yellow dot (bg-yellow-500)
      - `account_added` / `brand_added`: green dot (bg-green-500)
      - `account_removed` / `brand_removed`: red dot (bg-red-500)
      - Dot: `w-2 h-2 rounded-full mt-2 flex-shrink-0`
    - Content: `flex-1 min-w-0`
      - Description: `text-sm text-gray-300` — event.description
      - Time: `text-xs text-gray-500` — format event.created_at time portion (e.g., "2:35 PM")
    - If event.link: wrap description in Next.js `Link` with `hover:text-white transition-colors`
      - Build link from event type and guildId:
        - post_captured: `/guilds/${guildId}/posts` (with date filter if link contains date info)
        - account_added/removed: `/guilds/${guildId}/accounts`
        - brand_added/removed: `/guilds/${guildId}/brands`
        - settings_changed: `/guilds/${guildId}` (guild overview with settings)

    2. Create `src/components/analytics/activity-timeline.tsx`:

    Props:
    ```typescript
    interface ActivityTimelineProps {
      guildId: string
      className?: string
    }
    ```

    Implementation:
    - `'use client'` directive
    - Import `useAnalyticsActivity` from `@/hooks/use-analytics`
    - Import `useInView` from `react-intersection-observer`
    - Import `useEffect` from `react`
    - Container: `bg-surface border border-border rounded-sm p-6` with className
    - Header: "Recent Activity" in `text-lg font-semibold text-white mb-4`

    **Day grouping logic:**
    - Flatten all pages: `data?.pages.flatMap(p => p.events) || []`
    - Group by day using a `groupEventsByDay` function:
      - For each event, compute date label:
        - isToday: "Today"
        - isYesterday: "Yesterday"
        - Otherwise: format as "MMM d" (e.g., "Jan 28") using date-fns `format`, `isToday`, `isYesterday`
      - Use `reduce` to group into `Record<string, ActivityEventType[]>`
    - Render each group with:
      - Date header: `text-sm font-semibold text-gray-400 mb-2 mt-4 first:mt-0` — sticky or just normal
      - Events within group: map to `<ActivityEvent />` components

    **Infinite scroll:**
    - `const { ref, inView } = useInView()`
    - `useEffect` that calls `fetchNextPage()` when `inView && hasNextPage && !isFetchingNextPage`
    - Sentinel div: `{hasNextPage && <div ref={ref} className="h-4" />}`
    - Loading more indicator: `{isFetchingNextPage && <Skeleton className="h-12 mt-2" />}`

    **Empty state:**
    - If `!isLoading && events.length === 0`: "No recent activity" centered in text-gray-400

    **Loading state:**
    - If `isLoading`: Show 5 skeleton rows (h-8 w-full with varying widths)
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify imports from use-analytics resolve.</verify>
  <done>ActivityTimeline groups events by day with relative date headers. Infinite scroll loads more events. Events are clickable, linking to related resources. Empty and loading states handled.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Leaderboard renders entries with rank, account, and engagement metrics
- ActivityTimeline groups events with "Today" / "Yesterday" / date headers
- ActivityEvent renders clickable links for different event types
- Infinite scroll sentinel element present when hasNextPage
</verification>

<success_criteria>
Leaderboard and activity timeline components ready for page assembly. Both handle empty states and loading. Activity timeline uses established infinite scroll pattern.
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics/06-04-SUMMARY.md`
</output>
