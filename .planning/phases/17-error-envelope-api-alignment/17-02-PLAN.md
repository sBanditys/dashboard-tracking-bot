---
phase: 17-error-envelope-api-alignment
plan: 02
type: execute
wave: 2
depends_on:
  - 17-01
files_modified:
  - src/hooks/use-alerts.ts
  - src/hooks/use-email-alerts.ts
  - src/hooks/use-guilds.ts
  - src/hooks/use-tracking.ts
  - src/hooks/use-bulk-operations.ts
  - src/hooks/use-import.ts
  - src/hooks/use-exports.ts
  - src/lib/validators.ts
  - src/app/providers.tsx
  - src/app/(dashboard)/guilds/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/brands/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/posts/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx
  - src/components/audit/audit-log-table.tsx
  - src/components/bonus/results-tab.tsx
  - src/components/import-export/export-history-list.tsx
  - src/components/alerts/email-config-section.tsx
autonomous: true
requirements:
  - ERR-01
  - ERR-04

must_haves:
  truths:
    - "All mutation hooks read the correct .error field from proxy responses — never .message — so backend error messages actually display in toast notifications"
    - "The parseApiError helper is used consistently across all hooks instead of ad-hoc field access"
    - "Zod v4 audit is complete — zero deprecated v3 patterns exist in src/"
    - "A shared validators file exists with v4-native patterns ready for future use"
    - "Toast notifications auto-dismiss after 5 seconds per user decision"
    - "Every inline data-loading error state shows a 'Try again' retry button wired to refetch"
  artifacts:
    - path: "src/hooks/use-alerts.ts"
      provides: "Fixed error extraction using parseApiError"
      contains: "parseApiError"
    - path: "src/hooks/use-email-alerts.ts"
      provides: "Fixed error extraction using parseApiError"
      contains: "parseApiError"
    - path: "src/hooks/use-guilds.ts"
      provides: "Fixed error extraction using parseApiError"
      contains: "parseApiError"
    - path: "src/hooks/use-tracking.ts"
      provides: "Fixed error extraction using parseApiError"
      contains: "parseApiError"
    - path: "src/hooks/use-bulk-operations.ts"
      provides: "Fixed error extraction using parseApiError"
      contains: "parseApiError"
    - path: "src/hooks/use-import.ts"
      provides: "Fixed error extraction using parseApiError"
      contains: "parseApiError"
    - path: "src/hooks/use-exports.ts"
      provides: "Fixed error extraction using parseApiError"
      contains: "parseApiError"
    - path: "src/lib/validators.ts"
      provides: "Zod v4-native shared validators"
      contains: "z.email"
    - path: "src/app/providers.tsx"
      provides: "Toast auto-dismiss configuration"
      contains: "duration: 5000"
  key_links:
    - from: "src/hooks/*.ts"
      to: "src/lib/api-error.ts"
      via: "import { parseApiError }"
      pattern: "parseApiError"
    - from: "src/hooks/*.ts"
      to: "toast notifications"
      via: "throw new Error(parseApiError(body, fallback)) -> onError -> toast.error"
      pattern: "parseApiError.*throw new Error"
---

<objective>
Fix all client hooks to use the correct error field from proxy responses, complete Zod v4 audit, configure toast auto-dismiss, and add retry buttons to all inline error states.

Purpose: Even with the dual-parse sanitizer from Plan 01, hooks still read `.message` from proxy responses (which only have `.error`). This means error messages are silently lost and users always see fallback text like "Failed to create threshold". Additionally, several inline error states lack the "Try again" retry button required by the locked user decision. This plan fixes every hook to use the `parseApiError` helper from Plan 01, confirms the Zod audit finding, creates shared validators, sets toast duration to 5 seconds, and ensures every inline error state has a retry button.

Output: All hooks correctly display backend error messages. Zod v4 audit documented. Toast auto-dismiss at 5s. All inline error states have retry buttons.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-error-envelope-api-alignment/17-CONTEXT.md
@.planning/phases/17-error-envelope-api-alignment/17-RESEARCH.md
@.planning/phases/17-error-envelope-api-alignment/17-01-SUMMARY.md
@src/lib/api-error.ts
@src/hooks/use-alerts.ts
@src/hooks/use-email-alerts.ts
@src/hooks/use-guilds.ts
@src/hooks/use-tracking.ts
@src/hooks/use-bulk-operations.ts
@src/hooks/use-import.ts
@src/hooks/use-exports.ts
@src/app/providers.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix all hooks to use parseApiError helper for error extraction</name>
  <files>src/hooks/use-alerts.ts, src/hooks/use-email-alerts.ts, src/hooks/use-guilds.ts, src/hooks/use-tracking.ts, src/hooks/use-bulk-operations.ts, src/hooks/use-import.ts, src/hooks/use-exports.ts</files>
  <action>
In every hook file listed, add the import at the top:
```typescript
import { parseApiError } from '@/lib/api-error';
```

Then replace every instance of the broken pattern:
```typescript
// BEFORE (broken — reads non-existent .message field):
const error = await response.json()
throw new Error(error.message || 'Failed to ...')

// AFTER (correct — uses parseApiError which reads .error field):
const body = await response.json()
throw new Error(parseApiError(body, 'Failed to ...'))
```

**Specific files and changes:**

**src/hooks/use-alerts.ts** (4 locations):
- ~line 83-84: `const error = await response.json()` + `throw new Error(error.message || 'Failed to create threshold')` -> `const body = await response.json()` + `throw new Error(parseApiError(body, 'Failed to create threshold'))`
- ~line 119-120: same pattern for 'Failed to delete threshold'
- ~line 160-161: same pattern for 'Failed to toggle threshold'
- ~line 199-200: same pattern for 'Failed to update alert settings'

**src/hooks/use-email-alerts.ts** (4 locations):
- ~line 43-44: 'Failed to update email config'
- ~line 74-75: 'Failed to add recipient'
- ~line 106-107: 'Failed to remove recipient'
- ~line 136-137: 'Failed to resend verification'

**src/hooks/use-guilds.ts** (3 locations):
- ~line 159-160: 'Failed to update settings'
- ~line 238-239: 'Failed to delete account'
- ~line 268-269: 'Failed to delete brand'

**src/hooks/use-tracking.ts** (3 locations):
- ~line 217-218: 'Failed to delete account'
- ~line 266-267: 'Failed to add account'
- ~line 301-302: 'Failed to add brand'

**src/hooks/use-bulk-operations.ts** (2 locations):
- ~line 25-26: 'Failed to delete items'
- ~line 71-72: 'Failed to reassign accounts'

**src/hooks/use-import.ts** (2 locations):
- ~line 63-64: 'Failed to preview import'
- ~line 106-108: This one reads `(errBody as { message?: string }).message || 'Failed to confirm import'` — change to `parseApiError(errBody, 'Failed to confirm import')`

**src/hooks/use-exports.ts** (1 location):
- ~line 46: `throw new Error(data.error || data.message || 'Failed to create export')` -> `throw new Error(parseApiError(data, 'Failed to create export'))` (this one already reads `.error` first but also tries `.message` — normalize to use the helper)

**Variable naming:** Change `const error = await response.json()` to `const body = await response.json()` to avoid shadowing the `error` parameter in catch blocks and to reflect that the variable holds the response body, not an Error object.

**Console logging per user decision:** In development mode only, log full error details. After each `throw new Error(parseApiError(...))`, the error will propagate to onError/catch handlers in the hooks where toast.error is called — this is already the correct flow. No additional console.log needed in the hooks themselves; the existing fetchWithRetry console.warn for retries is sufficient.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Grep for `error.message || 'Failed` across src/hooks/ — should return ZERO results (all replaced with parseApiError). Grep for `parseApiError` across src/hooks/ — should find imports in all 7 hook files.
  </verify>
  <done>
All 7 hook files use parseApiError to extract error messages from proxy responses. The correct `.error` field is read instead of the non-existent `.message` field. Backend error messages now propagate all the way to toast notifications.
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete Zod v4 audit, create shared validators, and configure toast duration</name>
  <files>src/lib/validators.ts, src/app/providers.tsx</files>
  <action>
**Zod v4 Audit (ERR-04):**

1. Confirm the audit finding from research: grep for `from 'zod'` and `from "zod"` across src/ — expect ZERO results. The dashboard has Zod v4.3.6 installed but does not import it anywhere in application code. This means there are no deprecated v3 patterns to replace.

2. Also grep for `z.string().email()`, `z.string().uuid()`, `.flatten()`, `.format()`, `error.errors` (the Zod v3 alias for .issues) across src/ — expect ZERO results for Zod-related matches.

3. Document the audit result as a code comment in the new validators file.

**Create src/lib/validators.ts (new file):**

Create a shared validators file with v4-native patterns ready for future use. Per user decision: "Extract common validators (email, UUID, etc.) to a shared validation utils file with user-friendly custom error messages" and "Use Zod v4's `.check()` and other new patterns where they improve readability."

```typescript
/**
 * Shared validation schemas using Zod v4-native patterns.
 *
 * Zod v4 Audit Result (Phase 17, ERR-04):
 * - Zero Zod imports found in src/ as of 2026-02-22
 * - No deprecated v3 patterns to replace (.email(), .uuid(), .flatten(), .format(), .errors)
 * - Zod v4.3.6 is installed; these schemas use v4-native top-level forms
 *
 * Usage: Import these schemas in any component or hook that needs validation.
 * These replace the deprecated v3 patterns (z.string().email() -> z.email()).
 */

import { z } from 'zod';

// --- String format validators (v4 top-level forms) ---

/** Email address validator with custom error message */
export const emailSchema = z.email({ message: 'Please enter a valid email address' });

/** UUID validator with custom error message */
export const uuidSchema = z.uuid({ message: 'Invalid identifier format' });

/** URL validator with custom error message */
export const urlSchema = z.url({ message: 'Please enter a valid URL' });

// --- Common field schemas ---

/** Discord guild ID (snowflake — numeric string, 17-20 digits) */
export const guildIdSchema = z.string().check(
  (val) => /^\d{17,20}$/.test(val),
  'Invalid Discord server ID'
);

/** Non-empty trimmed string */
export const nonEmptyString = z.string().check(
  (val) => val.trim().length > 0,
  'This field cannot be empty'
);

// --- Error formatting ---

/**
 * Extract user-friendly error messages from a Zod validation result.
 * Uses v4's .issues (not deprecated .errors alias).
 *
 * @param error - ZodError from a failed safeParse
 * @returns Array of human-readable error messages
 */
export function formatZodErrors(error: z.ZodError): string[] {
  return error.issues.map((issue) => issue.message);
}
```

**Configure toast duration in src/app/providers.tsx:**

Per user decision: "Dismissible + auto-dismiss after 5s (user can click X or wait)."

In the `ThemedToaster` component's `toastOptions`, add `duration: 5000` (default sonner is 4000ms, user wants 5s).

Change:
```typescript
toastOptions={{
  style: {
```
To:
```typescript
toastOptions={{
  duration: 5000,
  style: {
```

This applies to all toasts globally. Individual toasts can still override with `toast.error('msg', { duration: 10000 })` if needed.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Confirm src/lib/validators.ts exists and imports from 'zod'. Confirm providers.tsx has `duration: 5000` in toastOptions. Run `grep -r "from 'zod'" src/ | grep -v validators.ts | grep -v node_modules` — should return ZERO results (only validators.ts imports Zod).
  </verify>
  <done>
Zod v4 audit complete — zero deprecated patterns found in src/, documented in validators.ts header comment. Shared validators file created with v4-native email, UUID, URL, guildId, nonEmptyString schemas and formatZodErrors helper. Toast auto-dismiss configured at 5 seconds in providers.tsx.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add retry buttons to all inline error states missing them</name>
  <files>src/app/(dashboard)/guilds/page.tsx, src/app/(dashboard)/guilds/[guildId]/brands/page.tsx, src/app/(dashboard)/guilds/[guildId]/posts/page.tsx, src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx, src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx, src/components/audit/audit-log-table.tsx, src/components/bonus/results-tab.tsx, src/components/import-export/export-history-list.tsx, src/components/alerts/email-config-section.tsx</files>
  <action>
Per locked user decision: "Inline errors: Always show a 'Try again' retry button in error state."

Several components already have retry buttons (guilds/[guildId]/page.tsx, bonus/leaderboard-tab.tsx, bonus/rounds-tab.tsx, import-tab.tsx, export-tab.tsx, error.tsx boundaries). The following components show inline error text WITHOUT a retry button and need updating.

For each component below, destructure `refetch` from the React Query hook (it is already returned by useQuery), then replace the error-only `<div>` with one that includes a retry button. Follow the existing pattern from `bonus/leaderboard-tab.tsx` for consistent styling:

```typescript
// Pattern to follow (from leaderboard-tab.tsx):
<div className="flex flex-col items-center justify-center py-12 gap-4">
  <p className="text-sm text-red-400">Failed to load ...</p>
  <button
    type="button"
    onClick={() => refetch()}
    className="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-surface border border-border text-gray-300 hover:bg-surface-hover transition-colors"
  >
    <RefreshCw size={14} />
    Try again
  </button>
</div>
```

Import `RefreshCw` from `lucide-react` in each file (add to existing lucide import if one exists).

**1. src/app/(dashboard)/guilds/page.tsx:**
- Destructure `refetch` alongside `data, isLoading, isError` from `useGuilds()`
- Replace the `isError` block (currently just `<p className="text-red-400">Failed to load guilds. Please try again.</p>`) with the retry button pattern above, message: "Failed to load guilds"

**2. src/app/(dashboard)/guilds/[guildId]/brands/page.tsx:**
- Destructure `refetch` alongside `data, isLoading, isError` from `useBrands(guildId)`
- Replace the `isError` block (currently just `<p className="text-red-400">Failed to load brands</p>`) with retry button pattern, message: "Failed to load brands"

**3. src/app/(dashboard)/guilds/[guildId]/posts/page.tsx:**
- Destructure `refetch` from the query hook (already has `data, isLoading, error, isError`)
- Replace the `isError` block (currently just `<p className="text-red-400">{errorMessage}</p>`) with retry button pattern, keep the dynamic error message

**4. src/app/(dashboard)/guilds/[guildId]/accounts/page.tsx:**
- Destructure `refetch` from the query hook (already has `data, isLoading, isError`)
- Replace the `isError` block (currently just `<p className="text-red-400">Failed to load accounts</p>`) with retry button pattern, message: "Failed to load accounts"

**5. src/app/(dashboard)/guilds/[guildId]/manage/alerts/page.tsx:**
- Destructure `refetch` from the `useAlertThresholds` hook
- Replace the `isError` block (currently just `<p className="text-red-400">Failed to load alert thresholds</p>`) with retry button pattern, message: "Failed to load alert thresholds"

**6. src/components/audit/audit-log-table.tsx:**
- The hook `useAuditLog` already returns a useQuery result — destructure `refetch` from it
- Replace the `isError` block (currently `<div className="text-red-400">Failed to load audit log</div>`) with retry button pattern, message: "Failed to load audit log"

**7. src/components/bonus/results-tab.tsx:**
- Destructure `refetch` from `useBonusResults(guildId, roundId, evaluated)`
- Replace the `isError` block (currently `<div>Failed to load results.</div>`) with retry button pattern, message: "Failed to load results"

**8. src/components/import-export/export-history-list.tsx:**
- Destructure `refetch` from `useExportHistory(guildId, page, 20)`
- Replace the `isError` block (currently `<p>Failed to load export history.</p>`) with retry button pattern, message: "Failed to load export history"

**9. src/components/alerts/email-config-section.tsx:**
- Destructure `refetch` from `useEmailConfig(guildId)`
- Replace the `isError` inline text (currently `<p className="text-sm text-red-400 pt-4">Failed to load email settings</p>`) with a retry button added after the text — keep it inline since this is not a full-page error, just add a small button below the text:
```typescript
{isError && (
  <div className="pt-4 space-y-2">
    <p className="text-sm text-red-400">Failed to load email settings</p>
    <button
      type="button"
      onClick={() => refetch()}
      className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded-md bg-surface border border-border text-gray-300 hover:bg-surface-hover transition-colors"
    >
      <RefreshCw size={12} />
      Try again
    </button>
  </div>
)}
```

**Note:** Some components that already have retry buttons (guilds/[guildId]/page.tsx uses `window.location.reload()` instead of `refetch()`) are acceptable — full page reload is a valid retry strategy for the guild detail page. Do NOT change existing working retry buttons.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Grep for `Try again` across all 9 files listed — each should contain the retry button text. Grep for `refetch` across the same files — each should destructure refetch from its query hook. Run a final audit: grep for `isError` in src/app/ and src/components/ and verify every match either (a) has a retry/try-again button nearby, or (b) is in a context where retry doesn't apply (e.g. form validation errors, not data-loading).
  </verify>
  <done>
Every inline data-loading error state in the dashboard shows a "Try again" retry button wired to the query's refetch function. The locked user decision "Inline errors: Always show a 'Try again' retry button in error state" is fully implemented.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `grep -r "error\.message || 'Failed" src/hooks/` returns nothing (all hooks use parseApiError)
3. `grep -r "parseApiError" src/hooks/` finds imports in all 7 hook files
4. `grep -r "from 'zod'" src/ | grep -v validators.ts` returns nothing (only validators.ts imports Zod)
5. `grep "duration: 5000" src/app/providers.tsx` confirms toast duration
6. src/lib/validators.ts exists with v4-native schemas
7. `grep -r "Try again" src/app/(dashboard)/guilds/page.tsx src/app/(dashboard)/guilds/*/brands/page.tsx src/app/(dashboard)/guilds/*/posts/page.tsx src/app/(dashboard)/guilds/*/accounts/page.tsx src/app/(dashboard)/guilds/*/manage/alerts/page.tsx src/components/audit/audit-log-table.tsx src/components/bonus/results-tab.tsx src/components/import-export/export-history-list.tsx src/components/alerts/email-config-section.tsx` returns a match in every file
</verification>

<success_criteria>
- All 7 hook files (use-alerts, use-email-alerts, use-guilds, use-tracking, use-bulk-operations, use-import, use-exports) use parseApiError to extract error messages
- Zero instances of `error.message || 'Failed to` remain in src/hooks/
- Zod v4 audit confirmed and documented — zero deprecated patterns in src/
- Shared validators file exists at src/lib/validators.ts with v4-native schemas
- Toast auto-dismiss is 5 seconds in providers.tsx
- Every inline data-loading error state has a "Try again" retry button wired to refetch
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-error-envelope-api-alignment/17-02-SUMMARY.md`
</output>
