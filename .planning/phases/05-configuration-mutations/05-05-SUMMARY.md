---
phase: 05-configuration-mutations
plan: 05
subsystem: tracking-mutations
tags: [react-query, mutations, modals, headless-ui, forms]
requires: [05-01]
provides: [add-account-modal, add-brand-modal, create-mutations]
affects: [accounts-page, brands-page]
tech-stack:
  added: []
  patterns: [headless-ui-dialog, form-validation, cache-invalidation]
key-files:
  created:
    - src/components/forms/add-account-modal.tsx
    - src/components/forms/add-brand-modal.tsx
  modified:
    - src/hooks/use-tracking.ts
    - src/components/forms/add-account-form.tsx
    - src/components/forms/add-brand-form.tsx
    - src/app/api/guilds/[guildId]/accounts/route.ts (already had POST)
    - src/app/api/guilds/[guildId]/brands/route.ts (already had POST)
decisions:
  - id: DEV-036
    title: Purple submit buttons for modals
    choice: bg-accent-purple for all modal submit actions
    rationale: Consistent with design system for primary actions
  - id: DEV-037
    title: Username @ prefix stripping
    choice: Automatically strip @ prefix from usernames
    rationale: User convenience - handles both "@username" and "username" input
  - id: DEV-038
    title: Slug auto-generation
    choice: Optional slug field with backend auto-generation
    rationale: Simplifies UX while allowing override for advanced users
metrics:
  duration: 2m 25s
  completed: 2026-02-06
---

# Phase 5 Plan 5: Add Account/Brand Modal Forms Summary

**One-liner:** Modal forms with validation for adding tracked accounts (platform, username, brand) and brands (label, slug) using Headless UI Dialog.

**Status:** Complete ✓

## What Was Built

### Overview

Implemented modal forms for creating new tracked accounts and brands with validation, error handling, and cache invalidation. Both modals follow the Headless UI Dialog pattern established in ConfirmationModal (05-01).

### Components Created

**AddAccountModal** (`src/components/forms/add-account-modal.tsx`)
- Platform select dropdown (instagram, tiktok, youtube, x)
- Username input with automatic @ prefix stripping
- Brand select populated from useBrands hook
- Form validation: username and brand required
- Error display for failed mutations
- Loading states during submission
- Resets form and closes on success

**AddBrandModal** (`src/components/forms/add-brand-modal.tsx`)
- Label input (required)
- Slug input (optional, auto-generated by backend)
- Form validation: label required
- Error display for failed mutations
- Loading states during submission
- Resets form and closes on success

### Hooks Enhanced

**useAddAccount** (`src/hooks/use-tracking.ts`)
- Updated to accept proper request type (platform, username, brand_id, optional group_id)
- Cache invalidation for accounts, brands, and guild details

**useAddBrand** (`src/hooks/use-tracking.ts`)
- Updated to accept proper request type (label, optional slug)
- Cache invalidation for brands and guild details

### API Routes

Both POST routes already existed and follow correct proxy pattern:
- `/api/guilds/[guildId]/accounts` (POST)
- `/api/guilds/[guildId]/brands` (POST)

## Task Commits

| Task | Description | Commit | Files |
|------|-------------|--------|-------|
| 1 | Add POST Routes | (skip) | Already existed |
| 2 | Add Create Mutation Hooks | b2cc9a6 | use-tracking.ts, add-account-form.tsx, add-brand-form.tsx |
| 3 | Create Add Account and Add Brand Modals | a25f07b | add-account-modal.tsx, add-brand-modal.tsx |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Update existing form components**
- **Found during:** Task 2 TypeScript compilation
- **Issue:** Existing add-account-form.tsx and add-brand-form.tsx used old mutation signatures
- **Fix:** Updated both components to match new request types
- **Files modified:**
  - src/components/forms/add-account-form.tsx
  - src/components/forms/add-brand-form.tsx
- **Commit:** b2cc9a6 (included in Task 2)
- **Rationale:** Required to fix TypeScript errors and ensure consistency

## Decisions Made

**DEV-036: Purple submit buttons for modals**
- Use `bg-accent-purple` for all modal submit actions
- Consistent with design system for primary actions
- Differentiates from red destructive actions (delete) and gray cancel

**DEV-037: Username @ prefix stripping**
- Automatically strip @ prefix from username input
- Handles both "@username" and "username" format
- Improves user convenience - no need to remember format

**DEV-038: Slug auto-generation**
- Slug field optional in AddBrandModal
- Backend auto-generates slug from label if not provided
- Simplifies common case while allowing advanced users to override

## Integration Points

### Component Usage
- Brands pages can trigger AddBrandModal
- Accounts pages can trigger AddAccountModal
- Both integrate with existing query cache system

### Data Flow
1. User opens modal (parent component manages open state)
2. User fills form and submits
3. Modal validates input client-side
4. Mutation POSTs to API route
5. API route proxies to backend
6. On success: invalidate queries, reset form, close modal
7. On error: display error message

### Cache Invalidation Strategy
- **Add Account:** Invalidates accounts, brands (for account_count), and guild details
- **Add Brand:** Invalidates brands and guild details

## Testing Notes

### Manual Testing Checklist
- [ ] AddAccountModal opens and closes correctly
- [ ] Platform dropdown shows all 4 options
- [ ] Username validation blocks empty submission
- [ ] Brand select populates from useBrands hook
- [ ] Brand validation blocks empty submission
- [ ] Username @ prefix is stripped (try "@test" vs "test")
- [ ] Success case: form resets and modal closes
- [ ] Error case: error message displays
- [ ] Loading state shows during submission
- [ ] Cache refreshes after successful creation

- [ ] AddBrandModal opens and closes correctly
- [ ] Label validation blocks empty submission
- [ ] Slug is optional (can submit empty)
- [ ] Success case: form resets and modal closes
- [ ] Error case: error message displays
- [ ] Loading state shows during submission
- [ ] Cache refreshes after successful creation

### TypeScript Verification
```bash
npx tsc --noEmit  # ✓ Passes
```

## Next Phase Readiness

### Blockers
None.

### Concerns
None - modals are ready for integration into pages.

### Recommended Next Steps
1. **Integrate modals into pages** - Add "Add Account" and "Add Brand" buttons to accounts/brands pages
2. **Add keyboard shortcuts** - Consider ESC to close, Enter to submit
3. **Add success toasts** - Visual confirmation beyond modal close
4. **Add group selection** - AddAccountModal can include optional group_id field

## Self-Check: PASSED

**Created files verified:**
- [✓] src/components/forms/add-account-modal.tsx
- [✓] src/components/forms/add-brand-modal.tsx

**Commits verified:**
- [✓] b2cc9a6 (Task 2)
- [✓] a25f07b (Task 3)
