---
phase: 08-polish-optimization
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/hooks/use-guilds.ts
  - src/hooks/use-bulk-operations.ts
  - src/hooks/use-exports.ts
  - src/hooks/use-trash.ts
autonomous: true

must_haves:
  truths:
    - "All mutations show toast.success on success and toast.error on failure"
    - "Settings mutation uses optimistic update pattern (show change immediately, rollback on error)"
    - "Delete mutations use optimistic update (remove item from list immediately, rollback on error)"
    - "All fetch calls in hooks use fetchWithRetry for 429 resilience"
  artifacts:
    - path: "src/hooks/use-guilds.ts"
      provides: "Optimistic updates on useUpdateGuildSettings, useDeleteAccount, useDeleteBrand + toast + fetchWithRetry"
      contains: "onMutate"
    - path: "src/hooks/use-bulk-operations.ts"
      provides: "Toast notifications on bulk delete/reassign + fetchWithRetry"
      contains: "toast"
    - path: "src/hooks/use-exports.ts"
      provides: "Toast on export create + fetchWithRetry on queries"
      contains: "toast"
    - path: "src/hooks/use-trash.ts"
      provides: "Toast on restore/delete + fetchWithRetry on queries"
      contains: "toast"
  key_links:
    - from: "src/hooks/use-guilds.ts"
      to: "src/lib/fetch-with-retry.ts"
      via: "import fetchWithRetry"
      pattern: "fetchWithRetry"
    - from: "src/hooks/use-guilds.ts"
      to: "sonner"
      via: "import toast"
      pattern: "toast\\.(success|error)"
---

<objective>
Add optimistic updates to all mutations, toast notifications for success/error on all operations, and integrate fetchWithRetry across all hooks for 429 resilience.

Purpose: Users see changes immediately (optimistic), get clear feedback on success/failure (toasts), and never experience broken pages from rate limiting (retry logic).
Output: All mutation hooks enhanced with optimistic updates + toast + retry.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-optimization/08-RESEARCH.md
@.planning/phases/08-polish-optimization/08-01-SUMMARY.md

@src/hooks/use-guilds.ts
@src/hooks/use-bulk-operations.ts
@src/hooks/use-exports.ts
@src/hooks/use-trash.ts
@src/lib/fetch-with-retry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add optimistic updates, toasts, and fetchWithRetry to use-guilds.ts</name>
  <files>
    src/hooks/use-guilds.ts
  </files>
  <action>
    Import `{ toast }` from 'sonner' and `{ fetchWithRetry }` from '@/lib/fetch-with-retry'.

    1. **All query hooks** (useGuilds, useGuild, useGuildStatus, useGuildUsage, useGuildChannels):
       - Replace `fetch(url)` with `fetchWithRetry(url)` in queryFn
       - Keep all other logic identical

    2. **useUpdateGuildSettings** — Add optimistic update:
       - `onMutate`: cancel queries for ['guild', guildId], snapshot previous, optimistically merge new settings into cache
       - `onError`: rollback to snapshot via setQueryData, show `toast.error('Failed to update settings')`
       - `onSuccess`: show `toast.success('Settings updated')` (keep existing cache update)
       - `onSettled`: invalidate ['guild', guildId] to sync with server

    3. **useDeleteAccount** — Add optimistic update:
       - `onMutate`: cancel queries for accounts, snapshot, remove account from infinite query cache pages
       - `onError`: rollback to snapshot, show `toast.error('Failed to delete account')`
       - `onSuccess`: show `toast.success('Account deleted')`
       - `onSettled`: invalidate accounts and guild queries

    4. **useDeleteBrand** — Add optimistic update:
       - `onMutate`: cancel queries for brands, snapshot, remove brand from cache
       - `onError`: rollback to snapshot, show `toast.error('Failed to delete brand')`
       - `onSuccess`: show `toast.success('Brand deleted')`
       - `onSettled`: invalidate brands and guild queries

    5. **useGuildStatusRealtime**: Replace fetch with fetchWithRetry in queryFn

    For optimistic updates on infinite queries (accounts), the pattern is:
    - Use `queryClient.getQueriesData()` to find all matching query cache entries
    - Filter out the deleted item from each page's data
    - On rollback, restore the original entries

    If the infinite query cache structure makes optimistic removal complex, it's acceptable to skip optimistic update for delete and just do toast + invalidate (the key requirement is toast feedback + retry).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All queries use fetchWithRetry
    - All mutations have toast.success and toast.error
    - useUpdateGuildSettings has onMutate optimistic pattern
  </verify>
  <done>
    All query hooks use fetchWithRetry for 429 resilience. Settings mutation has full optimistic update (show change -> rollback on error). Delete mutations have toast notifications. All mutations show success/error toasts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add toasts and fetchWithRetry to remaining hooks</name>
  <files>
    src/hooks/use-bulk-operations.ts
    src/hooks/use-exports.ts
    src/hooks/use-trash.ts
  </files>
  <action>
    Import `{ toast }` from 'sonner' and `{ fetchWithRetry }` from '@/lib/fetch-with-retry' in each file.

    1. **use-bulk-operations.ts**:
       - useBulkDelete: Replace fetch with fetchWithRetry in mutationFn. Add `onError: () => toast.error('Bulk delete failed')`. Keep existing onSuccess invalidation. Note: BulkResultsToast already handles success display, so no toast.success needed here.
       - useBulkReassign: Same pattern — fetchWithRetry + toast.error on failure. Keep existing onSuccess invalidation.

    2. **use-exports.ts**:
       - useCreateExport: fetchWithRetry in mutationFn. Add `onSuccess: () => toast.success('Export started')`, `onError: (err) => toast.error(err.message || 'Failed to create export')`
       - useExportHistory: fetchWithRetry in queryFn
       - useExportStatus (if exists): fetchWithRetry in queryFn
       - Any other query hooks: fetchWithRetry in queryFn

    3. **use-trash.ts**:
       - useTrashItems: fetchWithRetry in queryFn
       - useRestoreItem: fetchWithRetry in mutationFn. Add `onSuccess: () => toast.success('Item restored')`, `onError: () => toast.error('Failed to restore item')`
       - usePermanentDelete: fetchWithRetry in mutationFn. Add `onSuccess: () => toast.success('Item permanently deleted')`, `onError: () => toast.error('Failed to delete item')`

    Also update `src/hooks/use-tracking.ts` and `src/hooks/use-analytics.ts` and `src/hooks/use-audit-log.ts`:
       - Replace all `fetch(url)` calls in queryFn with `fetchWithRetry(url)`
       - No mutation changes needed in these (read-only hooks)

    Note: For mutations that already have inline error handling in UI (like BulkResultsToast), keep existing behavior and only add toast.error as a safety net on the `onError` callback.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All hooks import and use fetchWithRetry
    - Mutations have appropriate toast notifications
    - `grep -r "from 'sonner'" src/hooks/` shows imports in all mutation hook files
  </verify>
  <done>
    All hooks across the application use fetchWithRetry for 429 resilience. All mutations show appropriate toast notifications. Bulk operations, exports, and trash management all have error/success feedback.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Every hook file uses fetchWithRetry for queries
- Every mutation has toast.success and/or toast.error
- useUpdateGuildSettings has optimistic update with onMutate/onError/onSettled
- No console.error-only error handling remaining (all user-facing via toasts)
</verification>

<success_criteria>
- All API calls retry on 429 with exponential backoff
- Settings changes show immediately via optimistic update, rollback on error
- All mutations show toast feedback (success and error)
- No hooks use raw fetch() anymore — all use fetchWithRetry
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-optimization/08-04-SUMMARY.md`
</output>
