---
phase: 06-analytics
plan: 05
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03", "06-04"]
files_modified:
  - src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx
  - src/app/(dashboard)/guilds/[guildId]/page.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Dedicated analytics page shows counters, chart, leaderboard, and activity timeline"
    - "Global time range selector at top affects all sections"
    - "Chart + leaderboard display side-by-side on desktop"
    - "Analytics link appears in sidebar when inside a guild"
    - "Guild overview page shows mini analytics preview (counters + sparkline + top-5 leaderboard)"
    - "Click on data point navigates to posts filtered by that date"
    - "Empty states render correctly when no data exists"
  artifacts:
    - path: "src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx"
      provides: "Full analytics page"
      min_lines: 80
    - path: "src/app/(dashboard)/guilds/[guildId]/page.tsx"
      provides: "Enhanced guild overview with analytics preview"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Analytics link in guild nav"
      contains: "analytics"
  key_links:
    - from: "src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx"
      to: "src/hooks/use-analytics.ts"
      via: "useAnalytics, useAnalyticsLeaderboard hooks"
      pattern: "useAnalytics"
    - from: "src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx"
      to: "src/components/analytics/"
      via: "imports CounterCard, AnalyticsChart, Leaderboard, ActivityTimeline, TimeRangeSelector"
      pattern: "import.*analytics"
    - from: "src/app/(dashboard)/guilds/[guildId]/page.tsx"
      to: "src/components/analytics/mini-sparkline.tsx"
      via: "MiniSparkline import"
      pattern: "MiniSparkline"
---

<objective>
Assemble the full analytics page, add the sidebar navigation link, and enhance the guild overview with a mini analytics preview.

Purpose: This plan brings all analytics components together into the page layout the user specified: counters across top, graph + leaderboard side-by-side in middle, activity timeline below. It also adds a compact preview to the guild overview that entices users to click through to the full analytics page.
Output: Complete analytics page, updated sidebar with Analytics link, enhanced guild overview.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

Components from prior plans:
@src/components/analytics/counter-card.tsx (Plan 02)
@src/components/analytics/counter-card-skeleton.tsx (Plan 02)
@src/components/analytics/time-range-selector.tsx (Plan 02)
@src/components/analytics/analytics-chart.tsx (Plan 03)
@src/components/analytics/analytics-chart-skeleton.tsx (Plan 03)
@src/components/analytics/mini-sparkline.tsx (Plan 03)
@src/components/analytics/leaderboard.tsx (Plan 04)
@src/components/analytics/leaderboard-skeleton.tsx (Plan 04)
@src/components/analytics/activity-timeline.tsx (Plan 04)

Hooks and types:
@src/hooks/use-analytics.ts (Plan 01)
@src/types/analytics.ts (Plan 01)

Existing files to modify:
@src/app/(dashboard)/guilds/[guildId]/page.tsx (guild overview â€” add analytics preview)
@src/components/layout/sidebar.tsx (add Analytics nav link)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create full analytics page with time range selector</name>
  <files>src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx</files>
  <action>
    Create `src/app/(dashboard)/guilds/[guildId]/analytics/page.tsx`:

    `'use client'` directive.

    State: `const [range, setRange] = useState<TimeRange>(30)` â€” default 30 days

    Hooks:
    - `const { data: analytics, isLoading: analyticsLoading } = useAnalytics(guildId, range)`
    - `const { data: leaderboard, isLoading: leaderboardLoading } = useAnalyticsLeaderboard(guildId, range, 10)`

    **Layout (per locked decision):**

    ```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Analytics          [7d] [30d] [90d]         â”‚  â† Header + TimeRangeSelector
    â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚Card1 â”‚Card2 â”‚Card3 â”‚Card4                    â”‚  â† Counter cards (4 across on lg, 2 on md, 1 on sm)
    â”œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚   Area Chart         â”‚ â”‚  Leaderboard    â”‚ â”‚  â† Graph + Leaderboard side-by-side (2/3 + 1/3)
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚ Activity Timeline (infinite scroll)          â”‚  â† Full width below
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ```

    Implementation:

    1. **Header row:** `flex items-center justify-between mb-6`
       - Left: `<h1 className="text-3xl font-bold text-white">Analytics</h1>`
       - Right: `<TimeRangeSelector value={range} onChange={setRange} />`

    2. **Counter cards:** `grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-4 mb-6`
       - If analyticsLoading: render `<CounterCardSkeleton count={4} />`
       - Otherwise, 4 cards:
         - "Tracked Accounts" â€” value: counters.total_accounts, previousValue: previous_period.total_accounts, icon: "ğŸ‘¥"
         - "Total Posts" â€” value: counters.total_posts, previousValue: previous_period.total_posts, icon: "ğŸ“"
         - "Total Brands" â€” value: counters.total_brands, previousValue: previous_period.total_brands, icon: "ğŸ“"
         - "Platform Split" â€” a special card showing `by_platform` breakdown:
           - Value: Object.values(counters.by_platform).reduce(sum), previousValue: same from previous_period or just total_accounts
           - breakdown prop: `Object.entries(counters.by_platform).map(([platform, count]) => ({ platform, count }))`

    3. **Chart + Leaderboard row:** `grid gap-6 lg:grid-cols-3 mb-6`
       - Chart (lg:col-span-2):
         - If analyticsLoading: `<AnalyticsChartSkeleton />`
         - Otherwise: `<AnalyticsChart data={chartData} granularity={analytics.granularity} onDataPointClick={handleDateClick} />`
         - `chartData`: Map analytics.time_series to `{ date: format(parseISO(point.period), 'MMM d'), count: point.count, rawDate: point.period }`
         - Import `format`, `parseISO` from `date-fns`
       - Leaderboard (lg:col-span-1):
         - If leaderboardLoading: `<LeaderboardSkeleton count={5} />`
         - Otherwise: `<Leaderboard entries={leaderboard.leaderboard} limit={10} />`

    4. **Activity Timeline:** Full width
       - `<ActivityTimeline guildId={guildId} />`
       - ActivityTimeline manages its own data fetching internally

    5. **Click-to-navigate handler:**
       ```typescript
       const router = useRouter()
       function handleDateClick(rawDate: string) {
         const dateStr = rawDate.split('T')[0]  // YYYY-MM-DD
         router.push(`/guilds/${guildId}/posts?from=${dateStr}&to=${dateStr}`)
       }
       ```

    Import `useState` from React, `useRouter` from `next/navigation`, `useParams` from `next/navigation`.
    Get guildId from `useParams()` or route params.
  </action>
  <verify>Run `npx tsc --noEmit` â€” no type errors. Verify page renders at `/guilds/{id}/analytics`.</verify>
  <done>Full analytics page with layout: counters â†’ chart+leaderboard â†’ timeline. Time range selector controls all sections. Data point click navigates to posts page.</done>
</task>

<task type="auto">
  <name>Task 2: Add sidebar link and enhance guild overview with analytics preview</name>
  <files>src/components/layout/sidebar.tsx, src/app/(dashboard)/guilds/[guildId]/page.tsx</files>
  <action>
    1. **Update sidebar** (`src/components/layout/sidebar.tsx`):
       - Add an "Analytics" link in the guild-specific navigation section (below the existing "Activity" link)
       - href: `/guilds/${guildId}/analytics`
       - icon: "ğŸ“Š"
       - Active detection: `pathname.includes('/analytics')`
       - Same styling pattern as the existing Activity link

    2. **Enhance guild overview** (`src/app/(dashboard)/guilds/[guildId]/page.tsx`):

       Add analytics preview section between the Stats Grid and Quick Access Cards.

       Import: `useAnalytics`, `useAnalyticsLeaderboard` from `@/hooks/use-analytics`
       Import: `MiniSparkline` from `@/components/analytics/mini-sparkline`
       Import: `Leaderboard` from `@/components/analytics/leaderboard`
       Import: `CounterCard` from `@/components/analytics/counter-card`
       Import Link from `next/link`

       Add hooks (with range 7 for overview â€” show last week):
       ```typescript
       const { data: analytics } = useAnalytics(guildId, 7)
       const { data: leaderboard } = useAnalyticsLeaderboard(guildId, 7, 5)
       ```

       **Replace existing Stats Grid** with enhanced counter cards that include trend indicators:
       - Keep the same 4-card grid layout
       - Use `CounterCard` instead of `StatCard` for Total Brands, Total Accounts, Total Posts
       - Keep Pending Jobs as `StatCard` (no analytics data for it)
       - Wire previousValue from analytics.previous_period if available, fallback to 0

       **Add Analytics Preview section** (new, between cards and Quick Access):
       ```tsx
       {/* Analytics Preview */}
       <div className="grid gap-4 md:grid-cols-3">
         {/* Mini Sparkline Card - takes 2 columns */}
         <Link
           href={`/guilds/${guildId}/analytics`}
           className="md:col-span-2 bg-surface border border-border rounded-sm p-6 hover:border-accent-purple/50 transition-colors"
         >
           <h3 className="text-lg font-semibold text-white mb-2">Submissions This Week</h3>
           {analytics?.time_series ? (
             <MiniSparkline data={analytics.time_series.map(p => ({ value: p.count }))} />
           ) : (
             <Skeleton className="h-[40px]" />
           )}
           <p className="text-sm text-accent-purple mt-2">View full analytics â†’</p>
         </Link>

         {/* Top 5 Leaderboard Preview - takes 1 column */}
         <Leaderboard
           entries={leaderboard?.leaderboard ?? []}
           limit={5}
           showViewAll
           viewAllHref={`/guilds/${guildId}/analytics`}
         />
       </div>
       ```

       **Add Analytics to Quick Access Cards** â€” add a 4th card in the Quick Access grid (change md:grid-cols-3 to md:grid-cols-2 lg:grid-cols-4):
       ```tsx
       <Link
         href={`/guilds/${guildId}/analytics`}
         className="bg-surface border border-border rounded-sm p-6 hover:border-accent-purple/50 transition-colors"
       >
         <h3 className="text-lg font-semibold text-white mb-2">Analytics</h3>
         <p className="text-sm text-gray-400">
           View detailed metrics, submissions graph, and activity timeline
         </p>
       </Link>
       ```
  </action>
  <verify>Run `npx tsc --noEmit` â€” no type errors. Check sidebar has Analytics link. Check guild overview imports MiniSparkline.</verify>
  <done>Sidebar shows Analytics link when on guild page. Guild overview has analytics preview with counter cards, mini sparkline, and top-5 leaderboard. Quick access includes Analytics card.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `/guilds/{id}/analytics` page renders full layout
- Sidebar shows Analytics link between Activity and other links
- Guild overview shows sparkline and leaderboard preview
- Time range selector changes update all analytics sections
- Empty states render when no data
</verification>

<success_criteria>
Complete analytics experience: dedicated page with full layout (counters, chart, leaderboard, timeline), sidebar navigation, and guild overview preview. All data flows from hooks through components. Empty states handled throughout.
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics/06-05-SUMMARY.md`
</output>
