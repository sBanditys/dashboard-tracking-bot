---
milestone: v1.1
audited: 2026-02-22T12:00:00Z
status: gaps_found
scores:
  requirements: 22/24
  phases: 6/6
  integration: 22/24
  flows: 7/9
gaps:
  requirements:
    - id: "AUTH-03"
      status: "unsatisfied"
      phase: "Phase 10 / Phase 14"
      claimed_by_plans: ["10-01-PLAN.md", "14-01-PLAN.md"]
      completed_by_plans: ["10-01-SUMMARY.md", "14-01-SUMMARY.md"]
      verification_status: "passed (code-level) — integration broken at runtime"
      evidence: "CSRF middleware code exists in src/proxy.ts but file is not named middleware.ts and function is not named middleware(). Next.js never invokes it. _csrf_token cookie is never set. fetchWithRetry's X-CSRF-Token injection silently skips (cookie missing). All mutation requests execute without CSRF protection."
    - id: "AUTH-04"
      status: "unsatisfied"
      phase: "Phase 10"
      claimed_by_plans: ["10-03-PLAN.md"]
      completed_by_plans: ["10-03-SUMMARY.md"]
      verification_status: "passed (code-level) — integration broken at runtime"
      evidence: "CSP header builder exists in src/lib/server/security-headers.ts and is correctly applied in src/proxy.ts. But proxy.ts is not active as middleware. Content-Security-Policy header is absent from all page responses. Non-CSP headers (X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy) ARE applied via next.config.mjs."
  integration:
    - from: "Phase 10 (proxy.ts)"
      to: "Next.js middleware system"
      issue: "src/middleware.ts was renamed to src/proxy.ts during Next.js 14→16 upgrade (commit a2a9747). Function exported as 'proxy' not 'middleware'. Next.js does not invoke it."
      affected_requirements: ["AUTH-03", "AUTH-04"]
      fix: "Rename src/proxy.ts → src/middleware.ts AND rename export async function proxy → export async function middleware"
  flows:
    - flow: "CSRF Protection on All Mutations"
      breaks_at: "Cookie issuance — middleware inactive, _csrf_token never set"
    - flow: "CSP Headers on All Pages"
      breaks_at: "Header injection — middleware inactive, Content-Security-Policy never applied"
tech_debt:
  - phase: 09-authentication-security
    items:
      - "AUTH-06 audit comments may have been removed in later commits (git history confirms they were added)"
      - "5 human verification items: silent refresh UX, session expiry grace period, return URL, unverified email page, middleware enforcement"
  - phase: 10-frontend-security-hardening
    items:
      - "CSRF token rotation changed from per-session to per-request during Next.js 16 upgrade"
      - "@edge-csrf/nextjs package replaced with custom implementation in proxy.ts"
      - "8 human verification items: CSRF UX, CSP headers, CSP script blocking, Discord avatars, dark mode toggle, NProgress bar, error messages, static asset headers"
  - phase: 11-session-management
    items:
      - "3 human verification items: visual appearance, multi-device logout flow, current session detection accuracy"
  - phase: 12-bonus-system
    items:
      - "Empty-state 'Create Round' button in rounds-tab.tsx is a no-op (onClick handler is a comment). Feature accessible via page header button."
      - "existingWeekStarts={[]} always empty — week picker won't visually disable already-used weeks. Backend rejects duplicates with 409."
      - "6 human verification items: page layout, week picker, payment toggle, bulk modal, creation form, leaderboard"
  - phase: 13-alert-import-management
    items:
      - "Stale comment in data/page.tsx says 'Export tab: placeholder' but ExportTab is fully rendered"
      - "import-history.tsx shows placeholder when entries empty — no import history API endpoint exists yet"
      - "7 human verification items: admin guard, toggle behavior, drag-drop, SSE import/export, shift-click, sidebar admin/non-admin"
  - phase: 14-fix-import-confirm-csrf-bypass
    items:
      - "Phase 14 fix is structurally correct (fetchWithRetry replaces raw fetch) but operationally inert until middleware is reactivated — fetchWithRetry cannot inject CSRF token because _csrf_token cookie is never set"
      - "2 human verification items: import confirm 403-free flow, SSE progress display"
---

# v1.1 Milestone Audit: Security Hardening & Backend Alignment

**Audited:** 2026-02-22
**Status:** GAPS FOUND
**Score:** 22/24 requirements satisfied

## Milestone Definition of Done

> Harden authentication and security layers, fix session persistence, block unverified accounts, and deliver complete UI for bonus system, alert management, session management, and account import/export.

## Phase Verification Summary

| Phase | Name | VERIFICATION Status | Score | Requirements |
|-------|------|---------------------|-------|-------------|
| 09 | Authentication Security | passed | 4/4 | AUTH-01, AUTH-02, AUTH-06 |
| 10 | Frontend Security Hardening | passed | 11/11 | AUTH-03, AUTH-04, AUTH-05 |
| 11 | Session Management | passed | 4/4 | SESS-01, SESS-02, SESS-03 |
| 12 | Bonus System | passed | 7/7 | BONUS-01 through BONUS-07 |
| 13 | Alert & Import Management | passed | 20/20 | ALERT-01-04, IMPEX-01-04 |
| 14 | Fix Import Confirm CSRF Bypass | passed | 4/4 | AUTH-03, IMPEX-04 |

All 6 phases have VERIFICATION.md files. No unverified phases. All phases passed at the code level. Gaps emerge from cross-phase integration checking.

## Requirements Coverage (3-Source Cross-Reference)

### Source 1: Phase VERIFICATION.md

All 24 requirements marked SATISFIED (or PARTIALLY SATISFIED for BONUS-03) in their respective VERIFICATION.md files.

### Source 2: SUMMARY.md Frontmatter (`requirements-completed`)

| Listed | REQ-IDs |
|--------|---------|
| 14-01-SUMMARY | AUTH-03, IMPEX-04 |
| 12-04-SUMMARY | BONUS-07 |
| 13-01-SUMMARY | ALERT-01-04, IMPEX-01-04 |
| 13-02-SUMMARY | ALERT-01, ALERT-04, IMPEX-01-04 |
| 13-03-SUMMARY | ALERT-01-03 |
| 13-04-SUMMARY | ALERT-04 |
| 13-06-SUMMARY | IMPEX-01 |

**Missing from all SUMMARY frontmatter:** AUTH-01, AUTH-02, AUTH-04, AUTH-05, AUTH-06, SESS-01-03, BONUS-01-06. Phases 09, 10, 11, and early 12 predate the `requirements-completed` frontmatter convention.

### Source 3: REQUIREMENTS.md Traceability

**Checked `[x]`:** AUTH-03, BONUS-01-07, IMPEX-04 (10 total)
**Unchecked `[ ]`:** AUTH-01, AUTH-02, AUTH-04-06, SESS-01-03, ALERT-01-04, IMPEX-01-03 (14 total)

14 checkboxes need updating to match VERIFICATION evidence.

### Final Status Matrix (3-Source + Integration)

| REQ-ID | VERIFICATION | SUMMARY | REQUIREMENTS | Integration | Final |
|--------|-------------|---------|--------------|-------------|-------|
| AUTH-01 | passed | missing | `[ ]` | WIRED | **satisfied** |
| AUTH-02 | passed | missing | `[ ]` | WIRED | **satisfied** |
| AUTH-03 | passed | listed | `[x]` | **UNWIRED** | **UNSATISFIED** |
| AUTH-04 | passed | missing | `[ ]` | **UNWIRED** | **UNSATISFIED** |
| AUTH-05 | passed | missing | `[ ]` | WIRED | **satisfied** |
| AUTH-06 | passed | missing | `[ ]` | WIRED | **satisfied** |
| SESS-01 | passed | missing | `[ ]` | WIRED | **satisfied** |
| SESS-02 | passed | missing | `[ ]` | WIRED | **satisfied** |
| SESS-03 | passed | missing | `[ ]` | WIRED | **satisfied** |
| BONUS-01 | passed | missing | `[x]` | WIRED | **satisfied** |
| BONUS-02 | passed | missing | `[x]` | WIRED | **satisfied** |
| BONUS-03 | partial | missing | `[x]` | WIRED | **satisfied** (minor UX gap) |
| BONUS-04 | passed | missing | `[x]` | WIRED | **satisfied** |
| BONUS-05 | passed | missing | `[x]` | WIRED | **satisfied** |
| BONUS-06 | passed | missing | `[x]` | WIRED | **satisfied** |
| BONUS-07 | passed | listed | `[x]` | WIRED | **satisfied** |
| ALERT-01 | passed | listed | `[ ]` | WIRED | **satisfied** |
| ALERT-02 | passed | listed | `[ ]` | WIRED | **satisfied** |
| ALERT-03 | passed | listed | `[ ]` | WIRED | **satisfied** |
| ALERT-04 | passed | listed | `[ ]` | WIRED | **satisfied** |
| IMPEX-01 | passed | listed | `[ ]` | WIRED | **satisfied** |
| IMPEX-02 | passed | listed | `[ ]` | WIRED | **satisfied** |
| IMPEX-03 | passed | listed | `[ ]` | WIRED | **satisfied** |
| IMPEX-04 | passed | listed | `[x]` | WIRED | **satisfied** |

**Satisfied:** 22 | **Unsatisfied:** 2 (AUTH-03, AUTH-04) | **Orphaned:** 0

## Critical Gap: Middleware Inactive (AUTH-03, AUTH-04)

### Root Cause

During the Next.js 14→16 upgrade (commit `a2a9747`), `src/middleware.ts` was renamed to `src/proxy.ts` and the exported function was renamed from `middleware` to `proxy`. Next.js requires the middleware file to be named `middleware.ts` and the function to be named `middleware`.

### Consequence Chain

1. `_csrf_token` cookie is **never set** — the only setter is in `proxy.ts` which never runs
2. CSRF validation block never executes — all mutations proceed without CSRF tokens
3. `fetchWithRetry` reads empty cookie, silently skips `X-CSRF-Token` header injection
4. CSP headers are **never applied** to page responses — `buildCspHeader(nonce)` never runs
5. Nonce injected as `x-nonce` request header is always empty string
6. Auth redirect at SSR level does not happen (client-side only via `useUser()`)
7. Phase 14's fix (fetchWithRetry in useConfirmImport) is structurally correct but operationally inert

### Fix

Rename `src/proxy.ts` → `src/middleware.ts` AND rename `export async function proxy` → `export async function middleware`. The `export const config` matcher is already correctly defined.

This single fix closes both AUTH-03 and AUTH-04 simultaneously.

### What Still Works

- Non-CSP security headers (X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy) ARE applied via `next.config.mjs`
- All mutations work functionally (no CSRF enforcement = no 403 errors, but also no CSRF protection)
- Client-side auth redirect works via `useUser()` hook

## Cross-Phase Integration

### Working Flows (7/9)

| Flow | Path | Status |
|------|------|--------|
| Session Refresh (AUTH-01) | fetchWithRetry → 401 → POST /api/auth/refresh → backend → new tokens → retry | WORKING |
| Unverified Email (AUTH-02) | Backend OAuth reject → error=unverified_email → /auth/unverified-email page | WORKING |
| Error Sanitization (AUTH-05) | error-sanitizer.ts imported in all 41 guild/bonus/alert proxy routes | WORKING |
| SQL Audit (AUTH-06) | Prisma.sql parameterization in guilds.ts + bonus.ts | WORKING |
| Session Management (SESS-01-03) | Hooks → fetchWithRetry → proxy routes → backend → JTI revocation | WORKING |
| Bonus System (BONUS-01-07) | All 6 proxy routes + 8 hooks + UI; admin guard via 0x8 bit | WORKING |
| Alert & Import (ALERT-01-04, IMPEX-01-04) | All routes + sanitizeError; ManageLayout admin guard; sidebar | WORKING |

### Broken Flows (2/9)

| Flow | Broken At | Affected REQs |
|------|-----------|---------------|
| CSRF on Mutations | Cookie issuance — middleware inactive | AUTH-03 |
| CSP on Pages | Header injection — middleware inactive | AUTH-04 |

## Tech Debt Summary

| Phase | Items | Severity |
|-------|-------|----------|
| 12 | Empty-state "Create Round" button no-op; week picker always-empty existingWeekStarts | Low |
| 13 | Stale placeholder comment; import history stub (no API endpoint) | Low |
| 14 | fetchWithRetry fix operationally inert until middleware reactivated | Medium |
| All | 14 REQUIREMENTS.md checkboxes need updating | Housekeeping |

## Human Verification Items (31 total, non-blocking)

- **Phase 09:** 5 items (session refresh, expiry grace, return URL, unverified email page, middleware enforcement)
- **Phase 10:** 8 items (CSRF UX, CSP headers, script blocking, avatars, dark mode, NProgress, error messages, static assets)
- **Phase 11:** 3 items (visual appearance, multi-device logout, current session detection)
- **Phase 12:** 6 items (page layout, week picker, payment toggle, bulk modal, creation form, leaderboard)
- **Phase 13:** 7 items (admin guard, toggle behavior, drag-drop, SSE import/export, shift-click, sidebar admin)
- **Phase 14:** 2 items (import confirm 403-free flow, SSE progress display)

---

_Audited: 2026-02-22_
_Previous audit: 2026-02-22 (pre-Phase 14, identified import confirm CSRF bypass — closed by Phase 14)_
_Auditor: Claude (gsd-audit-milestone orchestrator + gsd-integration-checker)_
