---
phase: 05-configuration-mutations
plan: 04
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - src/components/forms/guild-settings-form.tsx
  - src/hooks/use-guilds.ts
  - src/app/api/guilds/[guildId]/settings/route.ts
  - src/app/(dashboard)/guilds/[guildId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit guild settings and see changes reflected immediately"
    - "Channel selection uses searchable combobox"
    - "Settings form saves via PATCH mutation"
  artifacts:
    - path: "src/components/forms/guild-settings-form.tsx"
      provides: "Guild settings edit form"
      min_lines: 80
    - path: "src/hooks/use-guilds.ts"
      provides: "useUpdateGuildSettings mutation hook"
      exports: ["useUpdateGuildSettings"]
    - path: "src/app/api/guilds/[guildId]/settings/route.ts"
      provides: "PATCH endpoint for settings"
      exports: ["PATCH"]
  key_links:
    - from: "src/components/forms/guild-settings-form.tsx"
      to: "ChannelSelect"
      via: "import and render"
      pattern: "ChannelSelect"
    - from: "src/hooks/use-guilds.ts"
      to: "/api/guilds/:guildId/settings"
      via: "fetch PATCH in useUpdateGuildSettings"
      pattern: "method:\\s*['\"]PATCH['\"]"
---

<objective>
Create the guild settings form with channel selection and update mutation.

Purpose: Implement CONF-01 (edit guild settings) and CONF-04 (channel selection). The form allows users to configure notification channels using the ChannelSelect combobox from Plan 02.

Output: GuildSettingsForm component integrated into guild detail page, with useUpdateGuildSettings mutation hook and PATCH API route.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-mutations/05-CONTEXT.md
@.planning/phases/05-configuration-mutations/05-RESEARCH.md

# Dependencies from Plan 02
@src/components/ui/channel-select.tsx
@src/hooks/use-guilds.ts

# Existing code to modify
@src/app/(dashboard)/guilds/[guildId]/page.tsx
@src/types/guild.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Settings PATCH Route and Mutation Hook</name>
  <files>
src/app/api/guilds/[guildId]/settings/route.ts
src/hooks/use-guilds.ts
  </files>
  <action>
**Create settings/route.ts:**
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { cookies } from 'next/headers'

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001'

type RouteParams = { params: Promise<{ guildId: string }> }

export async function PATCH(request: NextRequest, { params }: RouteParams) {
  const { guildId } = await params
  const cookieStore = await cookies()
  const token = cookieStore.get('auth_token')?.value

  if (!token) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const body = await request.json()

    const response = await fetch(`${API_URL}/api/v1/guilds/${guildId}/settings`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body),
    })

    const data = await response.json()
    return NextResponse.json(data, { status: response.status })
  } catch {
    return NextResponse.json({ error: 'Failed to update settings' }, { status: 500 })
  }
}
```

**Add useUpdateGuildSettings to use-guilds.ts:**

First add the request type near the top with other types:
```typescript
interface UpdateSettingsRequest {
  logs_channel_id?: string | null
  watch_category_id?: string | null
  pause_category_id?: string | null
  updates_channel_id?: string | null
  updates_role_id?: string | null
  allowed_platforms?: string[]
}
```

Then add the hook:
```typescript
export function useUpdateGuildSettings(guildId: string) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (settings: UpdateSettingsRequest) => {
      const response = await fetch(`/api/guilds/${guildId}/settings`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings),
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.message || 'Failed to update settings')
      }

      return response.json()
    },
    onSuccess: () => {
      // Invalidate guild details to refetch fresh settings
      queryClient.invalidateQueries({ queryKey: ['guild', guildId] })
    },
  })
}
```

Add useMutation to imports from @tanstack/react-query.
  </action>
  <verify>
Files exist. TypeScript compilation passes: `npx tsc --noEmit`.
  </verify>
  <done>
PATCH /api/guilds/:guildId/settings route and useUpdateGuildSettings mutation hook created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GuildSettingsForm Component</name>
  <files>src/components/forms/guild-settings-form.tsx</files>
  <action>
Create the settings form component that uses inline editing per RESEARCH.md Pattern 4.

**Props:**
```typescript
interface GuildSettingsFormProps {
  guildId: string
  settings: GuildSettings  // Current settings from useGuild
}
```

**Implementation:**
'use client' component with:

1. Fetch channels using useGuildChannels(guildId)
2. Use useUpdateGuildSettings(guildId) mutation
3. Local state for edited values (only when actively editing a field)

**Form fields (based on GuildSettings type):**
- Logs Channel: ChannelSelect for logs_channel_id
- Updates Channel: ChannelSelect for updates_channel_id
- Watch Category: ChannelSelect for watch_category_id (categories are type 4)
- Pause Category: ChannelSelect for pause_category_id

Note: ChannelSelect filters to text channels (type 0), but categories are type 4. Either:
- Pass a filter prop to ChannelSelect, OR
- For MVP, only show channel fields (logs, updates) and defer category selection

**Chosen approach for MVP:** Only show logs_channel_id and updates_channel_id (both are text channels). Category settings are less commonly changed and can be added later.

**Layout:**
```tsx
<div className="bg-surface border border-border rounded-lg p-6 space-y-6">
  <h2 className="text-lg font-semibold text-white">Guild Settings</h2>

  {/* Logs Channel */}
  <div>
    <label className="block text-sm font-medium text-gray-400 mb-2">
      Logs Channel
    </label>
    <ChannelSelect
      channels={channels?.channels ?? []}
      value={settings.logs_channel_id}
      onChange={(channelId) => updateSetting('logs_channel_id', channelId)}
      placeholder="Select a channel for logs..."
    />
    <p className="text-xs text-gray-500 mt-1">Channel where bot activity logs are sent</p>
  </div>

  {/* Updates Channel */}
  <div>
    <label className="block text-sm font-medium text-gray-400 mb-2">
      Updates Channel
    </label>
    <ChannelSelect
      channels={channels?.channels ?? []}
      value={settings.updates_channel_id}
      onChange={(channelId) => updateSetting('updates_channel_id', channelId)}
      placeholder="Select a channel for updates..."
    />
    <p className="text-xs text-gray-500 mt-1">Channel where post notifications are sent</p>
  </div>

  {/* Status indicator */}
  {mutation.isPending && (
    <p className="text-sm text-gray-400">Saving...</p>
  )}
  {mutation.isError && (
    <p className="text-sm text-red-400">Failed to save: {mutation.error.message}</p>
  )}
  {mutation.isSuccess && (
    <p className="text-sm text-green-400">Settings saved</p>
  )}
</div>
```

**Auto-save pattern:**
When channel selection changes, immediately call mutation.mutate({ field: value }).
Use debounce if needed, but for dropdown selection, immediate save is fine.

```typescript
const updateSetting = (key: keyof GuildSettings, value: unknown) => {
  mutation.mutate({ [key]: value })
}
```
  </action>
  <verify>
File exists at src/components/forms/guild-settings-form.tsx. TypeScript compilation passes: `npx tsc --noEmit`. Directory src/components/forms/ exists.
  </verify>
  <done>
GuildSettingsForm component with channel selection dropdowns and auto-save mutation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Settings Form into Guild Page</name>
  <files>src/app/(dashboard)/guilds/[guildId]/page.tsx</files>
  <action>
Add the GuildSettingsForm to the guild detail page.

**Import:**
```typescript
import { GuildSettingsForm } from '@/components/forms/guild-settings-form'
```

**Add section below the stats grid and above quick access cards:**
```tsx
{/* Settings Section */}
{guild.settings && (
  <GuildSettingsForm guildId={guildId} settings={guild.settings} />
)}
```

Place this after the stats grid (StatCard section) and before the Quick Access Cards section.

The order should be:
1. Header with guild name and bot status
2. GuildTabs
3. Stats Grid
4. **GuildSettingsForm (new)**
5. Quick Access Cards
6. Brands Preview
  </action>
  <verify>
File updated. TypeScript compilation passes: `npx tsc --noEmit`. GuildSettingsForm is rendered in the page.
  </verify>
  <done>
Guild detail page displays GuildSettingsForm with channel selection.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. PATCH /api/guilds/:guildId/settings route exists
3. useUpdateGuildSettings hook is importable
4. Guild detail page shows settings form with channel dropdowns
5. Selecting a channel triggers save mutation
</verification>

<success_criteria>
- PATCH /api/guilds/:guildId/settings proxy route exists
- useUpdateGuildSettings mutation hook exists with cache invalidation
- GuildSettingsForm component renders channel selection dropdowns
- Settings form integrated into guild detail page
- Changes save immediately and invalidate guild query cache
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-mutations/05-04-SUMMARY.md`
</output>
