---
phase: 09-authentication-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds.ts
  - ~/Desktop/Tracking Data Bot/api/src/routes/dashboard/bonus.ts
autonomous: true

must_haves:
  truths:
    - "All raw SQL queries in dashboard routes use Prisma.sql tagged template literals (parameterized)"
    - "No string concatenation or interpolation constructs raw SQL from user input"
    - "Sort direction and column selection use Prisma.sql constants, not string interpolation"
  artifacts:
    - path: "~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds.ts"
      provides: "Audited raw SQL queries using Prisma.sql template tags"
      contains: "Prisma.sql"
    - path: "~/Desktop/Tracking Data Bot/api/src/routes/dashboard/bonus.ts"
      provides: "Audited raw SQL queries using Prisma.sql template tags"
      contains: "Prisma.sql"
  key_links:
    - from: "guilds.ts raw queries"
      to: "Prisma parameterized queries"
      via: "tagged template literal substitution"
      pattern: "\\$queryRaw.*Prisma\\.sql"
---

<objective>
Audit all raw SQL queries in dashboard-related backend routes for SQL injection vulnerabilities. Verify that all queries use parameterized Prisma.sql template tags and no user input flows into raw SQL via string concatenation.

Purpose: AUTH-06 requires that all dashboard-related backend routes using raw SQL are audited and converted to parameterized queries. This eliminates SQL injection attack vectors.
Output: Audit results documented. Any unsafe patterns fixed. All raw SQL confirmed to use Prisma.sql parameterization.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds.ts
@~/Desktop/Tracking Data Bot/api/src/routes/dashboard/bonus.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and harden raw SQL in guilds.ts</name>
  <files>
    ~/Desktop/Tracking Data Bot/api/src/routes/dashboard/guilds.ts
  </files>
  <action>
    Perform a comprehensive SQL injection audit of all raw SQL queries in `guilds.ts`. There are 7 raw query locations:

    **Posts query (lines ~751-803):** Uses `Prisma.sql` tagged template with `${guildAccess.clientId}`, `${filters.platform}`, `${filters.status}`, `${filters.brand_id}`, `${fromDate}`, `${toDate}`, `${limit}`, `${skip}`. All values are interpolated via Prisma.sql template tag = parameterized. Sort column uses `Prisma.sql\`COALESCE(vm."viewCount", -1)\`` constant fragments. Sort direction uses `Prisma.sql\`ASC\`` / `Prisma.sql\`DESC\`` constant fragments. SAFE.

    **Posts count query (line ~805):** Same pattern, uses `Prisma.sql` with parameterized values. SAFE.

    **Daily posts time series (line ~1595):** Tagged template literal with `${guildAccess.clientId}` and `${startDate}`. SAFE.

    **Weekly posts time series (line ~1612):** Tagged template literal with `${guildAccess.clientId}` and `${startDate}`. SAFE.

    **Views time series (line ~1630):** Tagged template literal with `${guildAccess.clientId}` and `${startDate}`. SAFE.

    **Leaderboard query (line ~1711):** Tagged template literal with `${startDate}`, `${previousStartDate}`, `${previousEndDate}`, `${guildAccess.clientId}`, `${limit}`. SAFE.

    **Top accounts query (line ~1821):** Tagged template literal with `${startDate}`, `${guildAccess.clientId}`, `${limit}`. SAFE.

    HOWEVER, there is a subtle concern in the posts query: the `metricsColumn` and `sortDirection` variables are constructed from `Prisma.sql` fragments based on validated `sort_by` and `sort_order` values. Verify that these are NOT derived from raw user input string concatenation:
    - `sort_by` comes from a Zod-validated enum or schema — verify it's validated before use
    - `sort_order` should be validated to only allow 'asc' or 'desc'

    Actions:
    1. Grep the file for the validation schema that validates `sort_by` and `sort_order` query parameters.
    2. If `sort_by` and `sort_order` are NOT validated via Zod or similar before the raw query, add validation to restrict `sort_by` to `['views', 'likes']` (since the raw query path only activates for these) and `sort_order` to `['asc', 'desc']`.
    3. If all queries are already safe (they should be based on analysis), add a comment block at the top of the raw SQL section: `// AUTH-06 AUDIT: All raw SQL queries below use Prisma.sql template tags for parameterization. Sort direction and column selection use Prisma.sql constant fragments. Audited [date].`
    4. Search for any other patterns in the file that might construct SQL: string concatenation with `+`, template literals without `Prisma.sql`, `String()` or `.toString()` in SQL context.
  </action>
  <verify>
    Run: `grep -n 'queryRaw\|executeRaw\|Prisma\.sql\|Prisma\.raw' ~/Desktop/Tracking\ Data\ Bot/api/src/routes/dashboard/guilds.ts` to list all raw SQL usage.
    Run TypeScript check: `npx tsc --noEmit -p "/Users/gabrielleal/Desktop/Tracking Data Bot/api/tsconfig.json"`
    Confirm no string concatenation used to build SQL.
  </verify>
  <done>
    All 7 raw SQL query locations in guilds.ts confirmed to use Prisma.sql parameterized template tags. Sort column and direction use Prisma.sql constant fragments derived from validated input. Audit comment added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit and harden raw SQL in bonus.ts and remaining dashboard routes</name>
  <files>
    ~/Desktop/Tracking Data Bot/api/src/routes/dashboard/bonus.ts
  </files>
  <action>
    Audit all raw SQL in `bonus.ts` and scan remaining dashboard route files for raw SQL:

    **bonus.ts leaderboard query (line ~901):** Uses `prisma.$queryRaw` with tagged template literal. Variables `${guildId}`, `${weeksAgo}` are interpolated via Prisma template tag = parameterized. `guildId` comes from `guildAccess.id` (JWT-derived, not user input). SAFE.

    Actions:
    1. Verify the `weeks` parameter in bonus.ts is validated via Zod schema before use in the query.
    2. Add audit comment: `// AUTH-06 AUDIT: Raw SQL uses Prisma tagged template literal for parameterization. Audited [date].`
    3. Scan ALL other dashboard route files for raw SQL:
       - `~/Desktop/Tracking Data Bot/api/src/routes/dashboard/exports.ts`
       - `~/Desktop/Tracking Data Bot/api/src/routes/dashboard/bulk.ts`
       - `~/Desktop/Tracking Data Bot/api/src/routes/dashboard/trash.ts`
       - `~/Desktop/Tracking Data Bot/api/src/routes/dashboard/accounts/export.ts`
       - `~/Desktop/Tracking Data Bot/api/src/routes/dashboard/accounts/import.ts`
       - `~/Desktop/Tracking Data Bot/api/src/routes/dashboard/auth.ts`
       Run: `grep -rn '$queryRaw\|$executeRaw\|Prisma.raw\|\.query(' ~/Desktop/Tracking\ Data\ Bot/api/src/routes/dashboard/`
    4. For any raw SQL found in other files, verify they use Prisma.sql parameterization.
    5. If any file has no raw SQL, note it as clean.
  </action>
  <verify>
    Run: `grep -rn 'queryRaw\|executeRaw\|Prisma\.raw\|\.query(' ~/Desktop/Tracking\ Data\ Bot/api/src/routes/dashboard/` to find all raw SQL in dashboard routes.
    Run TypeScript check: `npx tsc --noEmit -p "/Users/gabrielleal/Desktop/Tracking Data Bot/api/tsconfig.json"`
    Confirm audit results: all raw SQL uses parameterized queries.
  </verify>
  <done>
    All raw SQL in bonus.ts uses Prisma tagged template literals. All dashboard route files scanned. Audit comments added. No SQL injection vulnerabilities found — all queries use Prisma.sql parameterization.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p "/Users/gabrielleal/Desktop/Tracking Data Bot/api/tsconfig.json"`
2. All raw SQL in guilds.ts (7 queries) uses Prisma.sql template tags
3. All raw SQL in bonus.ts (1 query) uses Prisma.sql template tags
4. All other dashboard route files scanned for raw SQL
5. Audit comments added to document the review
6. No string concatenation in SQL query construction
</verification>

<success_criteria>
- All dashboard-related backend routes using raw SQL have been audited
- All raw SQL queries confirmed to use parameterized Prisma.sql template tags
- Audit comments added to document the security review
- No SQL injection vulnerabilities exist in dashboard routes
</success_criteria>

<output>
After completion, create `.planning/phases/09-authentication-security/09-02-SUMMARY.md`
</output>
