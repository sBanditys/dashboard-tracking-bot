---
phase: 11-session-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/session.ts
  - src/app/api/auth/sessions/route.ts
  - src/app/api/auth/sessions/[sessionId]/route.ts
  - src/app/api/auth/logout-all/route.ts
  - src/hooks/use-sessions.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard can fetch active sessions from backend with parsed device info"
    - "Dashboard can revoke a specific session via proxy to backend"
    - "Dashboard can logout all devices via proxy to backend"
    - "Session data includes parsed device type, browser, OS, and masked IP"
  artifacts:
    - path: "src/types/session.ts"
      provides: "Session and parsed session type definitions"
      contains: "ParsedSession"
    - path: "src/app/api/auth/sessions/route.ts"
      provides: "GET proxy route for sessions list with server-side UA parsing"
      exports: ["GET"]
    - path: "src/app/api/auth/sessions/[sessionId]/route.ts"
      provides: "DELETE proxy route for single session revocation"
      exports: ["DELETE"]
    - path: "src/app/api/auth/logout-all/route.ts"
      provides: "POST proxy route for logout all devices"
      exports: ["POST"]
    - path: "src/hooks/use-sessions.ts"
      provides: "React Query hooks for session operations"
      contains: "useSessions"
  key_links:
    - from: "src/app/api/auth/sessions/route.ts"
      to: "backend /api/v1/auth/sessions"
      via: "backendFetch with auth_token cookie forwarded as Bearer token"
      pattern: "backendFetch.*api/v1/auth/sessions"
    - from: "src/hooks/use-sessions.ts"
      to: "src/app/api/auth/sessions/route.ts"
      via: "fetchWithRetry in query/mutation functions"
      pattern: "fetchWithRetry.*api/auth/sessions"
---

<objective>
Install dependencies, create session types, build API proxy routes for all three backend session endpoints (list, revoke, logout-all) with server-side user-agent parsing, and create React Query hooks for frontend consumption.

Purpose: Establish the complete data layer for session management so the UI layer (Plan 02) can consume parsed session data and trigger revocation actions.
Output: Session types, 3 API proxy routes, 1 hooks file with 3 exported hooks.
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-session-management/11-RESEARCH.md

# Key reference files for existing patterns:
@src/app/api/auth/logout/route.ts
@src/app/api/auth/refresh/route.ts
@src/lib/server/backend-fetch.ts
@src/lib/fetch-with-retry.ts
@src/hooks/use-user.ts
@src/types/user.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create session types, and build 3 API proxy routes</name>
  <files>
    package.json
    src/types/session.ts
    src/app/api/auth/sessions/route.ts
    src/app/api/auth/sessions/[sessionId]/route.ts
    src/app/api/auth/logout-all/route.ts
  </files>
  <action>
    **Step 1: Install dependencies**
    Run `npm install ua-parser-js lucide-react && npm install --save-dev @types/ua-parser-js` in the dashboard project root.

    **Step 2: Create session types at `src/types/session.ts`**
    Define these interfaces:
    - `BackendSession` — raw backend response shape: `{ id: string; user_agent: string | null; ip_address: string | null; created_at: string; expires_at: string }`
    - `DeviceType` — union type: `'desktop' | 'mobile' | 'tablet' | 'unknown'`
    - `ParsedSession` — enriched session for frontend consumption:
      ```
      {
        id: string;
        device: { type: DeviceType; name: string };
        browser: { name: string; version: string };
        os: { name: string; version: string };
        ipAddress: string;
        createdAt: string;
        expiresAt: string;
        isCurrent: boolean;
      }
      ```
    - `SessionsResponse` — `{ sessions: ParsedSession[] }`

    **Step 3: Create GET /api/auth/sessions route at `src/app/api/auth/sessions/route.ts`**
    Follow the pattern from `src/app/api/auth/logout/route.ts` and `src/app/api/auth/refresh/route.ts`:
    - Import `backendFetch` from `@/lib/server/backend-fetch`, `NextResponse` from `next/server`, `cookies` and `headers` from `next/headers`
    - Import `UAParser` from `ua-parser-js`
    - Import `BackendSession`, `ParsedSession`, `DeviceType` from `@/types/session`
    - Read `auth_token` from cookies; return 401 if missing
    - Fetch `${API_URL}/api/v1/auth/sessions` with `Authorization: Bearer ${authToken}` header
    - If not ok, return error response with upstream status
    - Parse the JSON response containing `sessions: BackendSession[]`
    - For each session, use `UAParser` to parse `user_agent`:
      - Determine `deviceType`: if `device.type === 'mobile'` -> mobile, `'tablet'` -> tablet, else -> desktop. Fallback to 'unknown' only if no user agent at all.
      - Determine `deviceName`: "Mobile", "Tablet", "Desktop", or "Unknown Device"
      - Extract browser name/version and OS name/version with "Unknown" fallbacks
    - Detect current session: Read the request's `user-agent` header via `await headers()`, compare with each session's raw user_agent. Also read the request's IP from `x-forwarded-for` header. Mark session as `isCurrent: true` if both user-agent and IP prefix (first 2 octets for IPv4, first 4 groups for IPv6) match. If no match found, mark the most recent session (first in list, since backend orders by `createdAt desc`) as current.
    - Return `NextResponse.json({ sessions: parsedSessions })`

    **Step 4: Create DELETE /api/auth/sessions/[sessionId] route at `src/app/api/auth/sessions/[sessionId]/route.ts`**
    - Export async function `DELETE(request: Request, { params }: { params: Promise<{ sessionId: string }> })`
    - Read `auth_token` from cookies; return 401 if missing
    - Await params to get sessionId (Next.js 16 pattern)
    - Fetch `${API_URL}/api/v1/auth/sessions/${sessionId}` with DELETE method and Bearer auth
    - Forward the upstream response status and body
    - If upstream is not ok, return error with upstream status

    **Step 5: Create POST /api/auth/logout-all route at `src/app/api/auth/logout-all/route.ts`**
    - Export async function `POST()`
    - Read `auth_token` from cookies; return 401 if missing
    - Fetch `${API_URL}/api/v1/auth/logout-all` with POST method and Bearer auth
    - On success, delete `auth_token` and `refresh_token` cookies (same pattern as logout route)
    - Return the upstream response JSON

    **Important patterns to follow:**
    - Use `const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000'` at top of each route
    - Use `backendFetch` (not plain `fetch`) for all backend calls to include internal secret header
    - Wrap everything in try/catch, return 500 on unexpected errors
    - All routes use `await cookies()` (Next.js 16 async cookies API)
  </action>
  <verify>
    Run `npx tsc --noEmit` from the dashboard project root. There should be no TypeScript errors in the new files.
    Verify the new files exist: `ls src/types/session.ts src/app/api/auth/sessions/route.ts src/app/api/auth/sessions/\[sessionId\]/route.ts src/app/api/auth/logout-all/route.ts`
    Verify ua-parser-js and lucide-react are in package.json dependencies.
  </verify>
  <done>
    Three API proxy routes exist and compile without errors. Session types are defined. ua-parser-js and lucide-react are installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create use-sessions React Query hooks</name>
  <files>
    src/hooks/use-sessions.ts
  </files>
  <action>
    Create `src/hooks/use-sessions.ts` following the pattern from `src/hooks/use-user.ts`:

    **Imports:**
    - `useQuery`, `useMutation`, `useQueryClient` from `@tanstack/react-query`
    - `fetchWithRetry` from `@/lib/fetch-with-retry`
    - `ParsedSession` from `@/types/session`
    - `toast` from `sonner`

    **Hook 1: `useSessions()`**
    - Returns `useQuery<ParsedSession[]>` with:
      - `queryKey: ['sessions']`
      - `queryFn`: fetches `/api/auth/sessions` via `fetchWithRetry`, throws on non-ok, returns `data.sessions`
      - `staleTime: 30 * 1000` (30 seconds — sessions change infrequently but need reasonable freshness)
      - `refetchInterval: 60 * 1000` (refetch every 60 seconds for background updates)
    - Return `{ sessions: query.data, isLoading: query.isLoading, error: query.error }`

    **Hook 2: `useRevokeSession()`**
    - Returns `useMutation` with:
      - `mutationFn`: accepts `sessionId: string`, calls `fetchWithRetry(\`/api/auth/sessions/${sessionId}\`, { method: 'DELETE' })`, throws on non-ok
      - `onSuccess`: invalidate `['sessions']` query key via `queryClient.invalidateQueries`
      - `onError`: show `toast.error('Failed to revoke session')`

    **Hook 3: `useLogoutAll()`**
    - Returns `useMutation` with:
      - `mutationFn`: calls `fetchWithRetry('/api/auth/logout-all', { method: 'POST' })`, throws on non-ok
      - `onSuccess`: clear all React Query cache via `queryClient.removeQueries()`, then redirect to `/login` using `window.location.href = '/login'` (same pattern as `useLogout` in `use-user.ts` — full page redirect to clear state)
      - `onError`: show `toast.error('Failed to logout from all devices')`

    **JSDoc comments** on each hook explaining purpose.
  </action>
  <verify>
    Run `npx tsc --noEmit` from the dashboard project root. No TypeScript errors.
    Verify the file exports all three hooks: `grep -c "export function" src/hooks/use-sessions.ts` should output 3.
  </verify>
  <done>
    Three React Query hooks (useSessions, useRevokeSession, useLogoutAll) are exported from use-sessions.ts and compile without errors. Hooks follow existing codebase patterns (fetchWithRetry, toast notifications, query invalidation).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in new files
2. `npm ls ua-parser-js lucide-react` confirms both packages installed
3. All 5 new source files exist and have correct exports
4. API routes follow established patterns (backendFetch, cookies, error handling)
5. Hooks use fetchWithRetry, React Query, and toast notification patterns
</verification>

<success_criteria>
- Session types defined with ParsedSession interface including device/browser/OS fields and isCurrent flag
- GET /api/auth/sessions proxy route parses user-agents server-side via ua-parser-js and detects current session
- DELETE /api/auth/sessions/[sessionId] proxy route forwards revocation to backend
- POST /api/auth/logout-all proxy route revokes all sessions and clears cookies
- useSessions hook fetches and caches session data with 30s staleTime
- useRevokeSession hook deletes a session and invalidates the sessions cache
- useLogoutAll hook triggers logout-all, clears React Query cache, and redirects to /login
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-management/11-01-SUMMARY.md`
</output>
