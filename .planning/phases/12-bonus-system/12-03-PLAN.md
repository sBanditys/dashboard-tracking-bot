---
phase: 12-bonus-system
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/bonus/create-round-modal.tsx
  - src/components/bonus/week-picker.tsx
autonomous: true
requirements:
  - BONUS-03

must_haves:
  truths:
    - "Admin can open a creation form from the bonus page"
    - "Admin can select a week using a calendar picker that disables already-used weeks"
    - "Admin can select account groups with Select All and set target views with bulk default + per-group override"
    - "Admin sees a review summary before confirming creation"
    - "Past week selection triggers a retroactive warning confirmation dialog"
    - "Dollar amount input converts to cents for the API"
  artifacts:
    - path: "src/components/bonus/create-round-modal.tsx"
      provides: "Multi-step round creation form"
      contains: "CreateRoundModal"
    - path: "src/components/bonus/week-picker.tsx"
      provides: "Week selection calendar component"
      contains: "WeekPicker"
  key_links:
    - from: "src/components/bonus/create-round-modal.tsx"
      to: "src/hooks/use-bonus.ts"
      via: "useCreateBonusRound mutation"
      pattern: "useCreateBonusRound"
    - from: "src/components/bonus/week-picker.tsx"
      to: "react-day-picker"
      via: "DayPicker with week selection modifiers"
      pattern: "DayPicker"
---

<objective>
Build the bonus round creation form as a multi-step modal with week picker, account group selection, target views configuration, and review/confirmation steps.

Purpose: Admins need to create bonus rounds — this is the primary write operation in the bonus system. The form has enough complexity (week picker with disabled weeks, group checklist with bulk/override targets, retroactive warning) to warrant its own plan.

Output: `src/components/bonus/create-round-modal.tsx`, `src/components/bonus/week-picker.tsx`
</objective>

<execution_context>
@/Users/gabrielleal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gabrielleal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-bonus-system/12-RESEARCH.md
@.planning/phases/12-bonus-system/12-01-SUMMARY.md

# Types and hooks from Plan 01
@src/types/bonus.ts
@src/hooks/use-bonus.ts

# Existing modal patterns
@src/components/ui/confirmation-modal.tsx
@src/components/alerts/threshold-create-modal.tsx

# Account groups data — need to know how to fetch available groups
@src/hooks/use-tracking.ts
@src/types/tracking.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create week picker component with disabled weeks and retroactive detection</name>
  <files>
    src/components/bonus/week-picker.tsx
  </files>
  <action>
**Create `src/components/bonus/week-picker.tsx`:**
- Props: `{ selectedWeek: DateRange | undefined, onSelect: (week: DateRange) => void, existingWeekStarts: string[], onRetroactiveDetected: (isRetroactive: boolean) => void }`
- Uses `react-day-picker` v9 `DayPicker` component with custom week-selection behavior (see 12-RESEARCH.md Pattern 5)
- Import `startOfWeek`, `endOfWeek`, `isAfter`, `format` from `date-fns`
- Import `DayPicker`, `rangeIncludesDate`, type `DateRange` from `react-day-picker`

**IMPORTANT:** Before implementing, check 12-01-SUMMARY.md for the week start day finding. Use `{ weekStartsOn: 1 }` if backend uses Monday, or `{ weekStartsOn: 0 }` if Sunday. Pass this option to ALL date-fns `startOfWeek`/`endOfWeek` calls consistently (Pitfall 1 from research).

**Week picker behavior:**
- Renders inside a popover: button showing selected week range (e.g., "Feb 17 - Feb 23, 2026") or "Select a week" placeholder. Clicking button toggles an absolutely-positioned dropdown with the DayPicker.
- Use `@headlessui/react` `Popover` + `PopoverButton` + `PopoverPanel` for the dropdown (accessible, handles click-outside close).
- `showWeekNumber` prop on DayPicker to help users identify weeks
- Custom `modifiers` for week selection highlighting:
  - `selected`: the full selectedWeek range
  - `range_start`: selectedWeek.from
  - `range_end`: selectedWeek.to
  - `range_middle`: dates within the selected range (use `rangeIncludesDate`)
- **Disabled dates:**
  - Future weeks: `{ after: endOfWeek(new Date(), weekStartsOnOption) }` — allow current week but not future
  - Existing round weeks: map `existingWeekStarts` strings to DateRange objects: `existingWeekStarts.map(ws => ({ from: new Date(ws), to: endOfWeek(new Date(ws), weekStartsOnOption) }))`
- **onDayClick handler:** calculate week range from clicked day, check if week end is before now (retroactive detection), call `onRetroactiveDetected` and `onSelect`
- Default selection: current week (calculate `startOfWeek(new Date())` to `endOfWeek(new Date())`)
- Style the DayPicker with project theme: dark background, muted borders, accent-purple for selected range
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify file exists: `ls src/components/bonus/week-picker.tsx`. Check it imports DayPicker: `grep 'DayPicker' src/components/bonus/week-picker.tsx`.
  </verify>
  <done>Week picker renders a calendar in a popover, highlights entire selected week, disables future and already-used weeks, detects retroactive week selection, uses correct week start day matching backend.</done>
</task>

<task type="auto">
  <name>Task 2: Create multi-step round creation modal with review and confirmation</name>
  <files>
    src/components/bonus/create-round-modal.tsx
  </files>
  <action>
**Create `src/components/bonus/create-round-modal.tsx`:**
- Props: `{ open: boolean, onClose: () => void, guildId: string, existingWeekStarts: string[] }`
- Uses `@headlessui/react` `Dialog`/`DialogPanel`/`DialogTitle` for the modal (matching project pattern from confirmation-modal.tsx)
- Max width: `max-w-2xl` to accommodate group checklist

**Multi-step form (4 steps managed by local useState<number> step counter):**

**Step 1: Week Selection**
- Render `<WeekPicker>` component
- Display selected week range prominently
- Track `isRetroactive` state from WeekPicker callback
- "Next" button to proceed (disabled until week selected)

**Step 2: Account Group Selection**
- Fetch available account groups — check how existing hooks fetch groups (look at `useTracking` or similar hook in use-tracking.ts). Groups should come from guild data. If no existing hook provides groups, fetch from `/api/guilds/${guildId}/groups` or similar.
- Full checklist with "Select All" toggle at top
- Each group row: checkbox + group label (include brand prefix for clarity — Claude's discretion)
- Track selected group IDs in `useState<Set<string>>`
- "Next" button (disabled if no groups selected)
- "Back" button to return to Step 1

**Step 3: Target Views & Bonus Amount**
- **Bonus amount input:** dollar input with `$` prefix, `type="number"`, `step="0.01"`, `min="0.01"`. Label: "Bonus Amount per Group". Validate positive number on change.
- **Bulk default target views:** single number input labeled "Default Target Views for All Groups". When changed, updates all individual targets that haven't been manually overridden.
- **Per-group override table:** list of selected groups, each with its own target views input. Initially all set to the bulk default. When user manually edits one, it becomes "overridden" (tracked in a Set). Overridden inputs show a small "custom" badge and a reset button to return to default.
- "Next" button (disabled if amount is invalid or any target is 0/empty)
- "Back" button to Step 2

**Step 4: Review Summary**
- Display: selected week range, bonus amount in dollars, number of target groups, list of groups with their target views
- If retroactive: show amber warning banner "This week has already ended. The round will be evaluated immediately."
- "Create Round" primary button + "Back" button
- On "Create Round" click:
  - If retroactive: show ADDITIONAL confirmation dialog (not just the banner) — use window.confirm() or a nested Dialog. Message: "This week has ended. The round will be evaluated immediately. Continue?"
  - Build `CreateBonusRoundRequest`: convert dollar amount to cents via `Math.round(parseFloat(amount) * 100)`, map groups to targets array with `{ account_group_id, target_views }`
  - Call `useCreateBonusRound(guildId).mutate(request)`
  - On success: close modal, reset form state
  - Show loading spinner on button during mutation

**Form reset:** When modal closes or on successful creation, reset all state (step, week, groups, targets, amount) back to defaults.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify file exists: `ls src/components/bonus/create-round-modal.tsx`. Check it uses the creation hook: `grep 'useCreateBonusRound' src/components/bonus/create-round-modal.tsx`.
  </verify>
  <done>Create round modal walks through 4 steps (week picker, group selection, target views with bulk default + per-group override, review summary). Retroactive weeks trigger extra confirmation. Dollar-to-cents conversion happens at submission. Form resets on close/success.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. WeekPicker renders calendar with week-level selection and disabled dates
3. CreateRoundModal shows 4-step form with back/next navigation
4. Group checklist has Select All functionality
5. Target views support bulk default with per-group override
6. Dollar amount validates and converts to cents correctly
7. Retroactive week shows warning banner in review + extra confirmation dialog
8. Successful creation closes modal and refreshes rounds list
</verification>

<success_criteria>
Admin can create a bonus round through the complete multi-step wizard: select week (with disabled existing weeks), choose account groups, set target views and bonus amount, review and confirm. Retroactive rounds get additional warning. The creation triggers a backend POST and refreshes the rounds list.
</success_criteria>

<output>
After completion, create `.planning/phases/12-bonus-system/12-03-SUMMARY.md`
</output>
